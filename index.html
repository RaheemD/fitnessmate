<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>FitnessMate â€¢ Auth</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = { darkMode: 'class' };
    (function() {
      const isDark = localStorage.getItem('fitmate-dark-mode') === 'true';
      if (isDark) document.documentElement.classList.add('dark');
    })();
  </script>
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
</head>
<body class="bg-gray-50 dark:bg-gray-900 min-h-screen flex items-center justify-center p-4">
  <div class="w-full max-w-md">
    <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-xl p-6">
      <div class="flex items-center gap-3 mb-4">
        <div class="text-2xl">ðŸ’ª</div>
        <h1 class="text-xl font-bold text-gray-800 dark:text-gray-200">FitnessMate Account</h1>
      </div>

      <div id="status" class="text-sm text-gray-600 dark:text-gray-300 mb-4">Checking your linkâ€¦</div>

      <div id="resetBox" class="hidden">
        <h2 class="text-lg font-semibold text-gray-800 dark:text-gray-200 mb-2">Reset Password</h2>
        <p class="text-sm text-gray-600 dark:text-gray-300 mb-4">Enter a new password for your account.</p>
        <div class="space-y-2">
          <input id="pw1" type="password" placeholder="New password" class="w-full p-2 rounded-lg border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-gray-100" />
          <input id="pw2" type="password" placeholder="Confirm password" class="w-full p-2 rounded-lg border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-gray-100" />
        </div>
        <p id="err" class="text-sm text-red-500 mt-2 hidden"></p>
        <button id="doReset" class="w-full mt-4 bg-pink-500 hover:bg-pink-600 text-white font-medium py-2.5 rounded-lg">Update Password</button>
      </div>

      <div id="doneBox" class="hidden">
        <h2 class="text-lg font-semibold text-gray-800 dark:text-gray-200 mb-2">All set!</h2>
        <p id="doneMsg" class="text-sm text-gray-600 dark:text-gray-300 mb-4"></p>
        <a href="/" class="block w-full text-center bg-pink-500 hover:bg-pink-600 text-white font-medium py-2.5 rounded-lg">Open FitnessMate</a>
      </div>

      <div id="errorBox" class="hidden">
        <h2 class="text-lg font-semibold text-red-600 dark:text-red-400 mb-2">Link issue</h2>
        <p id="errorMsg" class="text-sm text-gray-600 dark:text-gray-300 mb-4">This link is invalid or expired. Please request a new email.</p>
        <a href="/" class="block w-full text-center bg-gray-200 dark:bg-gray-700 dark:text-gray-100 text-gray-800 font-medium py-2.5 rounded-lg">Return to app</a>
      </div>
    </div>
  </div>

  <script>
    (function() {
      const supabaseUrl = 'https://bhtabgrcxaahkuwrdwec.supabase.co';
      const supabaseAnon = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJodGFiZ3JjeGFhaGt1d3Jkd2VjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgzNzc1MjMsImV4cCI6MjA3Mzk1MzUyM30._Cydy4B6QMF353OG8jnhK7juWgz2j4RirATIfCgAflQ';
      const { createClient } = window.supabase;
      const supabase = createClient(supabaseUrl, supabaseAnon);

      const qs = new URLSearchParams(window.location.search);
      const code = qs.get('code');
      const type = qs.get('type'); // 'recovery' | 'signup' | 'magiclink' | 'invite'

      const $ = (id) => document.getElementById(id);
      const show = (id) => $(id).classList.remove('hidden');
      const hide = (id) => $(id).classList.add('hidden');

      async function run() {
        try {
          if (!code) {
            $('status').textContent = 'No code found in URL.';
            hide('status'); show('errorBox');
            return;
          }

          $('status').textContent = 'Verifyingâ€¦';
          const { error } = await supabase.auth.exchangeCodeForSession({ code });
          if (error) {
            hide('status'); show('errorBox');
            $('errorMsg').textContent = error.message || 'Verification failed.';
            return;
          }

          // Clear query to avoid repeat on refresh
          window.history.replaceState({}, document.title, window.location.pathname);

          if (type === 'recovery') {
            hide('status'); show('resetBox');
          } else {
            hide('status'); show('doneBox');
            $('doneMsg').textContent = 'Your email was confirmed. You are signed in.';
          }
        } catch (e) {
          hide('status'); show('errorBox');
          $('errorMsg').textContent = e.message || 'Unexpected error.';
        }
      }

      $('doReset').addEventListener('click', async () => {
        const p1 = $('pw1').value.trim();
        const p2 = $('pw2').value.trim();
        $('err').classList.add('hidden'); $('err').textContent='';
        if (p1.length < 8) { $('err').textContent = 'Use at least 8 characters.'; $('err').classList.remove('hidden'); return; }
        if (p1 !== p2) { $('err').textContent = 'Passwords do not match.'; $('err').classList.remove('hidden'); return; }
        try {
          const { error } = await supabase.auth.updateUser({ password: p1 });
          if (error) throw error;
          hide('resetBox'); show('doneBox');
          $('doneMsg').textContent = 'Password updated. You are signed in.';
        } catch (e) {
          $('err').textContent = e.message || 'Failed to update password.';
          $('err').classList.remove('hidden');
        }
      });

      run();
    })();
  </script>
</body>
</html>
