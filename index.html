<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>FitnessMate</title>
  <link rel="icon" type="image/x-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üí™</text></svg>">
  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
    }
  </script>
</head>
<body class="bg-gray-50 dark:bg-gray-900">
  <div id="root"></div>

  <!-- React + ReactDOM + Babel (for JSX in-browser) -->
  <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <script type="text/babel">
    const { useState, useRef, useEffect } = React;

    // --- Centralized API Configuration ---
    // Netlify function endpoint
    const NETLIFY_API_URL = '/.netlify/functions/myapi';
    
    // PDF Generation Utility
    const generatePDF = (title, content, filename) => {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      
      // Add title
      doc.setFontSize(18);
      doc.text(title, 20, 20);
      
      // Add content
      doc.setFontSize(12);
      let y = 30;
      
      // Split content into lines to fit page width
      const splitContent = doc.splitTextToSize(content, 170);
      
      // Calculate line height
      const lineHeight = 7;
      
      // Add content with pagination
      for (let i = 0; i < splitContent.length; i++) {
        // Check if we need a new page
        if (y > 280) { // A4 height is about 297mm, leaving margin
          doc.addPage();
          y = 20; // Reset y position for new page
        }
        
        // Add the line
        doc.text(splitContent[i], 20, y);
        y += lineHeight;
      }
      
      // Save the PDF
      doc.save(filename);
    };

    // --- Default Goal Data ---
    const defaultGoals = {
      calories: 2000,
      protein: 120,
      carbs: 250,
      fat: 60,
      activity: 30, // in minutes
      water: 8, // in glasses
    };

    // --- Helper Components ---


    // --- Main App Component ---
    function App() {
      const [screen, setScreen] = useState('dashboard'); // 'dashboard', 'scan', 'profile', 'planner', 'workout', 'coach', 'progress'

      // --- Clean Theme State Management ---
      const [isDarkMode, setIsDarkMode] = useState(() => {
        const saved = localStorage.getItem('fitmate-dark-mode');
        return saved === 'true';
      });

      // --- Coach and Progress State Management ---
      const [coachMessages, setCoachMessages] = useState(() => {
        const savedMessages = localStorage.getItem('coachMessages');
        return savedMessages ? JSON.parse(savedMessages) : [{ text: "Hello! I'm your AI Health Coach. Ask me anything about your nutrition or meals.", sender: 'ai' }];
      });
      const [habitAIAdvice, setHabitAIAdvice] = useState(() => {
        const savedAdvice = localStorage.getItem('habitAIAdvice');
        return savedAdvice || '';
      });
      const [isLoadingAdvice, setIsLoadingAdvice] = useState(false);

      // Add these new AI states:
      const [scanResult, setScanResult] = useState(() => {
        const saved = localStorage.getItem('scanResult');
        return saved ? JSON.parse(saved) : null;
      });
      const [scanLoading, setScanLoading] = useState(false);
      const [scanError, setScanError] = useState(null);

      const [mealPlan, setMealPlan] = useState(() => {
        const saved = localStorage.getItem('mealPlan');
        return saved ? JSON.parse(saved) : null;
      });
      const [mealPlanLoading, setMealPlanLoading] = useState(false);
      const [mealPlanError, setMealPlanError] = useState(null);

      const [workoutPlan, setWorkoutPlan] = useState(() => {
        const saved = localStorage.getItem('workoutPlan');
        return saved ? JSON.parse(saved) : null;
      });
      const [workoutPlanLoading, setWorkoutPlanLoading] = useState(false);
      const [workoutPlanError, setWorkoutPlanError] = useState(null);

      const [formAnalysis, setFormAnalysis] = useState(() => {
        const saved = localStorage.getItem('formAnalysis');
        return saved ? JSON.parse(saved) : null;
      });
      const [formAnalysisLoading, setFormAnalysisLoading] = useState(false);
      const [formAnalysisError, setFormAnalysisError] = useState(null);

      useEffect(() => {
        if (isDarkMode) {
          document.documentElement.classList.add('dark');
        } else {
          document.documentElement.classList.remove('dark');
        }
        localStorage.setItem('fitmate-dark-mode', isDarkMode.toString());
      }, [isDarkMode]);

      useEffect(() => {
        if ('Notification' in window && Notification.permission === 'default') {
          Notification.requestPermission();
        }
      }, []);

      const toggleDarkMode = () => {
        setIsDarkMode(prev => !prev);
      };

      // --- State Initialization from localStorage ---
      const [goals, setGoals] = useState(() => {
        const savedGoals = localStorage.getItem('goals');
        return savedGoals ? JSON.parse(savedGoals) : defaultGoals;
      });

      const [dailyIntake, setDailyIntake] = useState(() => {
        const savedIntake = localStorage.getItem('dailyIntake');
        return savedIntake ? JSON.parse(savedIntake) : { calories: 0, protein: 0, carbs: 0, fat: 0, activity: 0, water: 0 };
      });

      const [recentMeals, setRecentMeals] = useState(() => {
        const savedMeals = localStorage.getItem('recentMeals');
        return savedMeals ? JSON.parse(savedMeals) : [];
      });

      const [dailyHistory, setDailyHistory] = useState(() => {
        const savedHistory = localStorage.getItem('dailyHistory');
        return savedHistory ? JSON.parse(savedHistory) : {};
      });

      // --- Data Archiving Logic ---
      useEffect(() => {
        const lastSavedDate = localStorage.getItem('lastSavedDate');
        const today = new Date().toISOString().split('T')[0];

        if (lastSavedDate && lastSavedDate !== today) {
          const oldIntake = JSON.parse(localStorage.getItem('dailyIntake'));
          const oldMeals = JSON.parse(localStorage.getItem('recentMeals'));
          const savedGoals = JSON.parse(localStorage.getItem('goals')) || defaultGoals;

          const calorieScore = Math.max(0, 100 - Math.abs(oldIntake.calories - savedGoals.calories) / savedGoals.calories * 100);
          const activityScore = Math.min(100, (oldIntake.activity / savedGoals.activity) * 100);
          const waterScore = Math.min(100, (oldIntake.water / savedGoals.water) * 100);
          const finalScore = Math.round((calorieScore * 0.5) + (activityScore * 0.3) + (waterScore * 0.2));

          setDailyHistory(prevHistory => ({
            ...prevHistory,
            [lastSavedDate]: {
              intake: oldIntake,
              meals: oldMeals,
              score: finalScore,
            }
          }));

          // Reset for the new day
          setDailyIntake({ calories: 0, protein: 0, carbs: 0, fat: 0, activity: 0, water: 0 });
          setRecentMeals([]);
        }

        localStorage.setItem('lastSavedDate', today);
      }, []);

      // --- useEffect Hooks for Data Persistence ---
      useEffect(() => { localStorage.setItem('goals', JSON.stringify(goals)); }, [goals]);
      useEffect(() => { localStorage.setItem('dailyIntake', JSON.stringify(dailyIntake)); }, [dailyIntake]);
      useEffect(() => { localStorage.setItem('recentMeals', JSON.stringify(recentMeals)); }, [recentMeals]);
      useEffect(() => { localStorage.setItem('dailyHistory', JSON.stringify(dailyHistory)); }, [dailyHistory]);
      useEffect(() => { localStorage.setItem('coachMessages', JSON.stringify(coachMessages)); }, [coachMessages]);
      useEffect(() => { localStorage.setItem('habitAIAdvice', habitAIAdvice); }, [habitAIAdvice]);
      
      // --- AI State Persistence ---
      useEffect(() => {
        if (scanResult) {
          localStorage.setItem('scanResult', JSON.stringify(scanResult));
        }
      }, [scanResult]);
      
      useEffect(() => {
        if (mealPlan) {
          localStorage.setItem('mealPlan', JSON.stringify(mealPlan));
        }
      }, [mealPlan]);
      
      useEffect(() => {
        if (workoutPlan) {
          localStorage.setItem('workoutPlan', JSON.stringify(workoutPlan));
        }
      }, [workoutPlan]);
      
      useEffect(() => {
        if (formAnalysis) {
          localStorage.setItem('formAnalysis', JSON.stringify(formAnalysis));
        }
      }, [formAnalysis]);

      // Function to add a new meal to the log
      const handleLogMeal = (mealData) => {
        setDailyIntake(prevIntake => ({
          ...prevIntake,
          calories: prevIntake.calories + (mealData.calories || 0),
          protein: prevIntake.protein + (mealData.protein || 0),
          carbs: prevIntake.carbs + (mealData.carbs || 0),
          fat: prevIntake.fat + (mealData.fat || 0),
        }));

        const newMeal = {
          id: Date.now(),
          name: mealData.name,
          calories: mealData.calories,
          image: mealData.image || 'https://placehold.co/100x100/cccccc/333333?text=Meal',
          mood: mealData.mood || 'Neutral',
        };
        setRecentMeals(prevMeals => [newMeal, ...prevMeals]);
        setScreen('dashboard');
      };

      // Function to log daily activity
      const handleLogActivity = (activity) => {
        setDailyIntake(prevIntake => ({
          ...prevIntake,
          activity: prevIntake.activity + (activity.minutes || 0),
        }));
      };

      const handleLogWater = () => {
        setDailyIntake(prevIntake => ({
          ...prevIntake,
          water: prevIntake.water + 1,
        }));
      };

      // Function to render the current screen based on state
      const renderScreen = () => {
        switch (screen) {
          case 'dashboard': return <Dashboard dailyIntake={dailyIntake} goals={goals} recentMeals={recentMeals} onLogActivity={handleLogActivity} onLogWater={handleLogWater} />;
          case 'scan': return <Scan 
            onLogMeal={handleLogMeal} 
            scanResult={scanResult}
            setScanResult={setScanResult}
            isLoading={scanLoading}
            setIsLoading={setScanLoading}
            error={scanError}
            setError={setScanError}
          />;
          case 'profile': return <Profile isDarkMode={isDarkMode} toggleDarkMode={toggleDarkMode} goals={goals} setGoals={setGoals} />;
          case 'planner': return <MealPlanner 
            goals={goals} 
            mealPlan={mealPlan}
            setMealPlan={setMealPlan}
            isLoading={mealPlanLoading}
            setIsLoading={setMealPlanLoading}
            error={mealPlanError}
            setError={setMealPlanError}
          />;
          case 'workout': return <WorkoutPlanner 
            workoutPlan={workoutPlan}
            setWorkoutPlan={setWorkoutPlan}
            isLoading={workoutPlanLoading}
            setIsLoading={setWorkoutPlanLoading}
            error={workoutPlanError}
            setError={setWorkoutPlanError}
          />;
          case 'coach': return <Coach 
            dailyIntake={dailyIntake} 
            recentMeals={recentMeals} 
            goals={goals}
            messages={coachMessages}
            setMessages={setCoachMessages}
          />;
          case 'progress': return <Progress 
            dailyHistory={dailyHistory} 
            goals={goals} 
            dailyIntake={dailyIntake}
            habitAIAdvice={habitAIAdvice}
            setHabitAIAdvice={setHabitAIAdvice}
            isLoadingAdvice={isLoadingAdvice}
            setIsLoadingAdvice={setIsLoadingAdvice}
          />;
          default: return <Dashboard dailyIntake={dailyIntake} goals={goals} recentMeals={recentMeals} onLogActivity={handleLogActivity} onLogWater={handleLogWater} />;
        }
      };

      return (
        <div className="bg-gray-50 dark:bg-gray-900 min-h-screen font-sans flex flex-col">
          <main className="flex-grow">
            {renderScreen()}
          </main>
          <BottomNavBar screen={screen} setScreen={setScreen} />
        </div>
      );
    }

    // --- Screens ---

    // Dashboard Screen Component
    const Dashboard = ({ dailyIntake, recentMeals, goals, onLogActivity, onLogWater }) => {
      const calorieProgress = goals.calories > 0 ? (dailyIntake.calories / goals.calories) * 100 : 0;
      const [quote, setQuote] = useState('');

      // Fetch daily motivational quote
      useEffect(() => {
        const fetchQuote = async () => {
          const today = new Date().toISOString().split('T')[0];
          const lastFetchDate = localStorage.getItem('lastQuoteFetchDate');
          const savedQuote = localStorage.getItem('dailyQuote');

          if (lastFetchDate === today && savedQuote) {
            setQuote(savedQuote);
            return;
          }

          const prompt = "Give me a short, powerful motivational quote for fitness. Respond with only the quote itself, no extra text or quotation marks.";

          try {
            const response = await fetch(NETLIFY_API_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              contents: [{ parts: [{ text: prompt }] }]
            })
          });

            if (!response.ok) throw new Error('Failed to fetch quote');

            const result = await response.json();
            const newQuote = result.candidates[0].content.parts[0].text.trim();
            setQuote(newQuote);
            localStorage.setItem('dailyQuote', newQuote);
            localStorage.setItem('lastQuoteFetchDate', today);
          } catch (error) {
            console.error("Failed to fetch daily quote:", error);
            setQuote("The only bad workout is the one that didn't happen."); // Fallback quote
          }
        };

        fetchQuote();
      }, []);

      // Calculate Health Score
      const calculateHealthScore = () => {
        if (!dailyIntake) return 0;
        const calorieScore = Math.max(0, 100 - Math.abs(dailyIntake.calories - goals.calories) / goals.calories * 100);
        const activityScore = Math.min(100, (dailyIntake.activity / goals.activity) * 100);
        const waterScore = Math.min(100, (dailyIntake.water / goals.water) * 100);
        return Math.round((calorieScore * 0.5) + (activityScore * 0.3) + (waterScore * 0.2));
      };

      const healthScore = calculateHealthScore();

      return (
        <div className="p-6 pb-24">
          <header className="mb-6 bg-white dark:bg-gray-800 p-4 rounded-2xl shadow-md">
            <div className="flex items-center">
              <svg className="w-10 h-10 mr-3 text-pink-500" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M12 2C6.48 2 2 6.48 2 12C2 17.52 6.48 22 12 22C17.52 22 22 17.52 22 12C22 6.48 17.52 2 12 2ZM16.6 13.2L14.4 15.4C13.6 16.2 12.4 16.2 11.6 15.4L7.4 11.2C6.6 10.4 6.6 9.2 7.4 8.4L9.6 6.2C10.4 5.4 11.6 5.4 12.4 6.2L16.6 10.4C17.4 11.2 17.4 12.4 16.6 13.2Z" fill="currentColor"/>
              </svg>
              <div>
                <h1 className="text-3xl font-bold text-gray-800 dark:text-gray-200">FitnessMate</h1>
                <p className="text-gray-500 dark:text-gray-400">Your daily health summary</p>
              </div>
            </div>
            {quote && <p className="text-gray-600 dark:text-gray-300 italic mt-2 text-center bg-gray-100 dark:bg-gray-700 p-2 rounded-lg">"{quote}"</p>}
          </header>

          <div className="grid md:grid-cols-2 gap-6 mb-6">
            {/* Health Score Card - Fixed light gradient */}
            <div className="bg-white dark:bg-gray-800 p-6 rounded-2xl shadow-md text-center h-full flex flex-col">
              <h2 className="text-xl font-bold text-gray-800 dark:text-gray-200 mb-4">Health Score</h2>
              <div className="flex-grow flex flex-col justify-center">
                <div className="relative w-32 h-32 mx-auto">
                  <svg className="w-full h-full" viewBox="0 0 36 36">
                    <path className="text-gray-200 dark:text-gray-700" strokeWidth="3" fill="none" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" />
                    <path className="text-green-500" strokeWidth="3" strokeLinecap="round" fill="none" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" strokeDasharray={`${healthScore}, 100`} />
                  </svg>
                  <div className="absolute inset-0 flex items-center justify-center">
                    <span className="text-3xl font-bold text-green-500">{healthScore}</span>
                  </div>
                </div>
                <p className="text-gray-600 dark:text-gray-400 mt-2">Today's Score / 100</p>
                <div className="text-xs text-gray-500 dark:text-gray-400 mt-2 space-y-1">
                  <p><span className="font-bold text-pink-500">50%</span> Nutrition</p>
                  <p><span className="font-bold text-cyan-500">30%</span> Activity</p>
                  <p><span className="font-bold text-blue-500">20%</span> Hydration</p>
                </div>
              </div>
            </div>

            {/* Activity & Water Tracker Card - Fixed light gradient */}
            <div className="bg-white dark:bg-gray-800 p-4 sm:p-6 rounded-2xl shadow-md h-full flex flex-col">
              <h2 className="text-xl font-bold text-gray-800 dark:text-gray-200 mb-4 text-center">Activity & Hydration</h2>
              <div className="flex-grow flex flex-col justify-center space-y-4">
                <ActivityTimer onLogActivity={onLogActivity} />
                <WaterTracker onLogWater={onLogWater} dailyIntake={dailyIntake} goals={goals} />
              </div>
            </div>
          </div>

          <div className="bg-gradient-to-br from-cyan-400 to-pink-500 rounded-2xl p-6 mb-6 text-white shadow-lg">
            <p className="font-semibold">Calories</p>
            <div className="flex items-end my-2">
              <p className="text-5xl font-bold">{Math.round(dailyIntake.calories)}</p>
              <p className="ml-2 mb-1">/ {goals.calories} kcal</p>
            </div>
            <div className="w-full bg-white/30 rounded-full h-2.5">
              <div className="bg-white h-2.5 rounded-full" style={{ width: `${calorieProgress}%` }}></div>
            </div>
          </div>

          <div className="grid grid-cols-3 gap-4 mb-6">
            <MacroCard title="Protein" value={dailyIntake.protein} goal={goals.protein} unit="g" color="text-blue-500" />
            <MacroCard title="Carbs" value={dailyIntake.carbs} goal={goals.carbs} unit="g" color="text-yellow-500" />
            <MacroCard title="Fat" value={dailyIntake.fat} goal={goals.fat} unit="g" color="text-red-500" />
          </div>

          <div>
            <h2 className="text-xl font-bold text-gray-800 dark:text-gray-200 mb-4">Recent Meals</h2>
            {recentMeals.length > 0 ? (
              <div className="space-y-3">
                {recentMeals.map((meal) => (
                  <MealCard key={meal.id} meal={meal} />
                ))}
              </div>
            ) : (
              <div className="text-center text-gray-500 dark:text-gray-400 bg-white dark:bg-gray-800 p-6 rounded-2xl shadow-md">
                <p>No meals logged yet.</p>
                <p>Tap the 'Cal' button to scan your first meal!</p>
              </div>
            )}
          </div>
        </div>
      );
    };

    // Profile Screen Component
    const Profile = ({ isDarkMode, toggleDarkMode, goals, setGoals }) => {
      const [profilePicture, setProfilePicture] = useState(() => {
        const saved = localStorage.getItem('profilePicture');
        return saved || "https://placehold.co/100x100/EAB543/ffffff?text=User";
      });
      const [isGeneratingAvatar, setIsGeneratingAvatar] = useState(false);
      const [notificationsEnabled, setNotificationsEnabled] = useState(() => {
        const saved = localStorage.getItem('notificationsEnabled');
        return saved ? JSON.parse(saved) : true;
      });
      const [showPrivacyModal, setShowPrivacyModal] = useState(false);
      const fileInputRef = useRef(null);

      // Save profile picture to localStorage whenever it changes
      useEffect(() => {
        localStorage.setItem('profilePicture', profilePicture);
      }, [profilePicture]);

      // Save notifications setting to localStorage
      useEffect(() => {
        localStorage.setItem('notificationsEnabled', JSON.stringify(notificationsEnabled));
      }, [notificationsEnabled]);

      const toggleNotifications = () => {
        setNotificationsEnabled(prev => {
          const newValue = !prev;
          // Show user feedback
          if (newValue) {
            alert('‚úÖ Notifications enabled! You\'ll receive fitness reminders and updates.');
          } else {
            alert('üîï Notifications disabled. You won\'t receive any alerts.');
          }
          return newValue;
        });
      };

      const handleGoalChange = (key, value) => {
        setGoals(prevGoals => ({ ...prevGoals, [key]: Number(value) }));
      };

      const handleImageUpload = (event) => {
        const file = event.target.files[0];
        if (file) {
          const reader = new FileReader();
          reader.onload = (e) => {
            setProfilePicture(e.target.result);
          };
          reader.readAsDataURL(file);
        }
      };

      const openPrivacyModal = () => {
        setShowPrivacyModal(true);
      };

      const closePrivacyModal = () => {
        setShowPrivacyModal(false);
      };

      const generateAIAvatar = async () => {
        // Show prompt to collect user preferences
        const gender = prompt("What gender would you like for your avatar? (male/female/non-binary)", "male");
        if (!gender) return; // User cancelled
        
        const style = prompt("What style do you prefer? (professional/casual/sporty/artistic)", "sporty");
        if (!style) return; // User cancelled
        
        const hairColor = prompt("Preferred hair color? (brown/black/blonde/red/gray/other)", "brown");
        if (!hairColor) return; // User cancelled
        
        setIsGeneratingAvatar(true);
        try {
          const prompt = `Create a professional, friendly avatar for a fitness app user with these specifications:
          - Gender: ${gender}
          - Style: ${style} 
          - Hair color: ${hairColor}
          - Clean, modern design
          - Suitable for a health and fitness application
          - Colorful but professional
          - Square format, suitable for profile picture
          - Cartoon or illustrated style, not photorealistic
          - Should look healthy, fit, and approachable
          - Age range: 25-35 years old
          
          Generate a detailed description for an avatar that represents health, fitness, and wellness with the specified characteristics.`;

            const response = await fetch(NETLIFY_API_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              contents: [{ parts: [{ text: prompt }] }]
            })
          });

          if (!response.ok) {
            throw new Error(`API Error: ${response.status}`);
          }

          const result = await response.json();
          const description = result.candidates[0].content.parts[0].text;
          
          // Use the AI description with user preferences as seed for avatar generation
          const seed = `${gender}-${style}-${hairColor}-${description.substring(0, 30)}`;
          const avatarUrl = `https://api.dicebear.com/7.x/avataaars/svg?seed=${encodeURIComponent(seed)}&backgroundColor=b6e3f4,c0aede,d1d4f9,ffd5dc,ffdfbf&hair=${hairColor === 'blonde' ? 'blonde' : hairColor === 'red' ? 'red' : 'brown'}`;
          
          setProfilePicture(avatarUrl);
        } catch (error) {
          console.error('Avatar generation error:', error);
          alert('Failed to generate avatar. Please try again.');
        } finally {
          setIsGeneratingAvatar(false);
        }
      };

      return (
        <div className="p-6 pb-24">
          <header className="mb-6">
            <h1 className="text-3xl font-bold text-gray-800 dark:text-gray-200">My Profile</h1>
          </header>

          <div className="flex flex-col items-center mb-6 bg-white dark:bg-gray-800 p-6 rounded-2xl shadow-md">
            <div className="relative mb-4">
              <img 
                src={profilePicture} 
                alt="User profile" 
                className="w-24 h-24 rounded-full object-cover border-4 border-pink-200 dark:border-pink-400" 
              />
              <button
                onClick={() => fileInputRef.current?.click()}
                className="absolute -bottom-2 -right-2 bg-pink-500 text-white p-2 rounded-full shadow-lg hover:bg-pink-600 transition-colors"
                title="Upload Photo"
              >
                üì∑
              </button>
            </div>
            
            <div className="flex gap-2 mb-4">
              <button
                onClick={() => fileInputRef.current?.click()}
                className="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors"
              >
                üìÅ Upload Photo
              </button>
              <button
                onClick={generateAIAvatar}
                disabled={isGeneratingAvatar}
                className="bg-purple-500 hover:bg-purple-600 disabled:bg-gray-400 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors flex items-center gap-1"
              >
                {isGeneratingAvatar ? '‚è≥ Generating...' : 'ü§ñ AI Avatar'}
              </button>
            </div>

            <input
              type="file"
              ref={fileInputRef}
              onChange={handleImageUpload}
              accept="image/*"
              className="hidden"
            />
            
            <h2 className="text-2xl font-bold text-gray-800 dark:text-gray-200">John Doe</h2>
            <p className="text-gray-500 dark:text-gray-400">john.doe@example.com</p>
          </div>

          <div className="mb-6">
            <h3 className="text-xl font-bold text-gray-800 dark:text-gray-200 mb-4">My Goals</h3>
            <div className="bg-white dark:bg-gray-800 rounded-2xl shadow-md p-4 space-y-3">
              <div className="p-2">
                <label className="font-semibold mb-2 block text-gray-800 dark:text-gray-200">Daily Calories: {goals.calories} kcal</label>
                <input type="range" min="1200" max="4000" step="50" value={goals.calories} onChange={e => handleGoalChange('calories', e.target.value)} className="w-full" />
              </div>
              <div className="flex justify-between items-center p-2">
                <p className="text-gray-600 dark:text-gray-300">Protein</p>
                <p className="font-bold text-gray-800 dark:text-gray-200">{goals.protein} g</p>
              </div>
              <div className="flex justify-between items-center p-2">
                <p className="text-gray-600 dark:text-gray-300">Carbs</p>
                <p className="font-bold text-gray-800 dark:text-gray-200">{goals.carbs} g</p>
              </div>
              <div className="flex justify-between items-center p-2">
                <p className="text-gray-600 dark:text-gray-300">Fat</p>
                <p className="font-bold text-gray-800 dark:text-gray-200">{goals.fat} g</p>
              </div>
            </div>
          </div>

          <div>
            <h3 className="text-xl font-bold text-gray-800 dark:text-gray-200 mb-4">Settings</h3>
            <div className="bg-white dark:bg-gray-800 rounded-2xl shadow-md p-4 space-y-1">
              <button className="w-full text-left p-3 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 text-gray-700 dark:text-gray-300 transition-colors">
                Account
              </button>
              
              {/* Updated Notifications with toggle */}
              <div className="flex justify-between items-center p-3">
                <span className="text-gray-700 dark:text-gray-300">Notifications</span>
                <button 
                  onClick={toggleNotifications}
                  className={`relative w-14 h-7 rounded-full p-1 transition-colors duration-200 focus:outline-none ${
                    notificationsEnabled ? 'bg-green-500' : 'bg-gray-300'
                  }`}
                  title={notificationsEnabled ? 'Notifications ON' : 'Notifications OFF'}
                >
                  <div className={`w-5 h-5 bg-white rounded-full shadow-md transform transition-transform duration-200 ${
                    notificationsEnabled ? 'translate-x-7' : 'translate-x-0'
                  }`}></div>
                </button>
              </div>
              
              <button 
                onClick={openPrivacyModal}
                className="w-full text-left p-3 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 text-gray-700 dark:text-gray-300 transition-colors"
              >
                Privacy
              </button>
              
              {/* Existing Dark Mode toggle */}
              <div className="flex justify-between items-center p-3">
                <span className="text-gray-700 dark:text-gray-300">Dark Mode</span>
                <button 
                  onClick={toggleDarkMode} 
                  className={`relative w-14 h-7 rounded-full p-1 transition-colors duration-200 focus:outline-none ${
                    isDarkMode ? 'bg-pink-500' : 'bg-gray-300'
                  }`}
                >
                  <div className={`w-5 h-5 bg-white rounded-full shadow-md transform transition-transform duration-200 ${
                    isDarkMode ? 'translate-x-7' : 'translate-x-0'
                  }`}></div>
                </button>
              </div>
            </div>
          </div>

          {/* Privacy Modal */}
          {showPrivacyModal && (
            <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
              <div className="bg-white dark:bg-gray-800 rounded-2xl shadow-2xl max-w-md w-full max-h-[80vh] overflow-y-auto">
                {/* Modal Header */}
                <div className="flex justify-between items-center p-6 border-b border-gray-200 dark:border-gray-700">
                  <h2 className="text-2xl font-bold text-gray-800 dark:text-gray-200 flex items-center">
                    üîí Privacy Policy
                  </h2>
                  <button 
                    onClick={closePrivacyModal}
                    className="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200 text-2xl font-bold transition-colors"
                  >
                    √ó
                  </button>
                </div>
                
                {/* Modal Content */}
                <div className="p-6 space-y-4">
                  <div className="bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800 rounded-lg p-4">
                    <h3 className="font-semibold text-blue-800 dark:text-blue-200 mb-2 flex items-center">
                      üì± Local Storage Only
                    </h3>
                    <p className="text-blue-700 dark:text-blue-300 text-sm">
                      Your data is stored locally on your device only. We do not collect, transmit, or store any personal information on external servers.
                    </p>
                  </div>
                  
                  <div className="space-y-3 text-gray-700 dark:text-gray-300">
                    <div>
                      <h4 className="font-semibold mb-1">üõ°Ô∏è Data Security</h4>
                      <p className="text-sm">
                        All your fitness data, goals, and preferences remain on your device using browser's local storage technology.
                      </p>
                    </div>
                    
                    <div>
                      <h4 className="font-semibold mb-1">üîÑ Data Control</h4>
                      <p className="text-sm">
                        You have complete control over your data. Clearing your browser data will remove all stored information.
                      </p>
                    </div>
                    
                    <div>
                      <h4 className="font-semibold mb-1">ü§ñ AI Interactions</h4>
                      <p className="text-sm">
                        AI coaching features may send anonymized queries to external services for responses, but no personal data is retained.
                      </p>
                    </div>
                    
                    <div>
                      <h4 className="font-semibold mb-1">üì∏ Image Processing</h4>
                      <p className="text-sm">
                        Food scanning and image analysis are processed temporarily and not stored permanently.
                      </p>
                    </div>
                  </div>
                  
                  <div className="bg-green-50 dark:bg-green-900/20 border border-green-200 dark:border-green-800 rounded-lg p-4">
                    <p className="text-green-800 dark:text-green-200 text-sm font-medium">
                      ‚úÖ Your privacy is our priority. This app is designed with privacy-first principles.
                    </p>
                  </div>
                </div>
                
                {/* Modal Footer */}
                <div className="p-6 border-t border-gray-200 dark:border-gray-700">
                  <button 
                    onClick={closePrivacyModal}
                    className="w-full bg-gradient-to-r from-purple-500 to-pink-500 text-white py-3 px-4 rounded-xl font-semibold hover:from-purple-600 hover:to-pink-600 transition-all duration-200 shadow-lg"
                  >
                    Got it!
                  </button>
                </div>
              </div>
            </div>
          )}
        </div>
      );
    };



    // Scan Screen Component with Gemini API Integration
    const Scan = ({ onLogMeal }) => {
      const [isLoading, setIsLoading] = useState(false);
      const [scanResult, setScanResult] = useState(null);
      const [error, setError] = useState(null);
      const [imagePreview, setImagePreview] = useState(null);
      const [selectedMood, setSelectedMood] = useState(null);
      const fileInputRef = useRef(null);

      const fileToBase64 = (file) => new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = () => resolve(reader.result.split(',')[1]);
        reader.onerror = error => reject(error);
      });

      const handleImageChange = (event) => {
        const file = event.target.files[0];
        if (file) {
          const previewUrl = URL.createObjectURL(file);
          setImagePreview(previewUrl);
          setScanResult(null);
          setError(null);
          setSelectedMood(null);
          handleScan(file, previewUrl);
        }
      };

      const handleScan = async (file, previewUrl) => {
        setIsLoading(true);
        setError(null);
        try {
          const base64ImageData = await fileToBase64(file);
          const prompt = `Analyze the food in this image.
1. Identify the main dish.
2. Break it down into primary ingredients and estimate calories for each.
3. Provide a total nutritional summary (calories, protein, carbs, fat).
4. Offer a single, actionable, and encouraging "health_tip" to make this meal healthier next time.
Respond ONLY with a valid JSON object in this format:
{
  "name": "Overall Dish Name",
  "total_calories": 550,
  "total_protein": 30.5,
  "total_carbs": 45.2,
  "total_fat": 25.8,
  "ingredients": [
    {"name": "Ingredient 1", "calories": 200},
    {"name": "Ingredient 2", "calories": 150}
  ],
  "health_tip": "A short, encouraging tip to improve the meal."
}`;

          const payload = {
            contents: [
              {
                parts: [
                  { text: prompt },
                  { inlineData: { mimeType: file.type, data: base64ImageData } }
                ]
              }
            ],
          };

          const response = await fetch(NETLIFY_API_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
          });

          if (!response.ok) {
            throw new Error(`API Error: ${response.status} ${response.statusText}`);
          }

          const result = await response.json();
          const textResponse = result.candidates[0].content.parts[0].text || '';
          const jsonString = textResponse.replace(/```json|```/g, '').trim();
          const data = JSON.parse(jsonString);
          data.image = previewUrl;
          setScanResult(data);
        } catch (err) {
          console.error("Gemini API call failed:", err);
          setError('Could not analyze the image. Please try again.');
        } finally {
          setIsLoading(false);
        }
      };

      return (
        <div className="p-6 pb-24 flex flex-col items-center">
          <header className="mb-6 text-center">
            <h1 className="text-3xl font-bold text-gray-800 dark:text-gray-200">AI Food Scanner</h1>
            <p className="text-gray-500 dark:text-gray-400">Get instant nutritional info and health tips</p>
          </header>

          <div className="w-full max-w-md mx-auto">
            <div className="bg-white dark:bg-gray-800 p-8 rounded-2xl shadow-md text-center">
              <div className="mb-6">
                <div className="w-24 h-24 mx-auto mb-4 bg-gradient-to-br from-purple-400 to-pink-500 rounded-full flex items-center justify-center">
                  <span className="text-4xl">üì∑</span>
                </div>
                <h3 className="text-xl font-bold text-gray-800 dark:text-gray-200 mb-2">Scan Your Food</h3>
                <p className="text-gray-600 dark:text-gray-400 mb-6">Take a photo of your meal and get instant nutritional analysis with personalized health tips!</p>
              </div>
              
              {imagePreview ? (
                <div className="relative w-full h-64 rounded-2xl mb-6 overflow-hidden">
                  <img src={imagePreview} alt="Meal preview" className="w-full h-full object-cover" />
                  {isLoading && (
                    <div className="absolute inset-0 bg-black/50 flex items-center justify-center text-white">
                      Analyzing...
                    </div>
                  )}
                </div>
              ) : (
                <button
                  onClick={() => fileInputRef.current.click()}
                  className="w-full bg-gradient-to-r from-purple-500 to-pink-500 text-white font-bold py-4 rounded-2xl shadow-lg hover:from-purple-600 hover:to-pink-600 transition-all transform hover:scale-105 mb-6"
                >
                  üì∑ Scan Your Meal
                </button>
              )}
              
              <div className="mt-6 p-4 bg-purple-50 dark:bg-purple-900/20 rounded-xl">
                <h4 className="font-semibold text-purple-800 dark:text-purple-200 mb-2">üí° Pro Tips:</h4>
                <ul className="text-sm text-purple-700 dark:text-purple-300 space-y-1">
                  <li>‚Ä¢ Ensure good lighting for best results</li>
                  <li>‚Ä¢ Include labels and packaging when visible</li>
                  <li>‚Ä¢ Multiple ingredients in one photo work great!</li>
                </ul>
              </div>
            </div>
            
            <input
              type="file"
              accept="image/*"
              capture="environment"
              ref={fileInputRef}
              onChange={handleImageChange}
              className="hidden"
            />

            {error && <div className="my-4 text-center text-red-500 bg-red-100 p-3 rounded-lg">{error}</div>}

            {scanResult && (
              <div className="mt-6 bg-white dark:bg-gray-800 p-6 rounded-2xl shadow-md animate-fade-in">
                <h2 className="text-2xl font-bold text-gray-800 dark:text-gray-200 mb-2">{scanResult.name}</h2>
                <p className="text-lg font-semibold text-gray-600 dark:text-gray-300 mb-4">{scanResult.total_calories} kcal</p>

                {scanResult.health_tip && (
                  <div className="mb-4 p-4 bg-yellow-100 text-yellow-800 rounded-lg flex items-start">
                    <span className="text-2xl mr-3">üí°</span>
                    <div>
                      <h3 className="font-bold">Plate Perfecter Tip</h3>
                      <p>{scanResult.health_tip}</p>
                    </div>
                  </div>
                )}

                {/* Mindful Journal Section */}
                <div className="my-4">
                  <h3 className="font-bold text-gray-700 dark:text-gray-300 mb-2 text-center">How do you feel after this meal?</h3>
                  <div className="flex justify-around">
                    {['Energized', 'Happy', 'Sluggish', 'Bloated'].map(mood => (
                      <button
                        key={mood}
                        onClick={() => setSelectedMood(mood)}
                        className={`p-2 rounded-lg border-2 ${selectedMood === mood ? 'border-pink-500' : 'border-transparent'}`}
                      >
                        <span className="text-3xl">{{ Energized: '‚ö°Ô∏è', Happy: 'üòä', Sluggish: 'üò¥', Bloated: 'ü§¢' }[mood]}</span>
                      </button>
                    ))}
                  </div>
                </div>

                <div className="space-y-3 mb-4 text-gray-800 dark:text-gray-200">
                  <h3 className="font-bold text-gray-700 dark:text-gray-300">Nutritional Summary:</h3>
                  <p><strong>Protein:</strong> {scanResult.total_protein} g</p>
                  <p><strong>Carbs:</strong> {scanResult.total_carbs} g</p>
                  <p><strong>Fat:</strong> {scanResult.total_fat} g</p>
                </div>

                {scanResult.ingredients && scanResult.ingredients.length > 0 && (
                  <div className="space-y-3 mb-4 text-gray-800 dark:text-gray-200">
                    <h3 className="font-bold text-gray-700 dark:text-gray-300">Ingredient Breakdown:</h3>
                    {scanResult.ingredients.map((item, index) => (
                      <div key={index} className="flex justify-between">
                        <span>{item.name}</span>
                        <span>{item.calories} kcal</span>
                      </div>
                    ))}
                  </div>
                )}

                <button
                  onClick={() => onLogMeal({
                    ...scanResult,
                    calories: scanResult.total_calories,
                    protein: scanResult.total_protein,
                    carbs: scanResult.total_carbs,
                    fat: scanResult.total_fat,
                    image: scanResult.image,
                    mood: selectedMood
                  })}
                  className="w-full mt-4 bg-green-500 text-white font-bold py-3 rounded-xl hover:bg-green-600 transition-colors"
                >
                  Log this Meal
                </button>
              </div>
            )}
          </div>
        </div>
      );

    };

    // Menu Decoder Component
    const MenuDecoder = ({ goals }) => {
      const [imagePreview, setImagePreview] = useState(null);
      const [isLoading, setIsLoading] = useState(false);
      const [menuItems, setMenuItems] = useState(null);
      const [recommendations, setRecommendations] = useState(null);
      const [error, setError] = useState(null);
      const [userGoals, setUserGoals] = useState('high protein, low carb');
      const fileInputRef = useRef(null);

      const fileToBase64 = (file) => new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = () => resolve(reader.result.split(',')[1]);
        reader.onerror = error => reject(error);
      });

      const resetScan = () => {
        setImagePreview(null);
        setMenuItems(null);
        setRecommendations(null);
        setError(null);
      };

      const handleImageChange = (e) => {
        const file = e.target.files[0];
        if (file) {
          const reader = new FileReader();
          reader.onload = (e) => setImagePreview(e.target.result);
          reader.readAsDataURL(file);
          setMenuItems(null);
          setRecommendations(null);
          setError(null);
          handleScan(file);
        }
      };

      const handleScan = async (file) => {
        setIsLoading(true);
        setError(null);
        try {
          const base64ImageData = await fileToBase64(file);
          const prompt = `Analyze this restaurant menu image and provide personalized recommendations.

1. Extract all visible menu items with their names, descriptions, and prices (if visible).
2. Based on the user's dietary goals: "${userGoals}" and daily calorie target of ${goals.calories} calories, analyze each item.
3. Provide specific recommendations with explanations.

Respond ONLY with a valid JSON object in this format:
{
  "menu_items": [
    {
      "name": "Item Name",
      "description": "Item description from menu",
      "price": "$X.XX or null if not visible",
      "estimated_calories": 000,
      "health_score": 1-10,
      "recommendation_reason": "Why this fits or doesn't fit user goals"
    }
  ],
  "top_recommendations": [
    {
      "item_name": "Best Item Name",
      "why_recommended": "Detailed explanation",
      "modification_tip": "Optional suggestion to make it healthier"
    }
  ],
  "items_to_avoid": [
    {
      "item_name": "Item to avoid",
      "why_avoid": "Reason why it doesn't fit goals"
    }
  ]
}`;

          const payload = {
            contents: [
              {
                parts: [
                  { text: prompt },
                  { inlineData: { mimeType: file.type, data: base64ImageData } }
                ]
              }
            ],
          };

          const response = await fetch(NETLIFY_API_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ contents: payload.contents })
          });

          if (!response.ok) {
            throw new Error(`API Error: ${response.status} ${response.statusText}`);
          }

          const result = await response.json();
          const textResponse = result.candidates[0].content.parts[0].text || '';
          const jsonString = textResponse.replace(/```json|```/g, '').trim();
          const data = JSON.parse(jsonString);
          setMenuItems(data.menu_items);
          setRecommendations({
            top: data.top_recommendations,
            avoid: data.items_to_avoid
          });
        } catch (err) {
          console.error("Menu analysis failed:", err);
          setError('Could not analyze menu. Please try again with a clearer image.');
        } finally {
          setIsLoading(false);
        }
      };

      return (
        <div className="p-6 pb-24">
          <header className="mb-6 text-center">
            <h1 className="text-3xl font-bold text-gray-800 dark:text-gray-200">üçΩÔ∏è Menu Decoder</h1>
            <p className="text-gray-500 dark:text-gray-400">Smart dining choices made easy!</p>
          </header>

          {!imagePreview && (
            <div className="max-w-md mx-auto">
              {/* Goals Input */}
              <div className="bg-white dark:bg-gray-800 p-4 rounded-2xl shadow-md mb-4">
                <h3 className="font-semibold text-gray-800 dark:text-gray-200 mb-2">Your Dining Goals:</h3>
                <input
                  type="text"
                  value={userGoals}
                  onChange={(e) => setUserGoals(e.target.value)}
                  placeholder="e.g., high protein, low carb, heart healthy"
                  className="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-800 dark:text-gray-200"
                />
              </div>

              <div className="bg-white dark:bg-gray-800 p-8 rounded-2xl shadow-md text-center">
                <div className="mb-6">
                  <div className="w-24 h-24 mx-auto mb-4 bg-gradient-to-br from-orange-400 to-red-500 rounded-full flex items-center justify-center">
                    <span className="text-4xl">üçΩÔ∏è</span>
                  </div>
                  <h3 className="text-xl font-bold text-gray-800 dark:text-gray-200 mb-2">Scan Restaurant Menu</h3>
                  <p className="text-gray-600 dark:text-gray-400 mb-6">Take a photo of any restaurant menu and I'll highlight the healthiest options for your goals!</p>
                </div>
                
                <input
                  type="file"
                  accept="image/*"
                  capture="environment"
                  onChange={handleImageChange}
                  ref={fileInputRef}
                  className="hidden"
                />
                
                <button
                  onClick={() => fileInputRef.current?.click()}
                  className="w-full bg-gradient-to-r from-orange-500 to-red-500 text-white font-bold py-4 rounded-2xl shadow-lg hover:from-orange-600 hover:to-red-600 transition-all transform hover:scale-105"
                >
                  üì∑ Scan Menu
                </button>
                
                <div className="mt-6 p-4 bg-orange-50 dark:bg-orange-900/20 rounded-xl">
                  <h4 className="font-semibold text-orange-800 dark:text-orange-200 mb-2">üí° Pro Tips:</h4>
                  <ul className="text-sm text-orange-700 dark:text-orange-300 space-y-1">
                    <li>‚Ä¢ Ensure menu text is clearly visible</li>
                    <li>‚Ä¢ Include item descriptions when possible</li>
                    <li>‚Ä¢ Works with any restaurant menu!</li>
                  </ul>
                </div>
              </div>
            </div>
          )}

          {imagePreview && (
            <div className="max-w-md mx-auto">
              <div className="bg-white dark:bg-gray-800 rounded-2xl shadow-md overflow-hidden">
                <img src={imagePreview} alt="Restaurant menu" className="w-full h-64 object-cover" />
                
                {isLoading && (
                  <div className="p-6 text-center">
                    <div className="animate-spin w-8 h-8 border-4 border-orange-500 border-t-transparent rounded-full mx-auto mb-4"></div>
                    <p className="text-gray-600 dark:text-gray-400">Analyzing menu options...</p>
                  </div>
                )}

                {error && (
                  <div className="p-6 text-center">
                    <p className="text-red-500 mb-4">{error}</p>
                    <button onClick={resetScan} className="bg-gray-500 text-white px-4 py-2 rounded-lg">
                      Try Again
                    </button>
                  </div>
                )}

                {recommendations && (
                  <div className="p-6">
                    <div className="flex justify-between items-center mb-4">
                      <h3 className="font-bold text-gray-800 dark:text-gray-200">üéØ Smart Recommendations</h3>
                      <button onClick={resetScan} className="text-orange-500 font-semibold text-sm">
                        ‚Üê New Menu
                      </button>
                    </div>
                    
                    {/* Top Recommendations */}
                    {recommendations.top && recommendations.top.length > 0 && (
                      <div className="mb-6">
                        <h4 className="font-semibold text-green-600 dark:text-green-400 mb-3">‚úÖ Best Choices for You:</h4>
                        <div className="space-y-3">
                          {recommendations.top.map((rec, index) => (
                            <div key={index} className="bg-green-50 dark:bg-green-900/20 p-4 rounded-lg border-l-4 border-green-500">
                              <h5 className="font-bold text-gray-800 dark:text-gray-200">{rec.item_name}</h5>
                              <p className="text-sm text-gray-600 dark:text-gray-400 mt-1">{rec.why_recommended}</p>
                              {rec.modification_tip && (
                                <p className="text-sm text-green-700 dark:text-green-300 mt-2 font-medium">
                                  üí° Tip: {rec.modification_tip}
                                </p>
                              )}
                            </div>
                          ))}
                        </div>
                      </div>
                    )}

                    {/* Items to Avoid */}
                    {recommendations.avoid && recommendations.avoid.length > 0 && (
                      <div className="mb-6">
                        <h4 className="font-semibold text-red-600 dark:text-red-400 mb-3">‚ö†Ô∏è Consider Avoiding:</h4>
                        <div className="space-y-3">
                          {recommendations.avoid.map((avoid, index) => (
                            <div key={index} className="bg-red-50 dark:bg-red-900/20 p-4 rounded-lg border-l-4 border-red-500">
                              <h5 className="font-bold text-gray-800 dark:text-gray-200">{avoid.item_name}</h5>
                              <p className="text-sm text-gray-600 dark:text-gray-400 mt-1">{avoid.why_avoid}</p>
                            </div>
                          ))}
                        </div>
                      </div>
                    )}

                    {/* All Menu Items */}
                    {menuItems && menuItems.length > 0 && (
                      <div>
                        <h4 className="font-semibold text-gray-800 dark:text-gray-200 mb-3">üìã All Menu Items:</h4>
                        <div className="space-y-2">
                          {menuItems.map((item, index) => (
                            <div key={index} className="bg-gray-50 dark:bg-gray-700 p-3 rounded-lg">
                              <div className="flex justify-between items-start">
                                <div className="flex-1">
                                  <h5 className="font-semibold text-gray-800 dark:text-gray-200">{item.name}</h5>
                                  {item.description && (
                                    <p className="text-sm text-gray-600 dark:text-gray-400 mt-1">{item.description}</p>
                                  )}
                                  <p className="text-xs text-gray-500 dark:text-gray-500 mt-1">{item.recommendation_reason}</p>
                                </div>
                                <div className="text-right ml-3">
                                  {item.price && (
                                    <p className="font-semibold text-gray-800 dark:text-gray-200">{item.price}</p>
                                  )}
                                  <div className="flex items-center mt-1">
                                    <span className={`text-xs px-2 py-1 rounded-full ${
                                      item.health_score >= 8 ? 'bg-green-200 text-green-800 dark:bg-green-800 dark:text-green-200' :
                                      item.health_score >= 6 ? 'bg-yellow-200 text-yellow-800 dark:bg-yellow-800 dark:text-yellow-200' :
                                      'bg-red-200 text-red-800 dark:bg-red-800 dark:text-red-200'
                                    }`}>
                                      {item.health_score}/10
                                    </span>
                                  </div>
                                  <p className="text-xs text-gray-500 dark:text-gray-500 mt-1">~{item.estimated_calories} cal</p>
                                </div>
                              </div>
                            </div>
                          ))}
                        </div>
                      </div>
                    )}
                  </div>
                )}
              </div>
            </div>
          )}
        </div>
      );
    };

    // Smart Pantry Chef Component
    const SmartPantryChef = ({ goals }) => {
      const [isLoading, setIsLoading] = useState(false);
      const [ingredients, setIngredients] = useState(null);
      const [recipes, setRecipes] = useState(null);
      const [error, setError] = useState(null);
      const [imagePreview, setImagePreview] = useState(null);
      const fileInputRef = useRef(null);

      const fileToBase64 = (file) => new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = () => resolve(reader.result.split(',')[1]);
        reader.onerror = error => reject(error);
      });

      const handleImageChange = (event) => {
        const file = event.target.files[0];
        if (file) {
          const previewUrl = URL.createObjectURL(file);
          setImagePreview(previewUrl);
          setIngredients(null);
          setRecipes(null);
          setError(null);
          handleScan(file);
        }
      };

      const handleScan = async (file) => {
        setIsLoading(true);
        setError(null);
        try {
          const base64ImageData = await fileToBase64(file);
          const prompt = `Analyze this image of pantry/fridge ingredients.
1. Identify all visible food items and ingredients.
2. List them clearly with estimated quantities if visible.
3. Respond ONLY with a valid JSON object in this format:
{
  "ingredients": [
    {"name": "Ingredient Name", "quantity": "estimated amount or 'available'"},
    {"name": "Another Ingredient", "quantity": "estimated amount or 'available'"}
  ]
}`;

          const payload = {
            contents: [
              {
                parts: [
                  { text: prompt },
                  { inlineData: { mimeType: file.type, data: base64ImageData } }
                ]
              }
            ],
          };

          const response = await fetch(NETLIFY_API_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ contents: payload.contents })
          });

          if (!response.ok) {
            throw new Error(`API Error: ${response.status} ${response.statusText}`);
          }

          const result = await response.json();
          const textResponse = result.candidates[0].content.parts[0].text || '';
          const jsonString = textResponse.replace(/```json|```/g, '').trim();
          const data = JSON.parse(jsonString);
          setIngredients(data.ingredients);
        } catch (err) {
          console.error("Ingredient recognition failed:", err);
          setError('Could not identify ingredients. Please try again.');
        } finally {
          setIsLoading(false);
        }
      };

      const generateRecipes = async () => {
        if (!ingredients || ingredients.length === 0) return;
        
        setIsLoading(true);
        setError(null);
        try {
          const ingredientList = ingredients.map(ing => ing.name).join(', ');
          const prompt = `Based on these available ingredients: ${ingredientList}
Create 3 healthy recipe suggestions that:
1. Use primarily these ingredients (can suggest 1-2 common pantry staples if needed)
2. Fit within a ${goals.calories} calorie daily target
3. Are practical and easy to make
4. Include estimated nutritional information

Respond ONLY with a valid JSON object:
{
  "recipes": [
    {
      "name": "Recipe Name",
      "prep_time": "15 minutes",
      "cook_time": "20 minutes",
      "servings": 2,
      "calories_per_serving": 350,
      "ingredients_used": ["ingredient1", "ingredient2"],
      "additional_needed": ["optional items"],
      "instructions": ["Step 1", "Step 2", "Step 3"],
      "nutrition": {"protein": 25, "carbs": 30, "fat": 15},
      "health_tip": "A tip to make it healthier"
    }
  ]
}`;

          const response = await fetch(NETLIFY_API_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              contents: [{ parts: [{ text: prompt }] }]
            })
          });

          if (!response.ok) {
            throw new Error(`API Error: ${response.status} ${response.statusText}`);
          }

          const result = await response.json();
          const textResponse = result.candidates[0].content.parts[0].text || '';
          const jsonString = textResponse.replace(/```json|```/g, '').trim();
          const data = JSON.parse(jsonString);
          setRecipes(data.recipes);
        } catch (err) {
          console.error("Recipe generation failed:", err);
          setError('Could not generate recipes. Please try again.');
        } finally {
          setIsLoading(false);
        }
      };

      const resetScan = () => {
        setImagePreview(null);
        setIngredients(null);
        setRecipes(null);
        setError(null);
        if (fileInputRef.current) {
          fileInputRef.current.value = '';
        }
      };

      return (
        <div className="p-6 pb-24">
          <header className="mb-6 text-center">
            <h1 className="text-3xl font-bold text-gray-800 dark:text-gray-200">üßë‚Äçüç≥ Smart Pantry Chef</h1>
            <p className="text-gray-500 dark:text-gray-400">Snap your ingredients, get instant recipes!</p>
          </header>

          {!imagePreview && (
            <div className="max-w-md mx-auto">
              <div className="bg-white dark:bg-gray-800 p-8 rounded-2xl shadow-md text-center">
                <div className="mb-6">
                  <div className="w-24 h-24 mx-auto mb-4 bg-gradient-to-br from-green-400 to-blue-500 rounded-full flex items-center justify-center">
                    <span className="text-4xl">üì∏</span>
                  </div>
                  <h3 className="text-xl font-bold text-gray-800 dark:text-gray-200 mb-2">Scan Your Pantry</h3>
                  <p className="text-gray-600 dark:text-gray-400 mb-6">Take a photo of your fridge or pantry ingredients and I'll suggest recipes you can make right now!</p>
                </div>
                
                <input
                  type="file"
                  accept="image/*"
                  capture="environment"
                  onChange={handleImageChange}
                  ref={fileInputRef}
                  className="hidden"
                />
                
                <button
                  onClick={() => fileInputRef.current?.click()}
                  className="w-full bg-gradient-to-r from-green-500 to-blue-500 text-white font-bold py-4 rounded-2xl shadow-lg hover:from-green-600 hover:to-blue-600 transition-all transform hover:scale-105"
                >
                  üì∑ Scan Ingredients
                </button>
                
                <div className="mt-6 p-4 bg-blue-50 dark:bg-blue-900/20 rounded-xl">
                  <h4 className="font-semibold text-blue-800 dark:text-blue-200 mb-2">üí° Pro Tips:</h4>
                  <ul className="text-sm text-blue-700 dark:text-blue-300 space-y-1">
                    <li>‚Ä¢ Ensure good lighting for best results</li>
                    <li>‚Ä¢ Include labels and packaging when visible</li>
                    <li>‚Ä¢ Multiple ingredients in one photo work great!</li>
                  </ul>
                </div>
              </div>
            </div>
          )}

          {imagePreview && (
            <div className="max-w-md mx-auto">
              <div className="bg-white dark:bg-gray-800 rounded-2xl shadow-md overflow-hidden">
                <img src={imagePreview} alt="Scanned ingredients" className="w-full h-64 object-cover" />
                
                {isLoading && (
                  <div className="p-6 text-center">
                    <div className="animate-spin w-8 h-8 border-4 border-pink-500 border-t-transparent rounded-full mx-auto mb-4"></div>
                    <p className="text-gray-600 dark:text-gray-400">
                      {!ingredients ? 'Identifying ingredients...' : 'Generating recipes...'}
                    </p>
                  </div>
                )}

                {error && (
                  <div className="p-6 text-center">
                    <p className="text-red-500 mb-4">{error}</p>
                    <button onClick={resetScan} className="bg-gray-500 text-white px-4 py-2 rounded-lg">
                      Try Again
                    </button>
                  </div>
                )}

                {ingredients && !recipes && !isLoading && (
                  <div className="p-6">
                    <h3 className="font-bold text-gray-800 dark:text-gray-200 mb-4">ü•ò Ingredients Found:</h3>
                    <div className="space-y-2 mb-6">
                      {ingredients.map((ingredient, index) => (
                        <div key={index} className="flex justify-between items-center p-2 bg-gray-50 dark:bg-gray-700 rounded-lg">
                          <span className="text-gray-800 dark:text-gray-200">{ingredient.name}</span>
                          <span className="text-sm text-gray-500 dark:text-gray-400">{ingredient.quantity}</span>
                        </div>
                      ))}
                    </div>
                    
                    <div className="space-y-3">
                      <button
                        onClick={generateRecipes}
                        className="w-full bg-green-500 text-white font-bold py-3 rounded-xl hover:bg-green-600 transition-colors"
                      >
                        üç≥ Get Recipe Ideas
                      </button>
                      
                      <button
                        onClick={resetScan}
                        className="w-full bg-gray-500 text-white font-bold py-2 rounded-xl hover:bg-gray-600 transition-colors"
                      >
                        üì∏ Scan Different Ingredients
                      </button>
                    </div>
                  </div>
                )}

                {recipes && (
                  <div className="p-6">
                    <div className="flex justify-between items-center mb-4">
                      <h3 className="font-bold text-gray-800 dark:text-gray-200">üçΩÔ∏è Recipe Suggestions</h3>
                      <button onClick={resetScan} className="text-pink-500 font-semibold text-sm">
                        ‚Üê New Scan
                      </button>
                    </div>
                    
                    <div className="space-y-4">
                      {recipes.map((recipe, index) => (
                        <RecipeCard key={index} recipe={recipe} />
                      ))}
                    </div>
                  </div>
                )}
              </div>
            </div>
          )}
        </div>
      );
    };

    // Recipe Card Component for Smart Pantry Chef
    const RecipeCard = ({ recipe }) => {
      const [isExpanded, setIsExpanded] = useState(false);
      
      return (
        <div className="border border-gray-200 dark:border-gray-700 rounded-xl overflow-hidden">
          <div className="p-4 bg-gradient-to-r from-green-50 to-blue-50 dark:from-green-900/20 dark:to-blue-900/20">
            <div className="flex justify-between items-start mb-2">
              <h4 className="font-bold text-gray-800 dark:text-gray-200">{recipe.name}</h4>
              <span className="text-sm bg-green-100 dark:bg-green-800 text-green-800 dark:text-green-200 px-2 py-1 rounded-full">
                {recipe.calories_per_serving} cal
              </span>
            </div>
            
            <div className="flex gap-4 text-sm text-gray-600 dark:text-gray-400 mb-3">
              <span>‚è±Ô∏è Prep: {recipe.prep_time}</span>
              <span>üî• Cook: {recipe.cook_time}</span>
              <span>üçΩÔ∏è Serves: {recipe.servings}</span>
            </div>
            
            <div className="mb-3">
              <p className="text-sm font-semibold text-gray-700 dark:text-gray-300 mb-1">Using your ingredients:</p>
              <div className="flex flex-wrap gap-1">
                {recipe.ingredients_used.map((ing, i) => (
                  <span key={i} className="text-xs bg-green-200 dark:bg-green-700 text-green-800 dark:text-green-200 px-2 py-1 rounded-full">
                    {ing}
                  </span>
                ))}
              </div>
            </div>
            
            {recipe.additional_needed && recipe.additional_needed.length > 0 && (
              <div className="mb-3">
                <p className="text-sm font-semibold text-gray-700 dark:text-gray-300 mb-1">You might need:</p>
                <div className="flex flex-wrap gap-1">
                  {recipe.additional_needed.map((item, i) => (
                    <span key={i} className="text-xs bg-yellow-200 dark:bg-yellow-700 text-yellow-800 dark:text-yellow-200 px-2 py-1 rounded-full">
                      {item}
                    </span>
                  ))}
                </div>
              </div>
            )}
            
            <button
              onClick={() => setIsExpanded(!isExpanded)}
              className="w-full bg-white dark:bg-gray-800 text-gray-800 dark:text-gray-200 font-semibold py-2 rounded-lg border border-gray-200 dark:border-gray-600 hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors"
            >
              {isExpanded ? '‚ñ≤ Hide Details' : '‚ñº View Recipe'}
            </button>
          </div>
          
          {isExpanded && (
            <div className="p-4 border-t border-gray-200 dark:border-gray-700">
              <div className="grid md:grid-cols-2 gap-4 mb-4">
                <div>
                  <h5 className="font-semibold text-gray-800 dark:text-gray-200 mb-2">Instructions:</h5>
                  <ol className="list-decimal list-inside text-sm text-gray-600 dark:text-gray-400 space-y-1">
                    {recipe.instructions.map((step, i) => (
                      <li key={i}>{step}</li>
                    ))}
                  </ol>
                </div>
                
                <div>
                  <h5 className="font-semibold text-gray-800 dark:text-gray-200 mb-2">Nutrition per serving:</h5>
                  <div className="text-sm text-gray-600 dark:text-gray-400 space-y-1">
                    <p>ü•© Protein: {recipe.nutrition.protein}g</p>
                    <p>üçû Carbs: {recipe.nutrition.carbs}g</p>
                    <p>ü•ë Fat: {recipe.nutrition.fat}g</p>
                  </div>
                </div>
              </div>
              
              {recipe.health_tip && (
                <div className="bg-blue-50 dark:bg-blue-900/20 p-3 rounded-lg">
                  <h5 className="font-semibold text-blue-800 dark:text-blue-200 mb-1">üí° Health Tip:</h5>
                  <p className="text-sm text-blue-700 dark:text-blue-300">{recipe.health_tip}</p>
                </div>
              )}
            </div>
          )}
        </div>
      );
    };

    // Meal Planner Screen Component
    const MealPlanner = ({ goals, mealPlan, setMealPlan, isLoading, setIsLoading, error, setError }) => {
      const [activeTab, setActiveTab] = useState('planner'); // 'planner', 'pantry', or 'menu'
      const [preferences, setPreferences] = useState({ cuisine: '', diet: '', calories: goals.calories, allergies: [] });

      const handlePreferenceChange = (key, value) => {
        setPreferences(prev => ({ ...prev, [key]: value }));
      };

      const handleAllergyChange = (allergy) => {
        setPreferences(prev => {
          const newAllergies = prev.allergies.includes(allergy)
            ? prev.allergies.filter(a => a !== allergy)
            : [...prev.allergies, allergy];
          return { ...prev, allergies: newAllergies };
        });
      };

      const generateMealPlan = async () => {
        setIsLoading(true);
        setError(null);
        setMealPlan(null);
        try {
          const prompt = `Create a one-day meal plan based on these preferences:
- Cuisine: ${preferences.cuisine || 'Any'}
- Diet: ${preferences.diet || 'Standard'}
- Calorie Target: ${preferences.calories} kcal
- Allergies: ${preferences.allergies.join(', ') || 'None'}
Provide a response as a valid JSON object with breakfast, lunch, and dinner. Each meal should have a name, ingredients list, and instructions. The total calories for the day should be approximately ${preferences.calories}.
Format:
{
  "breakfast": {"name": "...", "ingredients": ["..."], "instructions": ["..."]},
  "lunch": {"name": "...", "ingredients": ["..."], "instructions": ["..."]},
  "dinner": {"name": "...", "ingredients": ["..."], "instructions": ["..."]}
}`;

          const response = await fetch(NETLIFY_API_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ prompt: `Generate a short, motivational fitness quote for today. Keep it under 15 words and inspiring.` })
          });

          if (!response.ok) {
            throw new Error(`API Error: ${response.status} ${response.statusText}`);
          }

          const result = await response.json();
          const textResponse = result.candidates[0].content.parts[0].text || '';
          const jsonString = textResponse.replace(/```json|```/g, '').trim();
          const data = JSON.parse(jsonString);
          setMealPlan(data);
        } catch (err) {
          console.error("Meal plan generation failed:", err);
          setError("Could not generate a meal plan. Please try again.");
        } finally {
          setIsLoading(false);
        }
      };

      return (
        <div className="p-6 pb-24">
          <header className="mb-6 text-center">
            <h1 className="text-3xl font-bold text-gray-800 dark:text-gray-200">Meal Planning</h1>
            <p className="text-gray-500 dark:text-gray-400">Plan meals, use ingredients, or decode menus</p>
          </header>

          {/* Tab Navigation */}
          <div className="flex mb-6 bg-gray-100 dark:bg-gray-800 rounded-2xl p-1 max-w-lg mx-auto">
            <button
              onClick={() => setActiveTab('planner')}
              className={`flex-1 py-3 px-2 rounded-xl font-semibold transition-all text-sm ${
                activeTab === 'planner'
                  ? 'bg-white dark:bg-gray-700 text-gray-800 dark:text-gray-200 shadow-md'
                  : 'text-gray-600 dark:text-gray-400'
              }`}
            >
              üìã Planner
            </button>
            <button
              onClick={() => setActiveTab('pantry')}
              className={`flex-1 py-3 px-2 rounded-xl font-semibold transition-all text-sm ${
                activeTab === 'pantry'
                  ? 'bg-white dark:bg-gray-700 text-gray-800 dark:text-gray-200 shadow-md'
                  : 'text-gray-600 dark:text-gray-400'
              }`}
            >
              üßë‚Äçüç≥ Pantry
            </button>
            <button
              onClick={() => setActiveTab('menu')}
              className={`flex-1 py-3 px-2 rounded-xl font-semibold transition-all text-sm ${
                activeTab === 'menu'
                  ? 'bg-white dark:bg-gray-700 text-gray-800 dark:text-gray-200 shadow-md'
                  : 'text-gray-600 dark:text-gray-400'
              }`}
            >
              üçΩÔ∏è Menu
            </button>
          </div>

          {/* Tab Content */}
          {activeTab === 'planner' && (
            <div>
              {!mealPlan && (
                <div className="max-w-md mx-auto">
                  <div className="bg-white dark:bg-gray-800 p-6 rounded-2xl shadow-md space-y-4">
                    <div>
                      <h3 className="font-semibold mb-2 text-gray-800 dark:text-gray-200">Cuisine Type</h3>
                      <div className="grid grid-cols-2 sm:grid-cols-3 gap-2">
                        {['International', 'Indian', 'Mediterranean', 'Asian', 'Mexican', 'Italian'].map(c => (
                          <button
                            key={c}
                            onClick={() => handlePreferenceChange('cuisine', c)}
                            className={`p-2 rounded-lg border dark:border-gray-700 text-xs sm:text-sm font-medium min-h-[2.5rem] flex items-center justify-center ${
                              preferences.cuisine === c ? 'bg-pink-500 text-white' : 'bg-gray-100 dark:bg-gray-700 text-gray-800 dark:text-gray-200'
                            }`}
                          >
                            <span className="text-center leading-tight">{c}</span>
                          </button>
                        ))}
                      </div>
                    </div>

                    <div>
                      <h3 className="font-semibold mb-2 text-gray-800 dark:text-gray-200">Diet Type</h3>
                      <div className="grid grid-cols-3 gap-2">
                        {['Veg', 'Non-Veg', 'Vegan'].map(d => (
                          <button
                            key={d}
                            onClick={() => handlePreferenceChange('diet', d)}
                            className={`p-2 rounded-lg border dark:border-gray-700 ${preferences.diet === d ? 'bg-pink-500 text-white' : 'bg-gray-100 dark:bg-gray-700 text-gray-800 dark:text-gray-200'}`}
                          >
                            {d}
                          </button>
                        ))}
                      </div>
                    </div>

                    <div>
                      <h3 className="font-semibold mb-2 text-gray-800 dark:text-gray-200">Daily Calorie Target: {preferences.calories} kcal</h3>
                      <input type="range" min="1200" max="4000" step="50" value={preferences.calories} onChange={e => handlePreferenceChange('calories', e.target.value)} className="w-full" />
                    </div>

                    <div>
                      <h3 className="font-semibold mb-2 text-gray-800 dark:text-gray-200">Allergies & Restrictions</h3>
                      <div className="grid grid-cols-3 gap-2">
                        {['Nuts', 'Dairy', 'Gluten', 'Eggs', 'Seafood', 'Soy'].map(a => (
                          <button
                            key={a}
                            onClick={() => handleAllergyChange(a)}
                            className={`p-2 rounded-lg border dark:border-gray-700 ${preferences.allergies.includes(a) ? 'bg-pink-500 text-white' : 'bg-gray-100 dark:bg-gray-700 text-gray-800 dark:text-gray-200'}`}
                          >
                            {a}
                          </button>
                        ))}
                      </div>
                    </div>
                  </div>

                  <button
                    onClick={generateMealPlan}
                    disabled={isLoading}
                    className="w-full mt-6 bg-green-500 text-white font-bold py-4 rounded-2xl shadow-lg hover:bg-green-600 transition-colors disabled:bg-gray-400"
                  >
                    {isLoading ? 'Generating...' : 'Generate Meal Plan'}
                  </button>

                  {error && <div className="mt-4 text-center text-red-500">{error}</div>}
                </div>
              )}

              {mealPlan && (
                <div className="animate-fade-in">
                  <button onClick={() => setMealPlan(null)} className="mb-4 text-pink-500 font-semibold">&larr; Back to Preferences</button>
                  <div className="space-y-6">
                    <MealPlanDisplay mealType="Breakfast" meal={mealPlan.breakfast} />
                    <MealPlanDisplay mealType="Lunch" meal={mealPlan.lunch} />
                    <MealPlanDisplay mealType="Dinner" meal={mealPlan.dinner} />
                  </div>
                  
                  {/* Download Button */}
                  <button
                    onClick={() => {
                      // Format meal plan for PDF
                      const title = "Your Personalized Meal Plan";
                      let content = "";
                      
                      // Add meal plan details
                      content += "BREAKFAST\n";
                      content += `${mealPlan.breakfast.name}\n\n`;
                      content += "Ingredients:\n";
                      mealPlan.breakfast.ingredients.forEach(ing => {
                        content += `- ${ing}\n`;
                      });
                      content += "\nInstructions:\n";
                      mealPlan.breakfast.instructions.forEach((inst, i) => {
                        content += `${i+1}. ${inst}\n`;
                      });
                      
                      content += "\n\nLUNCH\n";
                      content += `${mealPlan.lunch.name}\n\n`;
                      content += "Ingredients:\n";
                      mealPlan.lunch.ingredients.forEach(ing => {
                        content += `- ${ing}\n`;
                      });
                      content += "\nInstructions:\n";
                      mealPlan.lunch.instructions.forEach((inst, i) => {
                        content += `${i+1}. ${inst}\n`;
                      });
                      
                      content += "\n\nDINNER\n";
                      content += `${mealPlan.dinner.name}\n\n`;
                      content += "Ingredients:\n";
                      mealPlan.dinner.ingredients.forEach(ing => {
                        content += `- ${ing}\n`;
                      });
                      content += "\nInstructions:\n";
                      mealPlan.dinner.instructions.forEach((inst, i) => {
                        content += `${i+1}. ${inst}\n`;
                      });
                      
                      // Generate and download PDF
                      generatePDF(title, content, "meal-plan.pdf");
                    }}
                    className="mt-6 mx-auto block bg-pink-500 text-white font-bold py-3 px-6 rounded-xl shadow-lg hover:bg-pink-600 transition-colors"
                  >
                    üì• Download Meal Plan PDF
                  </button>
                </div>
              )}
            </div>
          )}

          {activeTab === 'pantry' && (
            <SmartPantryChef goals={goals} />
          )}

          {activeTab === 'menu' && (
            <MenuDecoder goals={goals} />
          )}
        </div>
      );
    };

    // AI Workout Form Coach Component
    const WorkoutFormCoach = () => {
      const [videoPreview, setVideoPreview] = useState(null);
      const [isRecording, setIsRecording] = useState(false);
      const [isLoading, setIsLoading] = useState(false);
      const [formAnalysis, setFormAnalysis] = useState(null);
      const [error, setError] = useState(null);
      const [selectedExercise, setSelectedExercise] = useState('squat');
      const [mediaRecorder, setMediaRecorder] = useState(null);
      const [recordedChunks, setRecordedChunks] = useState([]);
      const [recordingTime, setRecordingTime] = useState(0);
      const videoRef = useRef(null);
      const fileInputRef = useRef(null);
      const recordingTimerRef = useRef(null);

      const exercises = [
      // Strength Training - Upper Body
      { id: 'pushup', name: 'üí™ Push-up', tips: 'Maintain straight line from head to heels, lower chest to ground' },
      { id: 'pullup', name: 'üî• Pull-up', tips: 'Full range of motion, control the movement, engage lats' },
      { id: 'dips', name: 'üí∫ Dips', tips: 'Lower until shoulders below elbows, push up with control' },
      { id: 'overhead_press', name: 'üèãÔ∏è Overhead Press', tips: 'Press straight up, keep core tight, full lockout' },
      { id: 'bench_press', name: 'üèãÔ∏è‚Äç‚ôÇÔ∏è Bench Press', tips: 'Lower bar to chest, press up explosively, maintain arch' },
      { id: 'rows', name: 'üö£ Bent-Over Row', tips: 'Hinge at hips, pull to lower chest, squeeze shoulder blades' },
      
      // Strength Training - Lower Body
      { id: 'squat', name: 'üèãÔ∏è Squat', tips: 'Keep back straight, knees track over toes, hip hinge' },
      { id: 'deadlift', name: 'üèãÔ∏è‚Äç‚ôÄÔ∏è Deadlift', tips: 'Hinge at hips, keep bar close to body, drive through heels' },
      { id: 'lunge', name: 'ü¶µ Lunge', tips: 'Step forward, lower back knee toward ground, push back up' },
      { id: 'bulgarian_split_squat', name: 'ü¶µ Bulgarian Split Squat', tips: 'Rear foot elevated, lower into lunge, drive through front heel' },
      { id: 'hip_thrust', name: 'üçë Hip Thrust', tips: 'Squeeze glutes at top, maintain neutral spine, full hip extension' },
      { id: 'calf_raise', name: 'ü¶µ Calf Raise', tips: 'Rise onto toes, pause at top, control the descent' },
      
      // Core & Stability
      { id: 'plank', name: 'ü§∏ Plank', tips: 'Engage core, avoid sagging or arching, breathe normally' },
      { id: 'side_plank', name: 'ü§∏‚Äç‚ôÄÔ∏è Side Plank', tips: 'Stack shoulders and hips, lift hips up, hold straight line' },
      { id: 'mountain_climbers', name: '‚õ∞Ô∏è Mountain Climbers', tips: 'Keep hips level, drive knees to chest, maintain plank position' },
      { id: 'russian_twists', name: 'üå™Ô∏è Russian Twists', tips: 'Lean back slightly, rotate torso, keep feet off ground' },
      { id: 'bicycle_crunches', name: 'üö¥ Bicycle Crunches', tips: 'Bring opposite elbow to knee, extend other leg, control movement' },
      { id: 'dead_bug', name: 'üêõ Dead Bug', tips: 'Keep lower back pressed down, move opposite arm and leg' },
      
      // Cardio & Conditioning
      { id: 'burpees', name: 'üí• Burpees', tips: 'Jump back to plank, push-up, jump forward, jump up with arms overhead' },
      { id: 'jumping_jacks', name: 'ü§∏‚Äç‚ôÇÔ∏è Jumping Jacks', tips: 'Jump feet apart while raising arms, return to start position' },
      { id: 'high_knees', name: 'üèÉ‚Äç‚ôÄÔ∏è High Knees', tips: 'Drive knees up to waist level, pump arms, stay on balls of feet' },
      { id: 'butt_kicks', name: 'ü¶µ Butt Kicks', tips: 'Kick heels to glutes, keep knees pointing down, quick tempo' },
      { id: 'jump_squats', name: 'ü¶ò Jump Squats', tips: 'Squat down, explode up into jump, land softly, repeat' },
      
      // Functional Movement
      { id: 'bear_crawl', name: 'üêª Bear Crawl', tips: 'Keep knees just off ground, move opposite hand and foot together' },
      { id: 'crab_walk', name: 'ü¶Ä Crab Walk', tips: 'Keep hips up, move opposite hand and foot, face up' },
      { id: 'turkish_getup', name: 'üáπüá∑ Turkish Get-up', tips: 'Slow controlled movement, keep weight overhead, step by step' },
      { id: 'farmers_walk', name: 'üöú Farmer\'s Walk', tips: 'Keep shoulders back, core tight, walk with heavy weights' },
      
      // Flexibility & Mobility
      { id: 'downward_dog', name: 'üßò‚Äç‚ôÄÔ∏è Downward Dog', tips: 'Form inverted V, press hands down, lengthen spine' },
      { id: 'cat_cow', name: 'üê±üêÑ Cat-Cow Stretch', tips: 'Arch and round spine slowly, coordinate with breathing' },
      { id: 'pigeon_pose', name: 'üïäÔ∏è Pigeon Pose', tips: 'Hip opener, keep front knee at 90 degrees, square hips' },
      { id: 'child_pose', name: 'üßò Child\'s Pose', tips: 'Sit back on heels, reach arms forward, relax and breathe' },
      
      // Olympic Lifts (Advanced)
      { id: 'clean_and_press', name: 'üèãÔ∏è‚Äç‚ôÄÔ∏è Clean & Press', tips: 'Explosive hip drive, catch in front rack, press overhead' },
      { id: 'snatch', name: 'üèãÔ∏è Snatch', tips: 'Wide grip, explosive pull, catch overhead in squat position' },
      { id: 'clean_and_jerk', name: 'üèãÔ∏è‚Äç‚ôÇÔ∏è Clean & Jerk', tips: 'Clean to front rack, dip and drive, split or squat jerk' }
    ];

      const resetAnalysis = () => {
        setVideoPreview(null);
        setFormAnalysis(null);
        setError(null);
        setRecordedChunks([]);
        setRecordingTime(0);
        if (recordingTimerRef.current) {
          clearInterval(recordingTimerRef.current);
        }
      };

      const startCamera = async () => {
        try {
          const stream = await navigator.mediaDevices.getUserMedia({ 
            video: { facingMode: 'user' }, 
            audio: false 
          });
          if (videoRef.current) {
            videoRef.current.srcObject = stream;
          }
        } catch (err) {
          console.error('Camera access failed:', err);
          setError('Camera access denied. Please use file upload instead.');
        }
      };

      const startRecording = async () => {
        try {
          const stream = await navigator.mediaDevices.getUserMedia({ 
            video: { facingMode: 'user' }, 
            audio: false 
          });
          
          setIsRecording(true);
          
          // Wait for the video element to be rendered, then set the stream
          setTimeout(async () => {
            if (videoRef.current) {
              videoRef.current.srcObject = stream;
              try {
                await videoRef.current.play();
                console.log('Video preview started successfully');
              } catch (playError) {
                console.error('Video play failed:', playError);
              }
            }
          }, 100);
          
          const recorder = new MediaRecorder(stream);
          const chunks = [];
          
          recorder.ondataavailable = (event) => {
            if (event.data.size > 0) {
              chunks.push(event.data);
            }
          };
          
          recorder.onstop = () => {
            const blob = new Blob(chunks, { type: 'video/webm' });
            const videoUrl = URL.createObjectURL(blob);
            setVideoPreview(videoUrl);
            setRecordedChunks(chunks);
            stream.getTracks().forEach(track => track.stop());
            // Clear live preview
            if (videoRef.current) {
              videoRef.current.srcObject = null;
            }
            clearInterval(recordingTimerRef.current);
            analyzeForm(blob);
          };
          
          setMediaRecorder(recorder);
          recorder.start();
          
          // Start 10-second timer
          let timeLeft = 10;
          setRecordingTime(timeLeft);
          recordingTimerRef.current = setInterval(() => {
            timeLeft--;
            setRecordingTime(timeLeft);
            if (timeLeft <= 0) {
              stopRecording();
            }
          }, 1000);
          
        } catch (err) {
          console.error('Recording failed:', err);
          setError('Recording failed. Please try file upload instead.');
          setIsRecording(false);
        }
      };

      const stopRecording = () => {
        if (mediaRecorder && mediaRecorder.state === 'recording') {
          mediaRecorder.stop();
          setIsRecording(false);
          clearInterval(recordingTimerRef.current);
        }
      };

      const handleVideoUpload = (e) => {
        const file = e.target.files[0];
        if (file) {
          const videoUrl = URL.createObjectURL(file);
          setVideoPreview(videoUrl);
          setFormAnalysis(null);
          setError(null);
          analyzeForm(file);
        }
      };

      const analyzeForm = async (videoBlob) => {
        setIsLoading(true);
        setError(null);
        
        try {
          // For video analysis, we'll extract a frame and analyze it
          const canvas = document.createElement('canvas');
          const video = document.createElement('video');
          
          // Add timeout promise to prevent hanging
          const timeoutPromise = new Promise((_, reject) => {
            setTimeout(() => reject(new Error('Video processing timeout')), 30000);
          });
          
          const processVideo = new Promise((resolve, reject) => {
            video.src = URL.createObjectURL(videoBlob);
            video.muted = true; // Ensure video can play
            
            video.onloadedmetadata = async () => {
              try {
                console.log('Video metadata loaded:', {
                  duration: video.duration,
                  width: video.videoWidth,
                  height: video.videoHeight
                });
                
                // Validate video dimensions
                if (!video.videoWidth || !video.videoHeight) {
                  throw new Error('Invalid video dimensions');
                }
                
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                
                // Seek to middle of video for analysis
                const seekTime = Math.min(video.duration / 2, 5); // Max 5 seconds in
                video.currentTime = seekTime;
                
                video.onseeked = async () => {
                  try {
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(video, 0, 0);
                    
                    // Validate canvas has content
                    const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                    const hasContent = imageData.data.some(pixel => pixel !== 0);
                    
                    if (!hasContent) {
                      throw new Error('Failed to capture video frame');
                    }
                    
                    // Convert canvas to base64
                    const base64ImageData = canvas.toDataURL('image/jpeg', 0.8).split(',')[1];
                    
                    if (!base64ImageData) {
                      throw new Error('Failed to convert image to base64');
                    }
                    
                    const selectedExerciseData = exercises.find(ex => ex.id === selectedExercise);
                    
                    if (!selectedExerciseData) {
                      throw new Error('No exercise selected');
                    }
                    
                    console.log('Sending analysis request for:', selectedExerciseData.name);
                    
                    const prompt = `Analyze this image of someone performing a ${selectedExerciseData.name} exercise.

Even if the exercise is not clearly visible or the person is not performing the expected exercise, provide constructive feedback.

Provide detailed form analysis and feedback. Focus on:
1. Body alignment and posture (if visible)
2. Joint positioning and angles (if visible) 
3. Common mistakes to avoid
4. Specific improvements for better form
5. Safety considerations

If the exercise is not clearly visible, focus on video recording tips and general exercise guidance.

Respond ONLY with a valid JSON object in this format:
{
  "exercise_detected": "${selectedExerciseData.name}",
  "overall_score": 1-10,
  "form_analysis": {
    "posture": "Analysis of overall posture and alignment or recording feedback",
    "technique": "Assessment of exercise technique or guidance for better recording",
    "safety": "Safety considerations and injury prevention"
  },
  "feedback": {
    "positive_points": ["What they're doing well or encouraging notes"],
    "improvements": ["Specific areas to improve or recording suggestions"],
    "tips": ["Actionable tips for better form or video recording"]
  },
  "next_steps": "Recommendations for progression, modification, or re-recording"
}`;

                    const payload = {
                      contents: [
                        {
                          parts: [
                            { text: prompt },
                            { inlineData: { mimeType: 'image/jpeg', data: base64ImageData } }
                          ]
                        }
                      ],
                    };

                    const response = await fetch(NETLIFY_API_URL, {
                      method: 'POST',
                      headers: { 'Content-Type': 'application/json' },
                      body: JSON.stringify({ contents: payload.contents })
                    });

                    if (!response.ok) {
                      const errorText = await response.text();
                      console.error('API Error Response:', errorText);
                      throw new Error(`API Error: ${response.status} ${response.statusText}`);
                    }

                    const result = await response.json();
                    console.log('API Response:', result);
                    
                    if (!result.candidates || !result.candidates[0] || !result.candidates[0].content) {
                      throw new Error('Invalid API response format');
                    }
                    
                    const textResponse = result.candidates[0].content.parts[0].text || '';
                    console.log('Raw AI Response:', textResponse);
                    
                    // Clean and parse JSON response
                    let jsonString = textResponse.replace(/```json|```/g, '').trim();
                    
                    // Handle potential markdown formatting
                    if (jsonString.includes('```')) {
                      const jsonMatch = jsonString.match(/```(?:json)?\s*({[\s\S]*?})\s*```/);
                      if (jsonMatch) {
                        jsonString = jsonMatch[1];
                      }
                    }
                    
                    // Find JSON object if wrapped in text
                    const jsonMatch = jsonString.match(/{[\s\S]*}/);
                    if (jsonMatch) {
                      jsonString = jsonMatch[0];
                    }
                    
                    console.log('Parsed JSON String:', jsonString);
                    
                    const data = JSON.parse(jsonString);
                    
                    // Updated validation - more flexible for "no exercise detected" cases
                    if (!data.overall_score && data.overall_score !== 0) {
                      // If no score provided, set a default low score
                      data.overall_score = 3;
                    }

                    // Ensure form_analysis exists with defaults
                    if (!data.form_analysis) {
                      data.form_analysis = {
                        posture: data.posture || "Unable to analyze posture from this video.",
                        technique: data.technique || "Unable to assess technique from this video.", 
                        safety: data.safety || "Please ensure proper form and safety when exercising."
                      };
                    }

                    // Ensure feedback exists with defaults
                    if (!data.feedback) {
                      data.feedback = {
                        positive_points: data.positive_points || [],
                        improvements: data.improvements || ["Please record a clearer video showing the full exercise movement"],
                        tips: data.tips || ["Ensure good lighting and clear view of your full body", "Record from a side or slightly angled perspective"]
                      };
                    }

                    // Handle "No [Exercise] Detected" cases
                    if (data.exercise_detected && data.exercise_detected.toLowerCase().includes('no ') && data.exercise_detected.toLowerCase().includes('detected')) {
                      const selectedExerciseData = exercises.find(ex => ex.id === selectedExercise);
                      data.exercise_detected = selectedExerciseData ? selectedExerciseData.name : 'Exercise';
                      data.overall_score = 2; // Low score for undetected exercise
                      
                      // Provide helpful feedback for undetected exercises
                      data.feedback.improvements = [
                        "The selected exercise was not clearly visible in the video",
                        "Please ensure your full body is visible in the frame", 
                        "Record from a side angle for better form analysis",
                        "Make sure lighting is adequate and background is clear"
                      ];
                      
                      data.feedback.tips = [
                        "Position camera 6-8 feet away to capture full body",
                        "Use good lighting - avoid backlighting",
                        "Perform the exercise slowly and with full range of motion",
                        "Ensure the camera is stable and at chest height"
                      ];
                      
                      data.next_steps = "Please re-record the video with better positioning and lighting for accurate form analysis.";
                    }

                    // Ensure next_steps exists
                    if (!data.next_steps) {
                      data.next_steps = "Continue practicing with proper form and consider recording from different angles for comprehensive analysis.";
                    }
                    
                    console.log('Analysis completed successfully:', data);
                    setFormAnalysis(data);
                    resolve(data);
                    
                  } catch (seekError) {
                    console.error('Seek error:', seekError);
                    reject(seekError);
                  }
                };
                
                video.onerror = (e) => {
                  console.error('Video seek error:', e);
                  reject(new Error('Failed to seek video'));
                };
                
              } catch (metadataError) {
                console.error('Metadata error:', metadataError);
                reject(metadataError);
              }
            };
            
            video.onerror = (e) => {
              console.error('Video load error:', e);
              reject(new Error('Failed to load video'));
            };
            
            // Ensure video loads
            video.load();
          });
          
          // Race between processing and timeout
          await Promise.race([processVideo, timeoutPromise]);
          
        } catch (err) {
          console.error('Form analysis failed:', err);
          
          // Provide specific error messages
          let errorMessage = 'Could not analyze form. ';
          
          if (err.message.includes('timeout')) {
            errorMessage += 'Video processing timed out. Please try a shorter video.';
          } else if (err.message.includes('dimensions')) {
            errorMessage += 'Invalid video format. Please record a new video.';
          } else if (err.message.includes('API Error')) {
            errorMessage += 'Analysis service unavailable. Please try again later.';
          } else if (err.message.includes('JSON')) {
            errorMessage += 'Analysis failed to complete. Please try again.';
          } else {
            errorMessage += 'Please try again with a clearer video.';
          }
          
          setError(errorMessage);
        } finally {
          setIsLoading(false);
        }
      };

      return (
        <div className="p-6 pb-24">
          <header className="mb-6 text-center">
            <h1 className="text-3xl font-bold text-gray-800 dark:text-gray-200">üèãÔ∏è AI Form Coach</h1>
            <p className="text-gray-500 dark:text-gray-400">Perfect your technique with AI feedback</p>
          </header>

          {!videoPreview && (
            <div className="max-w-md mx-auto">
              {/* Exercise Selection */}
              <div className="bg-white dark:bg-gray-800 p-4 rounded-2xl shadow-md mb-4">
                <h3 className="font-semibold text-gray-800 dark:text-gray-200 mb-3">Select Exercise:</h3>
                <div className="grid grid-cols-2 gap-2">
                  {exercises.map(exercise => (
                    <button
                      key={exercise.id}
                      onClick={() => setSelectedExercise(exercise.id)}
                      className={`p-3 rounded-lg border text-sm ${
                        selectedExercise === exercise.id
                          ? 'bg-purple-500 text-white border-purple-500'
                          : 'bg-gray-100 dark:bg-gray-700 text-gray-800 dark:text-gray-200 border-gray-300 dark:border-gray-600'
                      }`}
                    >
                      {exercise.name}
                    </button>
                  ))}
                </div>
                {selectedExercise && (
                  <div className="mt-3 p-3 bg-purple-50 dark:bg-purple-900/20 rounded-lg">
                    <p className="text-sm text-purple-700 dark:text-purple-300">
                      üí° {exercises.find(ex => ex.id === selectedExercise)?.tips}
                    </p>
                  </div>
                )}
              </div>

              <div className="bg-white dark:bg-gray-800 p-8 rounded-2xl shadow-md text-center">
                <div className="mb-6">
                  <div className="w-24 h-24 mx-auto mb-4 bg-gradient-to-br from-purple-400 to-pink-500 rounded-full flex items-center justify-center">
                    <span className="text-4xl">üé•</span>
                  </div>
                  <h3 className="text-xl font-bold text-gray-800 dark:text-gray-200 mb-2">Record Your Form</h3>
                  <p className="text-gray-600 dark:text-gray-400 mb-6">Record a short video of your exercise and get instant AI feedback on your form!</p>
                </div>
                
                {/* Recording Controls */}
                <div className="space-y-4">
                  {/* Live Camera Preview */}
                  {isRecording && (
                    <div className="mb-4">
                      <video
                        ref={videoRef}
                        autoPlay
                        muted
                        playsInline
                        className="w-full h-64 object-cover rounded-2xl bg-gray-200 dark:bg-gray-700"
                        style={{ transform: 'scaleX(-1)' }}
                        onLoadedMetadata={() => console.log('Video metadata loaded')}
                        onCanPlay={() => console.log('Video can play')}
                        onError={(e) => console.error('Video error:', e)}
                      />
                      <p className="text-center text-sm text-gray-600 dark:text-gray-400 mt-2">
                        Recording in progress... {recordingTime}s
                      </p>
                    </div>
                  )}
                  
                  {!isRecording ? (
                    <button
                      onClick={startRecording}
                      className="w-full bg-gradient-to-r from-purple-500 to-pink-500 text-white font-bold py-4 rounded-2xl shadow-lg hover:from-purple-600 hover:to-pink-600 transition-all transform hover:scale-105"
                    >
                      üé• Start Recording (10s)
                    </button>
                  ) : (
                    <button
                      onClick={stopRecording}
                      className="w-full bg-red-500 text-white font-bold py-4 rounded-2xl shadow-lg hover:bg-red-600 transition-all"
                    >
                      ‚èπÔ∏è Stop Recording
                    </button>
                  )}
                  
                  <div className="text-gray-500 dark:text-gray-400">or</div>
                  
                  <input
                    type="file"
                    accept="video/*"
                    onChange={handleVideoUpload}
                    ref={fileInputRef}
                    className="hidden"
                  />
                  
                  <button
                    onClick={() => fileInputRef.current?.click()}
                    className="w-full bg-gray-500 text-white font-bold py-3 rounded-2xl shadow-lg hover:bg-gray-600 transition-all"
                  >
                    üìÅ Upload Video
                  </button>
                </div>
                
                <div className="mt-6 p-4 bg-purple-50 dark:bg-purple-900/20 rounded-xl">
                  <h4 className="font-semibold text-purple-800 dark:text-purple-200 mb-2">üìã Recording Tips:</h4>
                  <ul className="text-sm text-purple-700 dark:text-purple-300 space-y-1">
                    <li>‚Ä¢ Position camera to show full body</li>
                    <li>‚Ä¢ Perform 2-3 reps of the exercise</li>
                    <li>‚Ä¢ Ensure good lighting and clear view</li>
                    <li>‚Ä¢ Keep movements slow and controlled</li>
                  </ul>
                </div>
              </div>
            </div>
          )}

          {videoPreview && (
            <div className="max-w-md mx-auto">
              <div className="bg-white dark:bg-gray-800 rounded-2xl shadow-md overflow-hidden">
                <video 
                  src={videoPreview} 
                  controls 
                  className="w-full h-64 object-cover"
                  poster="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='100' height='100'%3E%3Crect width='100' height='100' fill='%23f3f4f6'/%3E%3Ctext x='50%25' y='50%25' text-anchor='middle' dy='.3em' fill='%236b7280'%3EVideo%3C/text%3E%3C/svg%3E"
                />
                
                {isLoading && (
                  <div className="p-6 text-center">
                    <div className="animate-spin w-8 h-8 border-4 border-purple-500 border-t-transparent rounded-full mx-auto mb-4"></div>
                    <p className="text-gray-600 dark:text-gray-400">Analyzing your form...</p>
                  </div>
                )}

                {error && (
                  <div className="p-6 text-center">
                    <p className="text-red-500 mb-4">{error}</p>
                    <button onClick={resetAnalysis} className="bg-gray-500 text-white px-4 py-2 rounded-lg">
                      Try Again
                    </button>
                  </div>
                )}

                {formAnalysis && (
                  <div className="p-6">
                    <div className="flex justify-between items-center mb-4">
                      <h3 className="font-bold text-gray-800 dark:text-gray-200">üéØ Form Analysis</h3>
                      <button onClick={resetAnalysis} className="text-purple-500 font-semibold text-sm">
                        ‚Üê New Video
                      </button>
                    </div>
                    
                    {/* Overall Score */}
                    <div className="mb-6 text-center">
                      <div className={`inline-flex items-center justify-center w-20 h-20 rounded-full text-2xl font-bold ${
                        formAnalysis.overall_score >= 8 ? 'bg-green-100 text-green-600 dark:bg-green-900/20 dark:text-green-400' :
                        formAnalysis.overall_score >= 6 ? 'bg-yellow-100 text-yellow-600 dark:bg-yellow-900/20 dark:text-yellow-400' :
                        'bg-red-100 text-red-600 dark:bg-red-900/20 dark:text-red-400'
                      }`}>
                        {formAnalysis.overall_score}/10
                      </div>
                      <p className="text-sm text-gray-600 dark:text-gray-400 mt-2">Form Score</p>
                    </div>

                    {/* Form Analysis */}
                    <div className="space-y-4 mb-6">
                      <div className="bg-blue-50 dark:bg-blue-900/20 p-4 rounded-lg">
                        <h4 className="font-semibold text-blue-800 dark:text-blue-200 mb-2">üìê Posture Analysis</h4>
                        <p className="text-sm text-blue-700 dark:text-blue-300">{formAnalysis.form_analysis.posture}</p>
                      </div>
                      
                      <div className="bg-purple-50 dark:bg-purple-900/20 p-4 rounded-lg">
                        <h4 className="font-semibold text-purple-800 dark:text-purple-200 mb-2">‚ö° Technique</h4>
                        <p className="text-sm text-purple-700 dark:text-purple-300">{formAnalysis.form_analysis.technique}</p>
                      </div>
                      
                      <div className="bg-orange-50 dark:bg-orange-900/20 p-4 rounded-lg">
                        <h4 className="font-semibold text-orange-800 dark:text-orange-200 mb-2">üõ°Ô∏è Safety</h4>
                        <p className="text-sm text-orange-700 dark:text-orange-300">{formAnalysis.form_analysis.safety}</p>
                      </div>
                    </div>

                    {/* Positive Feedback */}
                    {formAnalysis.feedback.positive_points && formAnalysis.feedback.positive_points.length > 0 && (
                      <div className="mb-4">
                        <h4 className="font-semibold text-green-600 dark:text-green-400 mb-2">‚úÖ What You're Doing Well:</h4>
                        <ul className="space-y-1">
                          {formAnalysis.feedback.positive_points.map((point, index) => (
                            <li key={index} className="text-sm text-gray-600 dark:text-gray-400 flex items-start">
                              <span className="text-green-500 mr-2">‚Ä¢</span>
                              {point}
                            </li>
                          ))}
                        </ul>
                      </div>
                    )}

                    {/* Improvements */}
                    {formAnalysis.feedback.improvements && formAnalysis.feedback.improvements.length > 0 && (
                      <div className="mb-4">
                        <h4 className="font-semibold text-yellow-600 dark:text-yellow-400 mb-2">üéØ Areas to Improve:</h4>
                        <ul className="space-y-1">
                          {formAnalysis.feedback.improvements.map((improvement, index) => (
                            <li key={index} className="text-sm text-gray-600 dark:text-gray-400 flex items-start">
                              <span className="text-yellow-500 mr-2">‚Ä¢</span>
                              {improvement}
                            </li>
                          ))}
                        </ul>
                      </div>
                    )}

                    {/* Tips */}
                    {formAnalysis.feedback.tips && formAnalysis.feedback.tips.length > 0 && (
                      <div className="mb-4">
                        <h4 className="font-semibold text-purple-600 dark:text-purple-400 mb-2">üí° Pro Tips:</h4>
                        <ul className="space-y-1">
                          {formAnalysis.feedback.tips.map((tip, index) => (
                            <li key={index} className="text-sm text-gray-600 dark:text-gray-400 flex items-start">
                              <span className="text-purple-500 mr-2">‚Ä¢</span>
                              {tip}
                            </li>
                          ))}
                        </ul>
                      </div>
                    )}

                    {/* Next Steps */}
                    {formAnalysis.next_steps && (
                      <div className="bg-gray-50 dark:bg-gray-700 p-4 rounded-lg">
                        <h4 className="font-semibold text-gray-800 dark:text-gray-200 mb-2">üöÄ Next Steps:</h4>
                        <p className="text-sm text-gray-600 dark:text-gray-400">{formAnalysis.next_steps}</p>
                      </div>
                    )}
                  </div>
                )}
              </div>
            </div>
          )}
        </div>
      );
    };

    // Workout Planner Screen Component
    const WorkoutPlanner = ({ workoutPlan, setWorkoutPlan, isLoading, setIsLoading, error, setError }) => {
      const [activeTab, setActiveTab] = useState('planner'); // 'planner' or 'coach'
      const [preferences, setPreferences] = useState({ goal: '', type: '', level: '', equipment: [] });

      const handlePreferenceChange = (key, value) => {
        setPreferences(prev => ({ ...prev, [key]: value }));
      };

      const handleEquipmentChange = (item) => {
        setPreferences(prev => {
          const newEquipment = prev.equipment.includes(item)
            ? prev.equipment.filter(e => e !== item)
            : [...prev.equipment, item];
          return { ...prev, equipment: newEquipment };
        });
      };

      const generateWorkoutPlan = async () => {
        setIsLoading(true);
        setError(null);
        setWorkoutPlan(null);
        try {
          const prompt = `Create a workout plan based on these user preferences:
- Fitness Goal: ${preferences.goal || 'General Fitness'}
- Workout Type: ${preferences.type || 'Full Body'}
- Experience Level: ${preferences.level || 'Beginner'}
- Available Equipment: ${preferences.equipment.join(', ') || 'None (Bodyweight)'}
Provide a response as a valid JSON object. The plan should have a name and a list of exercises. Each exercise must include a name, sets, reps, and instructions.
Format:
{
  "plan_name": "Personalized Workout Plan Name",
  "exercises": [
    {"name": "...", "sets": "...", "reps": "...", "instructions": "..."},
    {"name": "...", "sets": "...", "reps": "...", "instructions": "..."}
  ]
}`;

          const response = await fetch(NETLIFY_API_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ prompt })
          });

          if (!response.ok) {
            throw new Error(`API Error: ${response.status} ${response.statusText}`);
          }

          const result = await response.json();
          const textResponse = result.candidates[0].content.parts[0].text || '';
          const jsonString = textResponse.replace(/```json|```/g, '').trim();
          const data = JSON.parse(jsonString);
          setWorkoutPlan(data);
        } catch (err) {
          console.error("Workout plan generation failed:", err);
          setError("Could not generate a workout plan. Please try again.");
        } finally {
          setIsLoading(false);
        }
      };

      return (
        <div className="p-6 pb-24">
          <header className="mb-6 text-center">
            <h1 className="text-3xl font-bold text-gray-800 dark:text-gray-200">Workout Hub</h1>
            <p className="text-gray-500 dark:text-gray-400">Plan workouts or perfect your form</p>
          </header>

          {/* Tab Navigation - Fixed light gradients */}
          <div className="flex mb-6 bg-gray-100 dark:bg-gray-800 rounded-2xl p-1 max-w-md mx-auto">
            <button
              onClick={() => setActiveTab('planner')}
              className={`flex-1 py-3 px-4 rounded-xl font-semibold transition-all ${
                activeTab === 'planner'
                  ? 'bg-white dark:bg-gray-700 text-gray-800 dark:text-gray-200 shadow-md'
                  : 'text-gray-600 dark:text-gray-400'
              }`}
            >
              üìã Planner
            </button>
            <button
              onClick={() => setActiveTab('coach')}
              className={`flex-1 py-3 px-4 rounded-xl font-semibold transition-all ${
                activeTab === 'coach'
                  ? 'bg-white dark:bg-gray-700 text-gray-800 dark:text-gray-200 shadow-md'
                  : 'text-gray-600 dark:text-gray-400'
              }`}
            >
              üèãÔ∏è Form Coach
            </button>
          </div>

          {/* Tab Content */}
          {activeTab === 'planner' && (
            <div>
              {!workoutPlan && (
                <div className="max-w-md mx-auto">
                  <div className="bg-white dark:bg-gray-800 p-6 rounded-2xl shadow-md space-y-4">
                    {/* Fitness Goal */}
                    <div>
                      <h3 className="font-semibold mb-2 text-gray-800 dark:text-gray-200">Fitness Goal</h3>
                      <div className="grid grid-cols-3 gap-2">
                        {['Weight Loss', 'Muscle Gain', 'Endurance'].map(g => (
                          <button
                            key={g}
                            onClick={() => handlePreferenceChange('goal', g)}
                            className={`p-2 rounded-lg border dark:border-gray-700 ${preferences.goal === g ? 'bg-pink-500 text-white' : 'bg-gray-100 dark:bg-gray-700 text-gray-800 dark:text-gray-200'}`}
                          >
                            {g}
                          </button>
                        ))}
                      </div>
                    </div>

                    {/* Workout Type */}
                    <div>
                      <h3 className="font-semibold mb-2 text-gray-800 dark:text-gray-200">Workout Type</h3>
                      <div className="grid grid-cols-3 gap-2">
                        {['Full Body', 'Upper Body', 'Lower Body'].map(t => (
                          <button
                            key={t}
                            onClick={() => handlePreferenceChange('type', t)}
                            className={`p-2 rounded-lg border dark:border-gray-700 ${preferences.type === t ? 'bg-pink-500 text-white' : 'bg-gray-100 dark:bg-gray-700 text-gray-800 dark:text-gray-200'}`}
                          >
                            {t}
                          </button>
                        ))}
                      </div>
                    </div>

                    {/* Experience Level */}
                    <div>
                      <h3 className="font-semibold mb-2 text-gray-800 dark:text-gray-200">Experience Level</h3>
                      <div className="grid grid-cols-3 gap-2">
                        {['Beginner', 'Intermediate', 'Advanced'].map(l => (
                          <button
                            key={l}
                            onClick={() => handlePreferenceChange('level', l)}
                            className={`p-2 rounded-lg border dark:border-gray-700 text-xs sm:text-sm ${preferences.level === l ? 'bg-pink-500 text-white' : 'bg-gray-100 dark:bg-gray-700 text-gray-800 dark:text-gray-200'}`}
                          >
                            {l}
                          </button>
                        ))}
                      </div>
                    </div>

                    {/* Equipment */}
                    <div>
                      <h3 className="font-semibold mb-2 text-gray-800 dark:text-gray-200">Available Equipment</h3>
                      <div className="grid grid-cols-3 gap-2">
                        {['Bodyweight', 'Dumbbells', 'Barbell', 'Kettlebell', 'Bands', 'Machine'].map(e => (
                          <button
                            key={e}
                            onClick={() => handleEquipmentChange(e)}
                            className={`p-2 rounded-lg border dark:border-gray-700 text-xs sm:text-sm ${preferences.equipment.includes(e) ? 'bg-pink-500 text-white' : 'bg-gray-100 dark:bg-gray-700 text-gray-800 dark:text-gray-200'}`}
                          >
                            {e}
                          </button>
                        ))}
                      </div>
                    </div>
                  </div>

                  <button
                    onClick={generateWorkoutPlan}
                    disabled={isLoading}
                    className="w-full mt-6 bg-green-500 text-white font-bold py-4 rounded-2xl shadow-lg hover:bg-green-600 transition-colors disabled:bg-gray-400"
                  >
                    {isLoading ? 'Generating...' : 'Generate Workout Plan'}
                  </button>

                  {error && <div className="mt-4 text-center text-red-500">{error}</div>}
                </div>
              )}

              {workoutPlan && (
                <div className="animate-fade-in">
                  <button onClick={() => setWorkoutPlan(null)} className="mb-4 text-pink-500 font-semibold">&larr; Back to Preferences</button>
                  <div className="bg-white dark:bg-gray-800 p-6 rounded-2xl shadow-md">
                    <h2 className="text-2xl font-bold text-gray-800 dark:text-gray-200 mb-4">{workoutPlan.plan_name}</h2>
                    <div className="space-y-4">
                      {workoutPlan.exercises.map((ex, i) => (
                        <div key={i} className="border-b dark:border-gray-700 pb-2">
                          <h3 className="font-bold text-gray-800 dark:text-gray-200">{ex.name}</h3>
                          <p className="text-sm text-gray-600 dark:text-gray-400">Sets: {ex.sets} | Reps: {ex.reps}</p>
                          <p className="mt-1 text-sm text-gray-800 dark:text-gray-200">{ex.instructions}</p>
                        </div>
                      ))}
                    </div>
                  </div>
                  
                  {/* Download Button */}
                  <button
                    onClick={() => {
                      // Format workout plan for PDF
                      const title = workoutPlan.plan_name;
                      let content = "";
                      
                      // Add workout details
                      workoutPlan.exercises.forEach((ex, i) => {
                        content += `${i+1}. ${ex.name}\n`;
                        content += `Sets: ${ex.sets} | Reps: ${ex.reps}\n`;
                        content += `Instructions: ${ex.instructions}\n\n`;
                      });
                      
                      // Generate and download PDF
                      generatePDF(title, content, "workout-plan.pdf");
                    }}
                    className="mt-6 mx-auto block bg-pink-500 text-white font-bold py-3 px-6 rounded-xl shadow-lg hover:bg-pink-600 transition-colors"
                  >
                    üì• Download Workout Plan PDF
                  </button>
                </div>
              )}
            </div>
          )}

          {activeTab === 'coach' && (
            <WorkoutFormCoach />
          )}
        </div>
      );
    };

    // AI Coach Screen Component
    const Coach = ({ dailyIntake, recentMeals, goals, messages, setMessages }) => {
      const [input, setInput] = useState('');
      const [isLoading, setIsLoading] = useState(false);
      const chatEndRef = useRef(null);
      const [attachment, setAttachment] = useState(null);
      const [attachmentPreview, setAttachmentPreview] = useState(null);
      const fileInputRef = useRef(null);

      // Function to start a new conversation
      const startNewConversation = () => {
        setMessages([{ text: "Hello! I'm your AI Health Coach. Ask me anything about your nutrition or meals.", sender: 'ai' }]);
        setInput('');
        setAttachment(null);
        setAttachmentPreview(null);
      };

      useEffect(() => {
        chatEndRef.current?.scrollIntoView({ behavior: "smooth" });
      }, [messages]);

      const fileToBase64 = (file) => new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = () => resolve(reader.result.split(',')[1]);
        reader.onerror = error => reject(error);
      });

      const handleAttachmentChange = (event) => {
        const file = event.target.files[0];
        if (file) {
          setAttachment(file);
          setAttachmentPreview(URL.createObjectURL(file));
        }
      };

      const handleSend = async () => {
        if (!input.trim() && !attachment) return;

        const userMessage = { text: input, sender: 'user', attachment: attachmentPreview };
        setMessages(prev => [...prev, userMessage]);
        setInput('');
        setAttachment(null);
        setAttachmentPreview(null);
        setIsLoading(true);

        try {
          const mealContext = recentMeals.map(m => `${m.name} (Felt: ${m.mood || 'Not specified'})`).join(', ');
          
          // Calculate progress percentages
          const calorieProgress = ((dailyIntake.calories / goals.calories) * 100).toFixed(0);
          const proteinProgress = ((dailyIntake.protein / goals.protein) * 100).toFixed(0);
          const carbProgress = ((dailyIntake.carbs / goals.carbs) * 100).toFixed(0);
          const fatProgress = ((dailyIntake.fat / goals.fat) * 100).toFixed(0);
          const activityProgress = ((dailyIntake.activity / goals.activity) * 100).toFixed(0);
          const waterProgress = ((dailyIntake.water / goals.water) * 100).toFixed(0);
          
          // Identify areas needing attention
          const lowAreas = [];
          const highAreas = [];
          if (calorieProgress < 80) lowAreas.push('calories');
          if (proteinProgress < 80) lowAreas.push('protein');
          if (activityProgress < 80) lowAreas.push('activity');
          if (waterProgress < 80) lowAreas.push('water');
          if (calorieProgress > 120) highAreas.push('calories');
          if (carbProgress > 120) highAreas.push('carbs');
          if (fatProgress > 120) highAreas.push('fat');
          
          let prompt = `You are an AI Health Coach specializing in FITNESS and NUTRITION. Analyze the user's question type and provide HIGHLY RELEVANT responses.

üìä USER'S CURRENT STATUS:
Daily Intake vs Goals:
- Calories: ${dailyIntake.calories}/${goals.calories} (${calorieProgress}%)
- Protein: ${dailyIntake.protein}g/${goals.protein}g (${proteinProgress}%)
- Carbs: ${dailyIntake.carbs}g/${goals.carbs}g (${carbProgress}%)
- Fat: ${dailyIntake.fat}g/${goals.fat}g (${fatProgress}%)
- Activity: ${dailyIntake.activity}/${goals.activity} mins (${activityProgress}%)
- Water: ${dailyIntake.water}/${goals.water} glasses (${waterProgress}%)

Recent meals: ${mealContext || 'None logged'}
${lowAreas.length > 0 ? `\n‚ö†Ô∏è LOW AREAS: ${lowAreas.join(', ')}` : ''}
${highAreas.length > 0 ? `\nüî¥ HIGH AREAS: ${highAreas.join(', ')}` : ''}

üéØ RESPONSE RULES:
1. IDENTIFY QUESTION TYPE FIRST:
   - INJURY/PAIN ‚Üí Focus on recovery, rest, medical advice
   - EXERCISE ‚Üí Focus on form, progression, alternatives
   - NUTRITION ‚Üí Focus on macros, meal timing, food choices
   - GENERAL HEALTH ‚Üí Focus on lifestyle, habits, wellness

2. RESPONSE FORMAT (MAX 100 WORDS):
   - Start with direct answer to their specific question
   - Provide 2-3 bullet points with actionable tips
   - Use relevant emojis for readability
   - Reference their actual data when applicable

3. CONTEXT MATCHING:
   - For injury questions: Prioritize safety and recovery
   - For exercise questions: Focus on technique and progression
   - For nutrition questions: Use their macro data and goals
   - Always stay within your expertise scope

User's question: "${userMessage.text}"`;

          const parts = [{ text: prompt }];

          if (attachment) {
            const base64ImageData = await fileToBase64(attachment);
            parts.push({ inlineData: { mimeType: attachment.type, data: base64ImageData } });
            prompt += "\n\nPlease also consider the attached document in your analysis.";
          }

          const response = await fetch(NETLIFY_API_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ contents: [{ parts }] })
          });

          if (!response.ok) {
            throw new Error(`API Error: ${response.status} ${response.statusText}`);
          }

          const result = await response.json();
          const aiResponse = result.candidates[0].content.parts[0].text;
          setMessages(prev => [...prev, { text: aiResponse, sender: 'ai' }]);
        } catch (err) {
          console.error("Chatbot error:", err);
          setMessages(prev => [...prev, { text: "Sorry, I'm having trouble connecting. Please try again.", sender: 'ai' }]);
        } finally {
          setIsLoading(false);
        }
      };

      return (
        <div className="p-6 pb-24 h-screen flex flex-col">
          <header className="mb-6 text-center">
            <div className="flex items-center justify-between mb-2">
              <div></div> {/* Spacer for centering */}
              <h1 className="text-3xl font-bold text-gray-800 dark:text-gray-200">AI Health Coach</h1>
              <button
                onClick={startNewConversation}
                className="bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded-lg text-sm font-medium transition-colors flex items-center gap-1"
                title="Start New Conversation"
              >
                üîÑ New
              </button>
            </div>
            <p className="text-gray-500 dark:text-gray-400">Your personal health assistant</p>
          </header>

          <div className="flex-grow overflow-y-auto p-4 rounded-2xl shadow-md relative" 
               style={{
                 backgroundColor: '#f8fafc',
                 backgroundImage: `
                   radial-gradient(circle at 25px 25px, rgba(59, 130, 246, 0.15) 6px, transparent 6px),
                   radial-gradient(circle at 75px 75px, rgba(168, 85, 247, 0.12) 8px, transparent 8px),
                   radial-gradient(circle at 50px 100px, rgba(236, 72, 153, 0.08) 4px, transparent 4px)
                 `,
                 backgroundSize: '100px 100px'
               }}>
            
            {/* Bigger dots pattern for dark mode */}
            <div className="absolute inset-0 rounded-2xl dark:bg-gray-800" 
                 style={{
                   backgroundImage: `
                     radial-gradient(circle at 25px 25px, rgba(59, 130, 246, 0.2) 5px, transparent 5px),
                     radial-gradient(circle at 75px 75px, rgba(168, 85, 247, 0.15) 7px, transparent 7px)
                   `,
                   backgroundSize: '100px 100px'
                 }}></div>
            
            {/* Content container */}
            <div className="relative z-10">
              <div className="text-center text-xs text-gray-600 dark:text-gray-400 p-2 mb-2 bg-white dark:bg-gray-700 rounded-lg shadow-sm">
                Disclaimer: This AI is for informational purposes only and is not a substitute for professional medical advice. Always consult a doctor for health concerns.
              </div>

              {messages.map((msg, i) => (
                <div key={i} className={`flex mb-3 ${msg.sender === 'user' ? 'justify-end' : 'justify-start'}`}>
                  <div className={`p-3 rounded-2xl max-w-xs shadow-lg ${
                    msg.sender === 'user' 
                      ? 'bg-pink-500 text-white' 
                      : 'bg-white dark:bg-gray-700 text-gray-800 dark:text-gray-200'
                  }`}>
                    {msg.attachment && <img src={msg.attachment} alt="attachment" className="rounded-lg mb-2 max-w-full h-auto" />}
                    {msg.text}
                  </div>
                </div>
              ))}
              <div ref={chatEndRef} />
            </div>
          </div>

          {attachmentPreview && (
            <div className="mt-2 p-2 bg-gray-200 dark:bg-gray-700 rounded-lg flex items-center justify-between">
              <img src={attachmentPreview} alt="preview" className="w-12 h-12 rounded-md object-cover" />
              <button onClick={() => { setAttachment(null); setAttachmentPreview(null); }} className="text-red-500 font-bold">Remove</button>
            </div>
          )}

          <div className="mt-4 flex">
            <input type="file" accept="image/*" ref={fileInputRef} onChange={handleAttachmentChange} className="hidden" />
            <button onClick={() => fileInputRef.current.click()} className="p-3 border dark:border-gray-700 rounded-l-lg bg-gray-100 dark:bg-gray-700">üìé</button>
            <input
              type="text"
              value={input}
              onChange={e => setInput(e.target.value)}
              onKeyDown={e => e.key === 'Enter' && handleSend()}
              placeholder="Ask a question..."
              className="flex-grow p-3 border-t border-b dark:border-gray-700 focus:outline-none focus:ring-2 focus:ring-pink-500 bg-white dark:bg-gray-800 text-gray-800 dark:text-gray-200"
              disabled={isLoading}
            />
            <button onClick={handleSend} disabled={isLoading} className="bg-pink-500 text-white p-3 rounded-r-lg font-bold">
              {isLoading ? '...' : 'Send'}
            </button>
          </div>
        </div>
      );
    };

    // Progress Screen Component
    const Progress = ({ dailyHistory, goals, dailyIntake, habitAIAdvice, setHabitAIAdvice, isLoadingAdvice, setIsLoadingAdvice }) => {
      const [currentDate, setCurrentDate] = useState(new Date());
      const [selectedDay, setSelectedDay] = useState(null);
      const [viewMode, setViewMode] = useState('month'); // 'month' or 'year'
      const [activeTab, setActiveTab] = useState('progress'); // 'progress' or 'habits'
      const [habits, setHabits] = useState(() => {
        const savedHabits = localStorage.getItem('habits');
        return savedHabits ? JSON.parse(savedHabits) : [];
      });
      const [newHabit, setNewHabit] = useState('');

      // Save habits to localStorage whenever they change
      useEffect(() => {
        localStorage.setItem('habits', JSON.stringify(habits));
      }, [habits]);

      const startOfMonth = new Date(currentDate.getFullYear(), currentDate.getMonth(), 1);
      const endOfMonth = new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 0);
      // Adjust start day for Monday-first calendar (0=Sunday becomes 6, 1=Monday becomes 0)
      const startDay = (startOfMonth.getDay() + 6) % 7;
      const daysInMonth = endOfMonth.getDate();

      const getScoreColor = (score) => {
        if (score >= 90) return 'from-emerald-400 to-emerald-600';
        if (score >= 80) return 'from-green-400 to-green-600';
        if (score >= 70) return 'from-lime-400 to-lime-600';
        if (score >= 60) return 'from-yellow-400 to-yellow-600';
        if (score >= 50) return 'from-orange-400 to-orange-600';
        return 'from-red-400 to-red-600';
      };

      const getScoreGlow = (score) => {
        if (score >= 90) return 'shadow-emerald-500/50';
        if (score >= 80) return 'shadow-green-500/50';
        if (score >= 70) return 'shadow-lime-500/50';
        if (score >= 60) return 'shadow-yellow-500/50';
        if (score >= 50) return 'shadow-orange-500/50';
        return 'shadow-red-500/50';
      };

      // Calculate current streak
      const calculateStreak = () => {
        const today = new Date();
        let streak = 0;
        let currentDay = new Date(today);
        
        while (currentDay >= new Date(today.getTime() - 365 * 24 * 60 * 60 * 1000)) {
          const dateString = currentDay.toISOString().split('T')[0];
          const data = dailyHistory[dateString];
          
          if (data && data.score >= 70) {
            streak++;
          } else {
            break;
          }
          
          currentDay.setDate(currentDay.getDate() - 1);
        }
        
        return streak;
      };

      // Calculate monthly stats
      const getMonthlyStats = () => {
        const monthData = Object.entries(dailyHistory)
          .filter(([date]) => {
            const d = new Date(date);
            return d.getMonth() === currentDate.getMonth() && d.getFullYear() === currentDate.getFullYear();
          })
          .map(([_, data]) => data);

        if (monthData.length === 0) return { avg: 0, best: 0, days: 0 };

        const avg = monthData.reduce((sum, data) => sum + data.score, 0) / monthData.length;
        const best = Math.max(...monthData.map(data => data.score));
        
        return { avg: Math.round(avg), best, days: monthData.length };
      };

      const currentStreak = calculateStreak();
      const monthlyStats = getMonthlyStats();

      return (
        <div className="p-6 pb-24 bg-gradient-to-br from-purple-50 via-pink-50 to-blue-50 dark:from-gray-900 dark:via-purple-900/20 dark:to-blue-900/20 min-h-screen">
          {/* Header */}
          <header className="mb-8 text-center">
            <div className="inline-flex items-center justify-center w-16 h-16 bg-gradient-to-r from-purple-500 to-pink-500 rounded-2xl mb-4 shadow-lg">
              <span className="text-2xl">üìä</span>
            </div>
            <h1 className="text-4xl font-bold bg-gradient-to-r from-purple-600 to-pink-600 bg-clip-text text-transparent mb-2">Your Progress</h1>
            <p className="text-gray-600 dark:text-gray-400 text-lg">Track your fitness journey</p>
          </header>

          {/* Tab Navigation */}
          <div className="flex justify-center mb-6">
            <div className="bg-white/80 dark:bg-gray-800/80 backdrop-blur-sm p-1 rounded-xl shadow-md border border-white/20 flex">
              <button 
                onClick={() => setActiveTab('progress')} 
                className={`px-6 py-3 rounded-lg font-semibold transition-all duration-200 ${activeTab === 'progress' ? 'bg-gradient-to-r from-purple-500 to-pink-500 text-white shadow-md' : 'text-gray-600 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700'}`}
              >
                Progress
              </button>
              <button 
                onClick={() => setActiveTab('habits')} 
                className={`px-6 py-3 rounded-lg font-semibold transition-all duration-200 ${activeTab === 'habits' ? 'bg-gradient-to-r from-purple-500 to-pink-500 text-white shadow-md' : 'text-gray-600 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700'}`}
              >
                Habit Tracker
              </button>
            </div>
          </div>

          {/* Tab Content */}
          {activeTab === 'progress' && (
            <>
              {/* Streak & Stats Cards */}
          <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8">
            {/* Current Streak */}
            <div className="bg-white/80 dark:bg-gray-800/80 backdrop-blur-sm p-6 rounded-3xl shadow-xl border border-white/20">
              <div className="flex items-center justify-between mb-3">
                <div className="w-12 h-12 bg-gradient-to-r from-orange-400 to-red-500 rounded-2xl flex items-center justify-center">
                  <span className="text-xl">üî•</span>
                </div>
                <span className="text-3xl font-bold bg-gradient-to-r from-orange-500 to-red-500 bg-clip-text text-transparent">
                  {currentStreak}
                </span>
              </div>
              <h3 className="font-semibold text-gray-800 dark:text-gray-200">Day Streak</h3>
              <p className="text-sm text-gray-600 dark:text-gray-400">Keep it going! üí™</p>
            </div>

            {/* Monthly Average */}
            <div className="bg-white/80 dark:bg-gray-800/80 backdrop-blur-sm p-6 rounded-3xl shadow-xl border border-white/20">
              <div className="flex items-center justify-between mb-3">
                <div className="w-12 h-12 bg-gradient-to-r from-blue-400 to-purple-500 rounded-2xl flex items-center justify-center">
                  <span className="text-xl">üìà</span>
                </div>
                <span className="text-3xl font-bold bg-gradient-to-r from-blue-500 to-purple-500 bg-clip-text text-transparent">
                  {monthlyStats.avg}
                </span>
              </div>
              <h3 className="font-semibold text-gray-800 dark:text-gray-200">Monthly Avg</h3>
              <p className="text-sm text-gray-600 dark:text-gray-400">{monthlyStats.days} active days</p>
            </div>

            {/* Best Score */}
            <div className="bg-white/80 dark:bg-gray-800/80 backdrop-blur-sm p-6 rounded-3xl shadow-xl border border-white/20">
              <div className="flex items-center justify-between mb-3">
                <div className="w-12 h-12 bg-gradient-to-r from-emerald-400 to-green-500 rounded-2xl flex items-center justify-center">
                  <span className="text-xl">üèÜ</span>
                </div>
                <span className="text-3xl font-bold bg-gradient-to-r from-emerald-500 to-green-500 bg-clip-text text-transparent">
                  {monthlyStats.best}
                </span>
              </div>
              <h3 className="font-semibold text-gray-800 dark:text-gray-200">Best Score</h3>
              <p className="text-sm text-gray-600 dark:text-gray-400">This month</p>
            </div>
          </div>

          {/* Modern Calendar */}
          <div className="bg-white/80 dark:bg-gray-800/80 backdrop-blur-sm rounded-3xl shadow-2xl border border-white/20 overflow-hidden">
            {/* Calendar Header */}
            <div className="bg-blue-500 p-6">
              <div className="flex justify-between items-center">
                <button 
                  onClick={() => setCurrentDate(new Date(currentDate.setMonth(currentDate.getMonth() - 1)))} 
                  className="w-12 h-12 bg-white/20 hover:bg-white/30 rounded-2xl flex items-center justify-center text-white transition-all duration-200 hover:scale-105"
                >
                  <span className="text-xl">‚Üê</span>
                </button>
                
                <div className="text-center">
                  <h2 className="text-2xl font-bold text-white mb-1">
                    {currentDate.toLocaleString('default', { month: 'long', year: 'numeric' })}
                  </h2>
                  <p className="text-white/80 text-sm">Tap any day to see details</p>
                </div>
                
                <button 
                  onClick={() => setCurrentDate(new Date(currentDate.setMonth(currentDate.getMonth() + 1)))} 
                  className="w-12 h-12 bg-white/20 hover:bg-white/30 rounded-2xl flex items-center justify-center text-white transition-all duration-200 hover:scale-105"
                >
                  <span className="text-xl">‚Üí</span>
                </button>
              </div>
            </div>

            {/* Calendar Grid */}
            <div className="p-6">
              {/* Day Headers - Monday to Sunday */}
              <div className="grid grid-cols-7 gap-1 mb-2 bg-gray-100 dark:bg-gray-700 rounded-xl p-2">
                {['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'].map((day, index) => (
                  <div key={day} className={`text-center py-3 text-sm font-semibold rounded-lg border ${
                    index === 5 || index === 6 
                      ? 'bg-red-50 dark:bg-red-900/20 text-red-600 dark:text-red-400 border-red-200 dark:border-red-700' 
                      : 'bg-white dark:bg-gray-600 text-gray-600 dark:text-gray-300 border-gray-200 dark:border-gray-500'
                  }`}>
                    {day}
                  </div>
                ))}
              </div>

              {/* Calendar Days with Monday-first layout */}
              <div className="grid grid-cols-7 gap-1 bg-gray-100 dark:bg-gray-700 p-2 rounded-xl">
                {Array.from({ length: startDay }).map((_, i) => {
                  const dayOfWeek = i;
                  const isWeekend = dayOfWeek === 5 || dayOfWeek === 6; // Saturday=5, Sunday=6
                  return (
                    <div key={`empty-${i}`} className={`aspect-square rounded-lg border ${
                      isWeekend 
                        ? 'bg-red-50 dark:bg-red-900/10 border-red-200 dark:border-red-700' 
                        : 'bg-white dark:bg-gray-600 border-gray-200 dark:border-gray-500'
                    }`}></div>
                  );
                })}
                
                {Array.from({ length: daysInMonth }).map((_, day) => {
                  const date = new Date(currentDate.getFullYear(), currentDate.getMonth(), day + 1);
                  const dateString = date.toISOString().split('T')[0];
                  const data = dailyHistory[dateString];
                  const isToday = dateString === new Date().toISOString().split('T')[0];
                  // Adjust day of week calculation for Monday-first calendar
                  const dayOfWeek = (startDay + day) % 7;
                  const isWeekend = dayOfWeek === 5 || dayOfWeek === 6; // Saturday=5, Sunday=6
                  
                  return (
                    <div 
                      key={day} 
                      onClick={() => data && setSelectedDay({date: dateString, ...data})} 
                      className={`aspect-square flex items-center justify-center cursor-pointer group relative rounded-lg border transition-all duration-200 ${
                        isWeekend 
                          ? 'bg-red-50 dark:bg-red-900/10 border-red-200 dark:border-red-700 hover:border-red-300 dark:hover:border-red-600' 
                          : 'bg-white dark:bg-gray-600 border-gray-200 dark:border-gray-500 hover:border-gray-300 dark:hover:border-gray-400'
                      }`}
                    >
                      {data ? (
                        <div className={`w-10 h-10 bg-gradient-to-br ${getScoreColor(data.score)} rounded-xl flex items-center justify-center text-white font-bold text-sm shadow-lg ${getScoreGlow(data.score)} transform transition-all duration-200 group-hover:scale-110 group-hover:shadow-2xl ${isToday ? 'ring-3 ring-purple-400 ring-opacity-60' : ''} ${isWeekend ? 'ring-2 ring-red-300 dark:ring-red-600' : ''}`}>
                          {data.score}
                        </div>
                      ) : (
                        <div className={`w-10 h-10 rounded-xl flex items-center justify-center font-medium transition-all duration-200 ${
                          isWeekend 
                            ? 'text-red-500 dark:text-red-400 group-hover:bg-red-100 dark:group-hover:bg-red-900/20' 
                            : 'text-gray-500 dark:text-gray-400 group-hover:bg-gray-50 dark:group-hover:bg-gray-500'
                        } ${isToday ? 'bg-purple-100 dark:bg-purple-900/40 text-purple-600 dark:text-purple-400 ring-2 ring-purple-400 ring-opacity-60' : ''}`}>
                          {day + 1}
                        </div>
                      )}
                      
                      {/* Weekend Corner Marker */}
                      {isWeekend && (
                        <div className="absolute top-1 right-1 w-2 h-2 bg-red-400 dark:bg-red-500 rounded-full opacity-60"></div>
                      )}
                    </div>
                  );
                })}
              </div>
            </div>
          </div>

          {/* Achievement Badges */}
          <div className="mt-8 bg-white/80 dark:bg-gray-800/80 backdrop-blur-sm p-6 rounded-3xl shadow-xl border border-white/20">
            <h3 className="text-xl font-bold text-gray-800 dark:text-gray-200 mb-4 flex items-center">
              <span className="mr-2">üèÖ</span>
              Achievement Badges
            </h3>
            <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
              <div className={`p-4 rounded-2xl text-center ${currentStreak >= 7 ? 'bg-gradient-to-br from-yellow-400 to-orange-500 text-white' : 'bg-gray-100 dark:bg-gray-700 text-gray-400'}`}>
                <div className="text-2xl mb-2">üî•</div>
                <div className="text-xs font-semibold">Week Warrior</div>
                <div className="text-xs opacity-80">7 day streak</div>
              </div>
              
              <div className={`p-4 rounded-2xl text-center ${currentStreak >= 30 ? 'bg-gradient-to-br from-purple-400 to-pink-500 text-white' : 'bg-gray-100 dark:bg-gray-700 text-gray-400'}`}>
                <div className="text-2xl mb-2">üíé</div>
                <div className="text-xs font-semibold">Diamond</div>
                <div className="text-xs opacity-80">30 day streak</div>
              </div>
              
              <div className={`p-4 rounded-2xl text-center ${monthlyStats.avg >= 80 ? 'bg-gradient-to-br from-green-400 to-emerald-500 text-white' : 'bg-gray-100 dark:bg-gray-700 text-gray-400'}`}>
                <div className="text-2xl mb-2">‚≠ê</div>
                <div className="text-xs font-semibold">Superstar</div>
                <div className="text-xs opacity-80">80+ avg score</div>
              </div>
              
              <div className={`p-4 rounded-2xl text-center ${monthlyStats.best >= 95 ? 'bg-gradient-to-br from-blue-400 to-cyan-500 text-white' : 'bg-gray-100 dark:bg-gray-700 text-gray-400'}`}>
                <div className="text-2xl mb-2">üöÄ</div>
                <div className="text-xs font-semibold">Perfectionist</div>
                <div className="text-xs opacity-80">95+ best score</div>
              </div>
            </div>
          </div>

          {/* Health Score Info */}
          <div className="mt-8 bg-gradient-to-r from-indigo-500/10 to-purple-500/10 dark:from-indigo-500/5 dark:to-purple-500/5 p-6 rounded-3xl border border-indigo-200/50 dark:border-indigo-700/50">
            <h3 className="text-xl font-bold text-gray-800 dark:text-gray-200 mb-3 flex items-center">
              <span className="mr-2">üßÆ</span>
              Health Score Formula
            </h3>
            <div className="grid grid-cols-1 md:grid-cols-3 gap-4 text-center">
              <div className="bg-white/50 dark:bg-gray-800/50 p-4 rounded-2xl">
                <div className="text-2xl font-bold text-pink-500 mb-1">50%</div>
                <div className="text-sm font-semibold text-gray-700 dark:text-gray-300">Nutrition</div>
                <div className="text-xs text-gray-600 dark:text-gray-400">Calorie goals</div>
              </div>
              <div className="bg-white/50 dark:bg-gray-800/50 p-4 rounded-2xl">
                <div className="text-2xl font-bold text-blue-500 mb-1">30%</div>
                <div className="text-sm font-semibold text-gray-700 dark:text-gray-300">Activity</div>
                <div className="text-xs text-gray-600 dark:text-gray-400">Movement goals</div>
              </div>
              <div className="bg-white/50 dark:bg-gray-800/50 p-4 rounded-2xl">
                <div className="text-2xl font-bold text-cyan-500 mb-1">20%</div>
                <div className="text-sm font-semibold text-gray-700 dark:text-gray-300">Hydration</div>
                <div className="text-xs text-gray-600 dark:text-gray-400">Water intake</div>
              </div>
            </div>
          </div>
            </>
          )}

          {activeTab === 'habits' && (
            <div className="space-y-8">
              {/* Habit Tracker Content */}
              <div className="bg-white/80 dark:bg-gray-800/80 backdrop-blur-sm p-6 rounded-3xl shadow-xl border border-white/20">
                <h3 className="text-xl font-bold text-gray-800 dark:text-gray-200 mb-4 flex items-center">
                  <span className="mr-2">‚úÖ</span>
                  My Habits
                </h3>
                
                {/* Add New Habit */}
                <div className="flex mb-6">
                  <input 
                    type="text" 
                    value={newHabit}
                    onChange={(e) => setNewHabit(e.target.value)}
                    placeholder="Add a new habit..."
                    className="flex-grow p-3 rounded-l-xl border border-gray-200 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-800 dark:text-gray-200 focus:outline-none focus:ring-2 focus:ring-purple-500"
                  />
                  <button 
                    onClick={() => {
                      if (newHabit.trim()) {
                        setHabits([...habits, {
                          id: Date.now().toString(),
                          name: newHabit.trim(),
                          streak: 0,
                          completed: {},
                          created: new Date().toISOString()
                        }]);
                        setNewHabit('');
                      }
                    }}
                    className="bg-gradient-to-r from-purple-500 to-pink-500 text-white font-bold p-3 rounded-r-xl hover:from-purple-600 hover:to-pink-600 transition-all duration-200"
                  >
                    Add
                  </button>
                </div>
                
                {/* Habits List */}
                <div className="space-y-4 max-h-96 overflow-y-auto">
                  {habits.length === 0 ? (
                    <div className="text-center p-8 text-gray-500 dark:text-gray-400">
                      <div className="text-4xl mb-2">üå±</div>
                      <p>No habits yet. Add your first habit to start tracking!</p>
                    </div>
                  ) : (
                    habits.map(habit => {
                      const today = new Date().toISOString().split('T')[0];
                      const isCompletedToday = habit.completed && habit.completed[today];
                      
                      return (
                        <div key={habit.id} className="bg-white dark:bg-gray-700 rounded-2xl p-4 shadow-md border border-gray-100 dark:border-gray-600">
                          <div className="flex items-center justify-between">
                            <div className="flex items-center">
                              <button 
                                onClick={() => {
                                  const updatedHabits = habits.map(h => {
                                    if (h.id === habit.id) {
                                      const completed = {...h.completed};
                                      const wasCompleted = completed[today];
                                      
                                      if (completed[today]) {
                                        delete completed[today];
                                      } else {
                                        completed[today] = true;
                                      }
                                      
                                      // Note: Auto-sync with dailyIntake would require passing setDailyIntake as prop
                                      // This functionality is commented out to avoid prop drilling
                                      // if (!wasCompleted && (h.name.toLowerCase().includes('cardio') || h.name.toLowerCase().includes('exercise') || h.name.toLowerCase().includes('workout') || h.name.toLowerCase().includes('run') || h.name.toLowerCase().includes('walk') || h.name.toLowerCase().includes('gym'))) {
                                      //   const minutes = parseInt(h.name.match(/\d+/)?.[0]) || 30;
                                      //   setDailyIntake(prev => ({ ...prev, activity: prev.activity + minutes }));
                                      // }
                                      // if (!wasCompleted && h.name.toLowerCase().includes('water')) {
                                      //   const glasses = parseInt(h.name.match(/\d+/)?.[0]) || 1;
                                      //   setDailyIntake(prev => ({ ...prev, water: prev.water + glasses }));
                                      // }
                                      
                                      // Calculate streak
                                      let streak = 0;
                                      let currentDate = new Date();
                                      
                                      while (true) {
                                        const dateStr = currentDate.toISOString().split('T')[0];
                                        if (completed[dateStr]) {
                                          streak++;
                                          currentDate.setDate(currentDate.getDate() - 1);
                                        } else {
                                          break;
                                        }
                                      }
                                      
                                      return {...h, completed, streak};
                                    }
                                    return h;
                                  });
                                  
                                  setHabits(updatedHabits);
                                }}
                                className={`w-8 h-8 rounded-lg mr-3 flex items-center justify-center transition-all duration-200 ${isCompletedToday ? 'bg-gradient-to-r from-green-400 to-emerald-500 text-white' : 'bg-gray-100 dark:bg-gray-600 text-gray-400 dark:text-gray-500'}`}
                              >
                                {isCompletedToday ? '‚úì' : ''}
                              </button>
                              <div>
                                <h4 className="font-semibold text-gray-800 dark:text-gray-200">{habit.name}</h4>
                                <div className="text-xs text-gray-500 dark:text-gray-400 flex items-center">
                                  <span className="mr-2">üî•</span>
                                  <span>{habit.streak} day streak</span>
                                </div>
                              </div>
                            </div>
                            <button 
                              onClick={() => {
                                setHabits(habits.filter(h => h.id !== habit.id));
                              }}
                              className="text-gray-400 hover:text-red-500 transition-colors duration-200"
                            >
                              √ó
                            </button>
                          </div>
                        </div>
                      );
                    })
                  )}
                </div>
              </div>
              
              {/* AI Habit Coach */}
              <div className="bg-gradient-to-r from-blue-500/10 to-purple-500/10 dark:from-blue-500/5 dark:to-purple-500/5 p-6 rounded-3xl border border-blue-200/50 dark:border-blue-700/50">
                <h3 className="text-xl font-bold text-gray-800 dark:text-gray-200 mb-4 flex items-center">
                  <span className="mr-2">ü§ñ</span>
                  AI Habit Coach
                </h3>
                
                <div className="bg-white/80 dark:bg-gray-800/80 backdrop-blur-sm p-4 rounded-2xl mb-4">
                  {habitAIAdvice ? (
                    <div className="text-gray-800 dark:text-gray-200">
                      {habitAIAdvice}
                    </div>
                  ) : (
                    <div className="text-center p-4 text-gray-500 dark:text-gray-400">
                      <p>Ask for habit recommendations or insights</p>
                    </div>
                  )}
                </div>
                
                <div className="flex">
                  <button 
                    onClick={async () => {
                      setIsLoadingAdvice(true);
                      try {
                        // Get habits data for context
                        const habitsContext = habits.map(h => `${h.name} (${h.streak} day streak)`);
                        
                        // Create prompt for the AI
                        let prompt = `You are an AI Habit Coach. Analyze user data and provide smart recommendations.

**HABIT STATUS TODAY:**
${habits.map(habit => {
  const today = new Date().toISOString().split('T')[0];
  const isCompleted = habit.completed && habit.completed[today];
  return `‚Ä¢ ${habit.name}: ${isCompleted ? '‚úÖ COMPLETED' : '‚ùå NOT DONE'} (${habit.streak}d streak)`;
}).join('\n')}

**DAILY PROGRESS:**
‚Ä¢ Calories: ${dailyIntake.calories}/${goals.calories} (${((dailyIntake.calories / goals.calories) * 100).toFixed(0)}%)
‚Ä¢ Protein: ${dailyIntake.protein}g/${goals.protein}g (${((dailyIntake.protein / goals.protein) * 100).toFixed(0)}%)
‚Ä¢ Activity: ${dailyIntake.activity}/${goals.activity}min (${((dailyIntake.activity / goals.activity) * 100).toFixed(0)}%)
‚Ä¢ Water: ${dailyIntake.water}/${goals.water} glasses (${((dailyIntake.water / goals.water) * 100).toFixed(0)}%)

**INSTRUCTIONS:**
1. If habits are completed today, congratulate and suggest maintaining momentum
2. If habits are incomplete, focus on the most important one to complete
3. For daily progress, only mention areas below 80%
4. Be encouraging about completed habits

**FORMAT (exactly 4 lines, max 100 chars total):**
üéØ [Focus area or congratulations]
‚ö° [Specific action for today]
üî• [Simple habit tip]
üí™ [Motivation based on actual progress]

**RULES:**
- Maximum 100 characters total
- Acknowledge completed habits positively
- Only suggest improvements for incomplete items
- Use actual percentages, not assumptions`;
                        
                        // Call the AI API
                        const response = await fetch(NETLIFY_API_URL, {
                          method: 'POST',
                          headers: {
                            'Content-Type': 'application/json',
                          },
                          body: JSON.stringify({ prompt })
                        });
                        
                        if (!response.ok) throw new Error('Failed to get AI recommendations');
                        
                        const result = await response.json();
                        const advice = result.candidates[0].content.parts[0].text;
                        setHabitAIAdvice(advice);
                      } catch (error) {
                        console.error("Failed to get habit recommendations:", error);
                        setHabitAIAdvice("Sorry, I couldn't generate recommendations right now. Please try again later.");
                      } finally {
                        setIsLoadingAdvice(false);
                      }
                    }}
                    disabled={isLoadingAdvice}
                    className="flex-grow bg-gradient-to-r from-blue-500 to-purple-500 text-white font-bold p-3 rounded-xl hover:from-blue-600 hover:to-purple-600 transition-all duration-200 disabled:opacity-50"
                  >
                    {isLoadingAdvice ? 'Thinking...' : 'Get AI Recommendations'}
                  </button>
                </div>
              </div>
              
              {/* Habit Statistics */}
              <div className="bg-white/80 dark:bg-gray-800/80 backdrop-blur-sm p-6 rounded-3xl shadow-xl border border-white/20">
                <h3 className="text-xl font-bold text-gray-800 dark:text-gray-200 mb-4 flex items-center">
                  <span className="mr-2">üìà</span>
                  Habit Statistics
                </h3>
                
                <div className="grid grid-cols-1 md:grid-cols-3 gap-4 text-center">
                  <div className="bg-gradient-to-br from-purple-500/10 to-pink-500/10 dark:from-purple-500/5 dark:to-pink-500/5 p-4 rounded-2xl">
                    <div className="text-2xl font-bold text-purple-500 mb-1">{habits.length}</div>
                    <div className="text-sm font-semibold text-gray-700 dark:text-gray-300">Active Habits</div>
                  </div>
                  <div className="bg-gradient-to-br from-blue-500/10 to-cyan-500/10 dark:from-blue-500/5 dark:to-cyan-500/5 p-4 rounded-2xl">
                    <div className="text-2xl font-bold text-blue-500 mb-1">
                      {habits.reduce((total, habit) => {
                        const today = new Date().toISOString().split('T')[0];
                        return total + (habit.completed && habit.completed[today] ? 1 : 0);
                      }, 0)}
                    </div>
                    <div className="text-sm font-semibold text-gray-700 dark:text-gray-300">Completed Today</div>
                  </div>
                  <div className="bg-gradient-to-br from-green-500/10 to-emerald-500/10 dark:from-green-500/5 dark:to-emerald-500/5 p-4 rounded-2xl">
                    <div className="text-2xl font-bold text-green-500 mb-1">
                      {habits.length > 0 ? Math.max(...habits.map(h => h.streak)) : 0}
                    </div>
                    <div className="text-sm font-semibold text-gray-700 dark:text-gray-300">Longest Streak</div>
                  </div>
                </div>
              </div>
            </div>
          )}

          {/* Day Detail Modal */}
          {selectedDay && (
            <div className="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center p-4 z-50 animate-fade-in" onClick={() => setSelectedDay(null)}>
              <div className="bg-white dark:bg-gray-800 p-8 rounded-3xl shadow-2xl max-w-md w-full transform transition-all duration-300 scale-100" onClick={e => e.stopPropagation()}>
                <div className="text-center mb-6">
                  <div className={`w-20 h-20 bg-gradient-to-br ${getScoreColor(selectedDay.score)} rounded-3xl flex items-center justify-center text-white font-bold text-2xl mx-auto mb-4 shadow-lg ${getScoreGlow(selectedDay.score)}`}>
                    {selectedDay.score}
                  </div>
                  <h3 className="text-2xl font-bold text-gray-800 dark:text-gray-200 mb-2">
                    {new Date(selectedDay.date).toLocaleDateString('en-US', { 
                      weekday: 'long', 
                      year: 'numeric', 
                      month: 'long', 
                      day: 'numeric' 
                    })}
                  </h3>
                </div>
                
                <div className="space-y-4 mb-6">
                  <div className="flex justify-between items-center p-3 bg-gray-50 dark:bg-gray-700 rounded-2xl">
                    <span className="font-semibold text-gray-700 dark:text-gray-300">üçΩÔ∏è Calories</span>
                    <span className="font-bold text-gray-800 dark:text-gray-200">{selectedDay.intake.calories.toFixed(0)}</span>
                  </div>
                  <div className="flex justify-between items-center p-3 bg-gray-50 dark:bg-gray-700 rounded-2xl">
                    <span className="font-semibold text-gray-700 dark:text-gray-300">üèÉ Activity</span>
                    <span className="font-bold text-gray-800 dark:text-gray-200">{selectedDay.intake.activity} mins</span>
                  </div>
                  <div className="flex justify-between items-center p-3 bg-gray-50 dark:bg-gray-700 rounded-2xl">
                    <span className="font-semibold text-gray-700 dark:text-gray-300">üíß Water</span>
                    <span className="font-bold text-gray-800 dark:text-gray-200">{selectedDay.intake.water} glasses</span>
                  </div>
                </div>
                
                {selectedDay.meals && selectedDay.meals.length > 0 && (
                  <div className="mb-6">
                    <h4 className="font-bold text-gray-800 dark:text-gray-200 mb-3 flex items-center">
                      <span className="mr-2">üçΩÔ∏è</span>
                      Meals
                    </h4>
                    <div className="space-y-2 max-h-32 overflow-y-auto">
                      {selectedDay.meals.map(m => (
                        <div key={m.id} className="p-2 bg-gray-50 dark:bg-gray-700 rounded-xl text-sm text-gray-700 dark:text-gray-300">
                          {m.name}
                        </div>
                      ))}
                    </div>
                  </div>
                )}
                
                <button 
                  onClick={() => setSelectedDay(null)} 
                  className="w-full bg-gradient-to-r from-purple-500 to-pink-500 text-white font-bold py-4 rounded-2xl hover:from-purple-600 hover:to-pink-600 transition-all duration-200 transform hover:scale-105 shadow-lg"
                >
                  Close
                </button>
              </div>
            </div>
          )}
        </div>
      );
    };

    // --- Helper Components ---

    // Activity Timer Component (for Dashboard)
    const ActivityTimer = ({ onLogActivity }) => {
      const [timeLeft, setTimeLeft] = useState(0);
      const [isActive, setIsActive] = useState(false);
      const [duration, setDuration] = useState(0);
      const timerRef = useRef(null);

      useEffect(() => {
        if (timeLeft > 0 && isActive) {
          timerRef.current = setTimeout(() => setTimeLeft(timeLeft - 1), 1000);
        } else if (timeLeft === 0 && isActive) {
          setIsActive(false);
          onLogActivity({ minutes: duration });
          if ('Notification' in window && Notification.permission === "granted") {
            new Notification("Activity Complete!", { body: `Great job! You've logged ${duration} minutes.` });
          }
        }
        return () => clearTimeout(timerRef.current);
      }, [timeLeft, isActive, onLogActivity, duration]);

      const startTimer = (minutes) => {
        setTimeLeft(minutes * 60);
        setDuration(minutes);
        setIsActive(true);
      };

      const formatTime = (seconds) => {
        const mins = Math.floor(seconds / 60);
        const secs = seconds % 60;
        return `${mins}:${secs < 10 ? '0' : ''}${secs}`;
      };

      if (isActive) {
        return <div className="text-center font-bold text-3xl text-pink-500">{formatTime(timeLeft)}</div>;
      }

      return (
        <div className="space-y-2">
          <p className="font-semibold text-gray-800 dark:text-gray-200 text-center">Start a quick session:</p>
          <div className="grid grid-cols-3 gap-2">
            <button onClick={() => startTimer(10)} className="p-2 bg-pink-500 text-white rounded-lg">10 min</button>
            <button onClick={() => startTimer(20)} className="p-2 bg-pink-500 text-white rounded-lg">20 min</button>
            <button onClick={() => startTimer(30)} className="p-2 bg-pink-500 text-white rounded-lg">30 min</button>
          </div>
        </div>
      );
    };

    // Water Tracker Component (for Dashboard)
    const WaterTracker = ({ onLogWater, dailyIntake, goals }) => {
      useEffect(() => {
        const interval = setInterval(() => {
          if ('Notification' in window && Notification.permission === "granted") {
            new Notification("Stay Hydrated!", { body: "Time for a glass of water to keep you going." });
          }
        }, 2 * 60 * 60 * 1000); // Remind every 2 hours
        return () => clearInterval(interval);
      }, []);

      return (
        <div>
          <p className="font-semibold text-gray-800 dark:text-gray-200 text-center">Water Intake: {dailyIntake.water} / {goals.water} glasses</p>
          <button onClick={onLogWater} className="w-full mt-2 bg-blue-500 text-white font-bold py-2 rounded-xl">Log a Glass</button>
        </div>
      );
    };

    const MacroCard = ({ title, value, goal, unit, color }) => (
      <div className="bg-white dark:bg-gray-800 rounded-2xl p-4 flex flex-col items-center justify-center shadow-md">
        <p className={`font-bold ${color}`}>{title}</p>
        <p className="text-xl font-bold my-1 text-gray-800 dark:text-gray-200">{Math.round(value)}{unit}</p>
        <p className="text-xs text-gray-500 dark:text-gray-400">Goal: {goal}{unit}</p>
      </div>
    );

    const MealCard = ({ meal }) => (
      <div className="flex items-center bg-white dark:bg-gray-800 rounded-2xl p-3 shadow-md">
        <img src={meal.image} alt={meal.name} className="w-16 h-16 rounded-lg" />
        <div className="ml-4 flex-grow">
          <p className="font-bold text-gray-800 dark:text-gray-200">{meal.name}</p>
          <p className="text-gray-500 dark:text-gray-400">{Math.round(meal.calories)} kcal</p>
        </div>
        {meal.mood && (
          <span className="text-3xl">{{ Energized: '‚ö°Ô∏è', Happy: 'üòä', Sluggish: 'üò¥', Bloated: 'ü§¢' }[meal.mood]}</span>
        )}
      </div>
    );

    const GoalItem = ({ label, value }) => (
      <div className="flex justify-between items-center p-2">
        <p className="text-gray-600 dark:text-gray-300">{label}</p>
        <p className="font-bold text-gray-800 dark:text-gray-200">{value}</p>
      </div>
    );

    const SettingItem = ({ label }) => (
      <button className="w-full text-left p-3 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 text-gray-700 dark:text-gray-300 transition-colors">
        {label}
      </button>
    );

    const MealPlanDisplay = ({ mealType, meal }) => (
      <div className="bg-white dark:bg-gray-800 p-6 rounded-2xl shadow-md">
        <h2 className="text-2xl font-bold text-gray-800 dark:text-gray-200 mb-4">{mealType}: {meal.name}</h2>
        <div className="grid md:grid-cols-2 gap-6">
          <div>
            <h3 className="font-semibold mb-2 text-gray-800 dark:text-gray-200">Ingredients:</h3>
            <ul className="list-disc list-inside text-gray-600 dark:text-gray-300">
              {meal.ingredients.map((item, i) => <li key={i}>{item}</li>)}
            </ul>
          </div>
          <div>
            <h3 className="font-semibold mb-2 text-gray-800 dark:text-gray-200">Instructions:</h3>
            <ol className="list-decimal list-inside text-gray-600 dark:text-gray-300 space-y-1">
              {meal.instructions.map((step, i) => <li key={i}>{step}</li>)}
            </ol>
          </div>
        </div>
      </div>
    );


    const BottomNavBar = ({ screen, setScreen }) => (
      <nav className="fixed bottom-0 left-0 right-0 bg-white/80 dark:bg-gray-900/80 backdrop-blur-sm shadow-[0_-2px_10px_rgba(0,0,0,0.05)] dark:shadow-[0_-2px_10px_rgba(0,0,0,0.2)] h-20 flex justify-around items-center px-4">
        <button onClick={() => setScreen('dashboard')} className={`flex flex-col items-center justify-center font-semibold transition-colors ${screen === 'dashboard' ? 'text-pink-500' : 'text-gray-400'}`}>
          <span className="text-2xl mb-1">üè†</span>
        </button>
        <button onClick={() => setScreen('planner')} className={`flex flex-col items-center justify-center font-semibold transition-colors ${screen === 'planner' ? 'text-pink-500' : 'text-gray-400'}`}>
          <span className="text-2xl mb-1">üìã</span>
        </button>
        <button onClick={() => setScreen('progress')} className={`flex flex-col items-center justify-center font-semibold transition-colors ${screen === 'progress' ? 'text-pink-500' : 'text-gray-400'}`}>
          <span className="text-2xl mb-1">üìä</span>
        </button>
        <button onClick={() => setScreen('scan')} className="bg-blue-500 text-white w-14 h-14 rounded-full flex items-center justify-center text-lg font-bold shadow-lg">
          Cal
        </button>
        <button onClick={() => setScreen('workout')} className={`flex flex-col items-center justify-center font-semibold transition-colors ${screen === 'workout' ? 'text-pink-500' : 'text-gray-400'}`}>
          <span className="text-2xl mb-1">üèãÔ∏è</span>
        </button>
        <button onClick={() => setScreen('coach')} className={`flex flex-col items-center justify-center font-semibold transition-colors ${screen === 'coach' ? 'text-pink-500' : 'text-gray-400'}`}>
          <span className="text-2xl mb-1">ü§ñ</span>
        </button>
        <button onClick={() => setScreen('profile')} className={`flex flex-col items-center justify-center font-semibold transition-colors ${screen === 'profile' ? 'text-pink-500' : 'text-gray-400'}`}>
          <span className="text-2xl mb-1">üë§</span>
        </button>
      </nav>
    );

    // --- Mount App ---
    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
  <!-- PDF Generation Library -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
</body>
</html>
