<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Workouts ‚Äî Single File App</title>

  <!-- PERFORMANCE PRELOADS -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link rel="preconnect" href="https://cdn.tailwindcss.com">
  <link rel="preconnect" href="https://unpkg.com">
  <link rel="prefetch" href="/icon-192.png">
  



  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/@lottiefiles/lottie-player@latest/dist/lottie-player.js"></script>
  <script type="module" src="https://unpkg.com/@google/model-viewer@latest/dist/model-viewer.min.js"></script>
  
  <!-- Supabase SDK -->
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script>
    tailwind.config = {
      darkMode: 'class'
    }
  </script>

  <style>
    :root{ --bg:#f9fafb; --bg-dark:#111827; --card:#ffffff; --card-dark:#1f2937; --muted:#9ca3af; --accent:#ec4899; --bottom-nav:80px; }
    html,body{ height:100%; color:#111827; font-family:Inter,system-ui,-apple-system,"Segoe UI",Roboto; -webkit-font-smoothing:antialiased;}
    .dark html,.dark body{ color:#f9fafb; }
    .hero-pattern {
      background-image: linear-gradient(135deg, rgba(59,130,246,0.12), rgba(6,182,212,0.12));
      background-color: #f9fafb; /* light surface to match app */
      background-size: cover;
      background-position: center;
    }
    .dark .hero-pattern {
      background-image: linear-gradient(135deg, rgba(37,99,235,0.10), rgba(6,182,212,0.14)), linear-gradient(180deg, rgba(17,24,39,0.85), rgba(17,24,39,0.85));
      background-color: #111827; /* dark surface to match app */
      background-size: cover;
      background-position: center;
    }
    .card-stats { background: linear-gradient(180deg, rgba(255,255,255,0.9), rgba(255,255,255,0.95)); backdrop-filter: blur(6px); }
    .dark .card-stats { background: linear-gradient(180deg, rgba(31,41,55,0.9), rgba(31,41,55,0.95)); }
    .hidden-view { display:none; }
    .active-view { display:block; }
    .big-circle { width:90px;height:90px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:1.5rem;background: radial-gradient(circle at 30% 30%, #10b981, #059669);box-shadow:0 6px 18px rgba(0,0,0,0.1); }
    .dark .big-circle { box-shadow:0 6px 18px rgba(0,0,0,0.6); }
    .progress-track { height:6px; background: rgba(156,163,175,0.3); border-radius:99px; overflow:hidden; }
    .progress-fill { height:100%; background: linear-gradient(90deg,#ec4899,#3b82f6); width:0%; transition:width .25s linear; }
    .player-overlay { height:calc(100vh - env(safe-area-inset-bottom)); overflow-y:auto; }
    .player-overlay.active-view { display:grid; grid-template-rows: auto auto 1fr auto; }
    /* Info panel helpers */
    .muscle { fill: #f3f4f6; stroke: #d1d5db; stroke-width: 1; transition: all 0.3s ease; }
    .muscle.highlight { fill: rgba(16,185,129,0.7); stroke: #10b981; stroke-width: 2; }
    .dark .muscle { fill: #374151; stroke: #6b7280; }
    .dark .muscle.highlight { fill: rgba(16,185,129,0.6); stroke: #34d399; }
    .muscle-diagram { filter: drop-shadow(0 2px 4px rgba(0,0,0,0.1)); }
    .dark .muscle-diagram { filter: drop-shadow(0 2px 4px rgba(0,0,0,0.3)); }
    .info-chip { font-size: 10px; padding: 3px 8px; border-radius: 9999px; background: #e5f9f1; color: #065f46; display:inline-flex; align-items:center; }
    .dark .info-chip { background: rgba(16,185,129,0.15); color: #a7f3d0; border: 1px solid rgba(16,185,129,0.3); }
    .hero-box { background: linear-gradient(180deg, rgba(255,255,255,0.7), rgba(255,255,255,0.8)); backdrop-filter: blur(8px); border: 1px solid rgba(255,255,255,0.45); }
    .dark .hero-box { background: linear-gradient(180deg, rgba(31,41,55,0.6), rgba(31,41,55,0.7)); border: 1px solid rgba(255,255,255,0.08); }
    /* Ensure the animation elements never show a solid background; smooth crossfade */
    #player-lottie, #player-animation { transition: opacity 250ms ease-in-out; background: transparent !important; }
    .hero-box .w-28.h-28 { background: transparent !important; }
    .chip:focus { outline: 2px solid rgba(236,72,153,0.18); outline-offset: 2px; }
    /* Segmented tabs and bullets for richer info panel */
    .segmented { display:flex; gap:4px; background:#f3f4f6; border-radius:9999px; padding:4px; }
    .dark .segmented { background:rgba(255,255,255,0.08); }
    .segmented button { flex:1; font-weight:600; font-size:12px; padding:6px 10px; border-radius:9999px; color:#065f46; background:transparent; }
    .segmented button.active { background:#10b981; color:#000; box-shadow:0 1px 4px rgba(0,0,0,0.12); }
    .dark .segmented button.active { background:#10b981; color:#000; }
    .list-bullets { margin-top:6px; }
    .list-bullets li { display:flex; gap:8px; margin:6px 0; font-size:12px; color:#374151; }
    .list-bullets li::before { content:"‚Ä¢"; color:#10b981; font-weight:700; }
    .dark .list-bullets li { color:#d1d5db; }
    .bottom-safe { padding-bottom: env(safe-area-inset-bottom); }
    body.player-active { 
      overflow:hidden; 
      padding-bottom:0 !important; 
    }
    

    /* Pink‚Äëtinted Progress gradient; configurable via CSS var */
    body {
      background-color: #f9fafb; /* light surface */
      background-image: var(
        --wallpaperImage,
        linear-gradient(135deg, #eff6ff 0%, #ecfeff 45%, #eef2ff 100%)
      );
      background-size: cover;
      background-attachment: fixed;
      background-repeat: no-repeat;
    }
    .dark body {
      background-color: #111827; /* dark surface */
      background-image: var(
        --wallpaperImage,
        linear-gradient(135deg, rgba(17,24,39,1) 0%, rgba(29,78,216,0.20) 55%, rgba(6,182,212,0.20) 100%)
      );
      background-size: cover;
      background-attachment: fixed;
      background-repeat: no-repeat;
    }
    body.wallpaper-off { --wallpaperImage: none; }
    #app.player-active { padding-top:0 !important; padding-bottom:0 !important; height:100vh; min-height:100vh; overflow:hidden; }
    /* Universal title spacing fix for workout cards */
    .hero-pattern .absolute { padding-top: 1.25rem; padding-left: 1.25rem; padding-right: 1.25rem; }
    .hero-pattern .absolute span.font-extrabold { display: inline-block; line-height: 1.15; margin-bottom: 8px; }
    @media (min-width:1024px){ .page-title { font-size:3rem; } .card-title{ font-size:1.5rem; } }
  </style>
    <script>
      // Dark mode detection - must run before body renders
      // Sync with index.html dark mode settings (default to dark when unset)
      const rawTheme = localStorage.getItem('fitmate-dark-mode');
      const isDarkMode = (rawTheme === null) ? true : (rawTheme === 'true');
      if (isDarkMode) {
        document.documentElement.classList.add('dark')
      } else {
        document.documentElement.classList.remove('dark')
      }
      // Allow disabling gradient only via explicit query flag (runs early)
      try {
        const params = new URLSearchParams(location.search);
        const noWallpaperFlag = params.get('no_wallpaper');
        const disableWallpaper = noWallpaperFlag === '1' || noWallpaperFlag === 'true' || params.has('no_wallpaper');
        if (disableWallpaper) {
          document.documentElement.style.setProperty('--wallpaperImage', 'none');
        }
      } catch(_) { /* noop */ }
    </script>
  <!-- PWA manifest + theme -->
  <link rel="manifest" href="/manifest.json">
  <meta name="theme-color" content="#ec4899"> <!-- main app pink -->
  <meta name="color-scheme" content="light dark"> <!-- Let browser auto-select Light/dark -->

  <!-- icons (ensure these files exist at repo root) -->
  <link rel="icon" href="/icon.png">
  <link rel="apple-touch-icon" href="/icon-192.png">
  <script>
    // Conditionally load AdSense: iOS (iPhone/iPad/iPod) and desktop only. Never on Android.
    // Also disable for subscribed users and react to runtime subscription changes.
    (function(){
      try {
        var ua = navigator.userAgent || '';
        var plat = (navigator.userAgentData && navigator.userAgentData.platform) || '';
        var isAndroid = /Android/i.test(ua) || /Android/i.test(plat);
        var isIPhone = /iPhone/i.test(ua);
        var isIPadUA = /iPad/i.test(ua);
        var isIPadLikeMac = /Macintosh/.test(ua) && navigator.maxTouchPoints > 1; // iPadOS masquerades as Mac
        var isIPad = isIPadUA || isIPadLikeMac;
        var isIPod = /iPod/i.test(ua);
        var isIOS = isIPhone || isIPad || isIPod;
        var isDesktop = !(isAndroid || isIOS || /Mobile/i.test(ua));
        var subscribed = false; try { subscribed = JSON.parse(localStorage.getItem('subscriptionActive') || 'false') === true; } catch(_) {}

        function qualifiesForAdsense(){ return (isIOS || isDesktop) && !subscribed; }
        function injectAdsense(){
          if (!window.__adsenseLoaded) {
            var s = document.createElement('script');
            s.async = true;
            s.src = 'https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-4496629998193729';
            s.crossOrigin = 'anonymous';
            document.head.appendChild(s);
            window.__adsenseLoaded = true;
          }
        }
        function hideAdsenseUnits(){
          try { document.querySelectorAll('ins.adsbygoogle, iframe[id^="google_ads_iframe"], .google-auto-placed').forEach(function(el){ el.style.display='none'; }); } catch(_) {}
        }

        var shouldLoadAdsense = qualifiesForAdsense();
        if (shouldLoadAdsense) injectAdsense(); else hideAdsenseUnits();

        // Expose for any runtime checks (match index.html keys)
        window.__fitmateAds = { android: isAndroid, iphone: isIPhone, ipad: isIPad, ipod: isIPod, ios: isIOS, desktop: isDesktop, subscribed: subscribed, adsense: shouldLoadAdsense };

        // React to runtime subscription changes
        window.addEventListener('subscription-status-changed', function(e){
          try {
            subscribed = !!(e && e.detail && e.detail.active);
            window.__fitmateAds.subscribed = subscribed;
            window.__fitmateAds.adsense = qualifiesForAdsense();
            if (window.__fitmateAds.adsense) { injectAdsense(); } else { hideAdsenseUnits(); }
          } catch(_) {}
        });
      } catch (e) { /* no-op */ }
    })();
  </script>

  <script>
(function () {
  console.log('üé§ Initializing TTS bridge for Android WebView...');
  
  // Check if we're in Android WebView
  const isAndroidWebView = /Android/i.test(navigator.userAgent) && 
                           typeof window.AndroidTTS !== 'undefined';
  
  if (isAndroidWebView) {
    console.log('‚úÖ Android WebView detected, using native TTS bridge');
    
    // Override speechSynthesis.speak to use native Android TTS
    if (window.speechSynthesis) {
      const originalSpeak = window.speechSynthesis.speak.bind(window.speechSynthesis);
      
      window.speechSynthesis.speak = function(utterance) {
        try {
          const text = typeof utterance === 'string' ? utterance : (utterance?.text || '');
          const rate = utterance?.rate || 1.0;
          const pitch = utterance?.pitch || 1.0;
          
          if (text && window.AndroidTTS && window.AndroidTTS.speak) {
            console.log('üì¢ Speaking via AndroidTTS:', text);
            window.AndroidTTS.speak(text, rate, pitch);
            return;
          }
        } catch (e) {
          console.error('AndroidTTS error:', e);
        }
        
        // Fallback to original (won't work in WebView but won't crash)
        try { originalSpeak(utterance); } catch (e) {}
      };
      
      // Override cancel/pause/resume for completeness
      window.speechSynthesis.cancel = function() {
        if (window.AndroidTTS && window.AndroidTTS.stop) {
          window.AndroidTTS.stop();
        }
      };
    }
  } else {
    console.log('‚ÑπÔ∏è Using browser native speechSynthesis');
  }
})();
</script>

  </head>
<body class="bottom-safe bg-gray-50 dark:bg-gray-900 text-gray-900 dark:text-white">
  <!-- Background Music Audio Element -->
  <audio id="background-music" loop preload="none">
    <source src="./Gym.mp3" type="audio/mpeg">
    Your browser does not support the audio element.
  </audio>

  <!-- APP CONTAINER -->
  <div id="app" class="max-w-3xl mx-auto px-4 pt-6 pb-28">

    <!-- VIEW: Workouts List (default) -->
    <section id="view-list" class="active-view">
      <header class="mb-4">
          <h1 class="text-2xl font-bold text-gray-800 dark:text-gray-200 text-center">üèÉTraining</h1>
          <p class="text-gray-600 dark:text-gray-400 mt-2 text-center">Choose your training for today</p>
        </header>

      <div id="workouts" class="space-y-6 mt-6"></div>
    </section>

    <!-- VIEW: Detail -->
    <section id="view-detail" class="hidden-view">
      <div class="flex items-center gap-3 mb-4">
        <button id="detail-back" class="text-gray-600 dark:text-gray-300 hover:text-gray-900 dark:hover:text-white" title="Back to list">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7"/></svg>
        </button>
        <h1 id="detail-title" class="text-2xl font-extrabold text-gray-900 dark:text-white">Workout Title</h1>
      </div>

      <p id="detail-desc" class="text-gray-600 dark:text-gray-400 mb-3">Workout description</p>

      <div class="flex items-center gap-3 mb-6">
        <div class="flex items-center gap-1 text-gray-700 dark:text-gray-200">
          <svg class="w-5 h-5 text-pink-500" fill="none" stroke="currentColor" stroke-width="1.6" viewBox="0 0 24 24"><circle cx="12" cy="12" r="9"/><path d="M12 7v5l3 2"/></svg>
          <span id="detail-duration">20 min</span>
        </div>
        <div class="flex items-center gap-1 text-gray-700 dark:text-gray-200">
          <svg class="w-5 h-5 text-pink-500" fill="none" stroke="currentColor" stroke-width="1.6" viewBox="0 0 24 24"><circle cx="12" cy="12" r="3"/><circle cx="12" cy="12" r="7" opacity="0.3"/></svg>
          <span id="detail-count">5 exercises</span>
        </div>
        <span id="detail-badge" class="ml-auto text-xs font-bold px-3 py-1 rounded-full bg-green-500 text-black">Beginner</span>
      </div>

      <section>
        <h2 class="text-lg font-semibold mb-3">Exercises</h2>
        <div id="detail-exList" class="space-y-4"></div>
      </section>

      <div class="mt-8">
        <button id="detail-start" class="w-full py-4 rounded-xl font-semibold text-white text-lg bg-pink-500 hover:bg-pink-600 flex items-center justify-center gap-2 shadow-lg transition-colors">
          <svg class="w-6 h-6" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M8 5v14l11-7z" stroke-linecap="round" stroke-linejoin="round"/></svg>
          Start Workout
        </button>
      </div>
    </section>

    <!-- VIEW: Player -->
    <section id="view-player" class="hidden-view player-overlay">
      <div class="px-4 pt-3 pb-2">
        <div class="flex items-center gap-3">
          <button id="player-close" class="text-gray-600 dark:text-gray-300 hover:text-gray-900 dark:hover:text-white" title="Close workout">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"/></svg>
          </button>

          <div class="flex-1 text-center">
            <div id="player-progress-label" class="text-sm text-gray-600 dark:text-gray-300">1 of 5</div>
            <div class="mt-2 progress-track">
              <div id="player-progress-fill" class="progress-fill"></div>
            </div>
          </div>

          <div class="flex items-center gap-2">
            <!-- Voice Gender Toggle -->
            <button id="player-voice-gender" class="px-2 py-1 text-xs font-medium rounded-md bg-pink-100 dark:bg-pink-900 text-pink-700 dark:text-pink-300 hover:bg-pink-200 dark:hover:bg-pink-800 transition-colors" title="Switch voice gender">
              <span id="voice-gender-text">‚ôÄ</span>
            </button>
            
            <!-- Voice Mute/Unmute Toggle -->
            <button id="player-voice" class="p-2 rounded-lg transition-colors" title="Toggle voice">
              <svg id="player-voice-icon" class="w-5 h-5" viewBox="0 0 24 24" fill="currentColor">
                <path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z"/>
              </svg>
            </button>
          </div>
        </div>
      </div>

      <!-- Tip/Disclaimer -->
      <div class="mx-4 mb-2 px-3 py-2 bg-blue-50 dark:bg-blue-900/30 border border-blue-200 dark:border-blue-700 rounded-lg text-center">
        <div class="flex items-center justify-center gap-3">
          <div class="flex-shrink-0 mt-0.5">
            <svg class="w-4 h-4 text-blue-500" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"/>
            </svg>
          </div>
          <div class="text-sm text-blue-700 dark:text-blue-300 text-center">
            <span class="font-medium">üí° Tip:</span> If you exit the player, it will start a new session.
          </div>
        </div>
      </div>

      <div class="flex flex-col items-center px-4 pt-1 pb-1 flex-1 justify-center">
        <div class="inline-block bg-transparent"><span class="text-xs font-semibold px-4 py-2 rounded-full bg-green-500 text-black">EXERCISE</span></div>

        <h2 id="player-title" class="text-xl font-extrabold mt-2 text-center text-gray-900 dark:text-white">Jumping Jacks</h2>
        <p id="player-set-info" class="text-gray-600 dark:text-gray-300 mt-1">Set 1 of 3</p>

        <div class="mt-2 w-48 h-48 hero-box rounded-2xl p-2 flex flex-col items-center justify-center">
          <div class="w-full h-full flex items-center justify-center rounded-lg bg-transparent overflow-hidden transition-colors relative">
            <lottie-player id="player-lottie" background="transparent" style="width:100%;height:100%;display:none" speed="1" loop autoplay></lottie-player>
            <video id="player-animation" class="absolute inset-0 w-full h-full object-cover rounded-lg" autoplay loop muted playsinline preload="auto" style="display:none; opacity:1;">
              <source src="" type="video/mp4">
            </video>
            <!-- Secondary video used to preload next exercise and crossfade -->
            <video id="player-animation-next" class="absolute inset-0 w-full h-full object-cover rounded-lg" autoplay loop muted playsinline preload="auto" style="display:none; opacity:0;"></video>
            <div id="player-animation-fallback" class="text-center text-gray-600 dark:text-gray-300">
              <div style="font-size:32px">üèãÔ∏è</div>
              <div class="mt-1 text-xs">Exercise Animation</div>
            </div>
          </div>
        </div>

        <div class="mt-3 flex flex-col items-center">
          <div id="player-timer" class="big-circle">00:24</div>
          <div id="player-reps" class="text-gray-600 dark:text-gray-300 mt-2">20 repetitions</div>
        </div>
      </div>

      <div class="px-4 pt-0 pb-3">
        <div class="flex items-center justify-between">
          <button id="player-skip" class="flex items-center gap-2 text-gray-600 dark:text-gray-300">
            <svg class="w-6 h-6" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><path d="M5 4v16l11-8zM19 5v14" stroke-linecap="round" stroke-linejoin="round"/></svg>
            <span class="text-sm">Skip</span>
          </button>

          <button id="player-pause" class="mx-4 w-16 h-16 rounded-2xl bg-pink-500 flex items-center justify-center text-white text-xl shadow-lg">
            ||
          </button>

          <div style="width:48px"></div>
        </div>
      </div>
      <!-- Info panel under controls -->
      <div id="player-info" class="px-4 pb-4 mt-2">
        <div class="rounded-2xl bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 shadow-sm p-3">
          <div class="grid grid-cols-3 gap-3">
            <div>
              <div class="text-xs text-gray-500 dark:text-gray-400">Duration</div>
              <div id="info-duration" class="text-sm font-semibold text-gray-800 dark:text-gray-200">00:30</div>
            </div>
            <div class="col-span-2">
              <div class="text-xs text-gray-500 dark:text-gray-400">Focus area</div>
              <div id="info-focus" class="mt-1 flex flex-wrap gap-1"></div>
            </div>
          </div>
          <div class="mt-2">
            <div class="text-xs font-semibold text-gray-700 dark:text-gray-300">Instructions</div>
            <p id="info-instructions" class="text-xs text-gray-600 dark:text-gray-300 mt-1 leading-relaxed"></p>
            
            <div class="mt-3 flex items-center justify-center gap-6">
              <!-- Front View Human Figure - Anatomically Accurate -->
              <svg id="muscle-front" width="110" height="150" viewBox="0 0 110 150" class="muscle-diagram">
                <ellipse cx="55" cy="10" rx="7" ry="8" fill="#fef3c7" stroke="#d1d5db" stroke-width="0.8"/>
                <circle cx="53" cy="9" r="1.5" fill="#374151"/><circle cx="57" cy="9" r="1.5" fill="#374151"/>
                <path d="M50 16 L50 22 L60 22 L60 16" fill="#fef3c7" stroke="#d1d5db" stroke-width="0.8"/>
                <path d="M42 22 Q45 20 50 20 Q55 20 60 20 Q65 20 68 22 L66 28 Q55 26 44 28 Z" class="muscle muscle-traps" fill="#f3f4f6" stroke="#d1d5db" stroke-width="0.8"/>
                <ellipse cx="38" cy="30" rx="6" ry="9" class="muscle muscle-shoulders" fill="#f3f4f6" stroke="#d1d5db" stroke-width="0.8" transform="rotate(-15 38 30)"/>
                <ellipse cx="72" cy="30" rx="6" ry="9" class="muscle muscle-shoulders" fill="#f3f4f6" stroke="#d1d5db" stroke-width="0.8" transform="rotate(15 72 30)"/>
                <path d="M48 24 Q50 23 55 23 Q55 28 54 32 Q50 34 48 32 Z" class="muscle muscle-chest" fill="#f3f4f6" stroke="#d1d5db" stroke-width="0.8"/>
                <path d="M62 24 Q60 23 55 23 Q55 28 56 32 Q60 34 62 32 Z" class="muscle muscle-chest" fill="#f3f4f6" stroke="#d1d5db" stroke-width="0.8"/>
                <ellipse cx="35" cy="42" rx="4" ry="8" class="muscle muscle-biceps" fill="#f3f4f6" stroke="#d1d5db" stroke-width="0.8"/>
                <ellipse cx="75" cy="42" rx="4" ry="8" class="muscle muscle-biceps" fill="#f3f4f6" stroke="#d1d5db" stroke-width="0.8"/>
                <path d="M33 51 L31 52 L30 66 L32 67 L34 66 L35 52 Z" class="muscle muscle-forearms" fill="#f3f4f6" stroke="#d1d5db" stroke-width="0.8"/>
                <path d="M77 51 L79 52 L80 66 L78 67 L76 66 L75 52 Z" class="muscle muscle-forearms" fill="#f3f4f6" stroke="#d1d5db" stroke-width="0.8"/>
                <rect x="48" y="36" width="6" height="5" rx="1.5" class="muscle muscle-abs" fill="#f3f4f6" stroke="#d1d5db" stroke-width="0.8"/>
                <rect x="56" y="36" width="6" height="5" rx="1.5" class="muscle muscle-abs" fill="#f3f4f6" stroke="#d1d5db" stroke-width="0.8"/>
                <rect x="48" y="42" width="6" height="5" rx="1.5" class="muscle muscle-abs" fill="#f3f4f6" stroke="#d1d5db" stroke-width="0.8"/>
                <rect x="56" y="42" width="6" height="5" rx="1.5" class="muscle muscle-abs" fill="#f3f4f6" stroke="#d1d5db" stroke-width="0.8"/>
                <rect x="48" y="48" width="6" height="5" rx="1.5" class="muscle muscle-abs" fill="#f3f4f6" stroke="#d1d5db" stroke-width="0.8"/>
                <rect x="56" y="48" width="6" height="5" rx="1.5" class="muscle muscle-abs" fill="#f3f4f6" stroke="#d1d5db" stroke-width="0.8"/>
                <path d="M44 42 L42 44 L40 50 L41 54 L44 54 L45 48 Z" class="muscle muscle-obliques" fill="#f3f4f6" stroke="#d1d5db" stroke-width="0.8"/>
                <path d="M66 42 L68 44 L70 50 L69 54 L66 54 L65 48 Z" class="muscle muscle-obliques" fill="#f3f4f6" stroke="#d1d5db" stroke-width="0.8"/>
                <path d="M44 54 Q48 56 55 56 Q62 56 66 54 L64 62 Q55 64 46 62 Z" fill="#f9fafb" stroke="#d1d5db" stroke-width="0.8"/>
                <path d="M46 56 L44 58 L43 64 L45 64 L47 60 Z" class="muscle muscle-hip-flexors" fill="#f3f4f6" stroke="#d1d5db" stroke-width="0.8"/>
                <path d="M64 56 L66 58 L67 64 L65 64 L63 60 Z" class="muscle muscle-hip-flexors" fill="#f3f4f6" stroke="#d1d5db" stroke-width="0.8"/>
                <ellipse cx="46" cy="75" rx="4.5" ry="13" class="muscle muscle-quadriceps" fill="#f3f4f6" stroke="#d1d5db" stroke-width="0.8"/>
                <ellipse cx="52" cy="75" rx="3.5" ry="12" class="muscle muscle-quadriceps" fill="#f3f4f6" stroke="#d1d5db" stroke-width="0.8"/>
                <ellipse cx="58" cy="75" rx="3.5" ry="12" class="muscle muscle-quadriceps" fill="#f3f4f6" stroke="#d1d5db" stroke-width="0.8"/>
                <ellipse cx="64" cy="75" rx="4.5" ry="13" class="muscle muscle-quadriceps" fill="#f3f4f6" stroke="#d1d5db" stroke-width="0.8"/>
                <path d="M52 66 L54 66 L55 85 L54 86 L52 85 Z" class="muscle muscle-adductors" fill="#f3f4f6" stroke="#d1d5db" stroke-width="0.8"/>
                <path d="M58 66 L56 66 L55 85 L56 86 L58 85 Z" class="muscle muscle-adductors" fill="#f3f4f6" stroke="#d1d5db" stroke-width="0.8"/>
                <ellipse cx="48" cy="92" rx="4" ry="3" fill="#fef3c7" stroke="#d1d5db" stroke-width="0.8"/>
                <ellipse cx="62" cy="92" rx="4" ry="3" fill="#fef3c7" stroke="#d1d5db" stroke-width="0.8"/>
                <ellipse cx="48" cy="108" rx="4" ry="10" class="muscle muscle-calves" fill="#f3f4f6" stroke="#d1d5db" stroke-width="0.8"/>
                <ellipse cx="62" cy="108" rx="4" ry="10" class="muscle muscle-calves" fill="#f3f4f6" stroke="#d1d5db" stroke-width="0.8"/>
                <ellipse cx="46" cy="125" rx="5" ry="3" fill="#fef3c7" stroke="#d1d5db" stroke-width="0.8"/>
                <ellipse cx="64" cy="125" rx="5" ry="3" fill="#fef3c7" stroke="#d1d5db" stroke-width="0.8"/>
                <ellipse cx="30" cy="68" rx="3" ry="4" fill="#fef3c7" stroke="#d1d5db" stroke-width="0.8"/>
                <ellipse cx="80" cy="68" rx="3" ry="4" fill="#fef3c7" stroke="#d1d5db" stroke-width="0.8"/>
              </svg>
              
              <!-- Back View Human Figure - Anatomically Accurate -->
              <svg id="muscle-back" width="110" height="150" viewBox="0 0 110 150" class="muscle-diagram">
                <ellipse cx="55" cy="10" rx="7" ry="8" fill="#fef3c7" stroke="#d1d5db" stroke-width="0.8"/>
                <path d="M50 16 L50 22 L60 22 L60 16" fill="#fef3c7" stroke="#d1d5db" stroke-width="0.8"/>
                <path d="M42 22 Q45 21 50 21 Q55 20 60 21 Q65 21 68 22 L68 32 Q66 36 60 38 L50 38 Q44 36 42 32 Z" class="muscle muscle-traps" fill="#f3f4f6" stroke="#d1d5db" stroke-width="0.8"/>
                <ellipse cx="38" cy="30" rx="6" ry="9" class="muscle muscle-shoulders" fill="#f3f4f6" stroke="#d1d5db" stroke-width="0.8" transform="rotate(-15 38 30)"/>
                <ellipse cx="72" cy="30" rx="6" ry="9" class="muscle muscle-shoulders" fill="#f3f4f6" stroke="#d1d5db" stroke-width="0.8" transform="rotate(15 72 30)"/>
                <ellipse cx="35" cy="42" rx="4" ry="9" class="muscle muscle-triceps" fill="#f3f4f6" stroke="#d1d5db" stroke-width="0.8"/>
                <ellipse cx="75" cy="42" rx="4" ry="9" class="muscle muscle-triceps" fill="#f3f4f6" stroke="#d1d5db" stroke-width="0.8"/>
                <path d="M33 51 L31 52 L30 66 L32 67 L34 66 L35 52 Z" class="muscle muscle-forearms" fill="#f3f4f6" stroke="#d1d5db" stroke-width="0.8"/>
                <path d="M77 51 L79 52 L80 66 L78 67 L76 66 L75 52 Z" class="muscle muscle-forearms" fill="#f3f4f6" stroke="#d1d5db" stroke-width="0.8"/>
                <path d="M46 32 Q48 34 50 38 L50 50 Q48 52 46 54 L42 48 Q40 42 42 36 Z" class="muscle muscle-lats" fill="#f3f4f6" stroke="#d1d5db" stroke-width="0.8"/>
                <path d="M64 32 Q62 34 60 38 L60 50 Q62 52 64 54 L68 48 Q70 42 68 36 Z" class="muscle muscle-lats" fill="#f3f4f6" stroke="#d1d5db" stroke-width="0.8"/>
                <ellipse cx="50" cy="45" rx="3" ry="8" class="muscle muscle-lower-back" fill="#f3f4f6" stroke="#d1d5db" stroke-width="0.8"/>
                <ellipse cx="60" cy="45" rx="3" ry="8" class="muscle muscle-lower-back" fill="#f3f4f6" stroke="#d1d5db" stroke-width="0.8"/>
                <path d="M47 50 Q50 52 55 52 Q60 52 63 50 L62 58 Q55 60 48 58 Z" class="muscle muscle-lower-back" fill="#f3f4f6" stroke="#d1d5db" stroke-width="0.8"/>
                <ellipse cx="47" cy="66" rx="6" ry="8" class="muscle muscle-glutes" fill="#f3f4f6" stroke="#d1d5db" stroke-width="0.8"/>
                <ellipse cx="63" cy="66" rx="6" ry="8" class="muscle muscle-glutes" fill="#f3f4f6" stroke="#d1d5db" stroke-width="0.8"/>
                <ellipse cx="45" cy="80" rx="4" ry="12" class="muscle muscle-hamstrings" fill="#f3f4f6" stroke="#d1d5db" stroke-width="0.8"/>
                <ellipse cx="51" cy="82" rx="3" ry="11" class="muscle muscle-hamstrings" fill="#f3f4f6" stroke="#d1d5db" stroke-width="0.8"/>
                <ellipse cx="59" cy="82" rx="3" ry="11" class="muscle muscle-hamstrings" fill="#f3f4f6" stroke="#d1d5db" stroke-width="0.8"/>
                <ellipse cx="65" cy="80" rx="4" ry="12" class="muscle muscle-hamstrings" fill="#f3f4f6" stroke="#d1d5db" stroke-width="0.8"/>
                <ellipse cx="48" cy="92" rx="4" ry="3" fill="#fef3c7" stroke="#d1d5db" stroke-width="0.8"/>
                <ellipse cx="62" cy="92" rx="4" ry="3" fill="#fef3c7" stroke="#d1d5db" stroke-width="0.8"/>
                <ellipse cx="47" cy="105" rx="5" ry="11" class="muscle muscle-calves" fill="#f3f4f6" stroke="#d1d5db" stroke-width="0.8"/>
                <ellipse cx="63" cy="105" rx="5" ry="11" class="muscle muscle-calves" fill="#f3f4f6" stroke="#d1d5db" stroke-width="0.8"/>
                <ellipse cx="46" cy="125" rx="5" ry="3" fill="#fef3c7" stroke="#d1d5db" stroke-width="0.8"/>
                <ellipse cx="64" cy="125" rx="5" ry="3" fill="#fef3c7" stroke="#d1d5db" stroke-width="0.8"/>
                <ellipse cx="30" cy="68" rx="3" ry="4" fill="#fef3c7" stroke="#d1d5db" stroke-width="0.8"/>
                <ellipse cx="80" cy="68" rx="3" ry="4" fill="#fef3c7" stroke="#d1d5db" stroke-width="0.8"/>
              </svg>
            </div>
            
            <div class="mt-3 text-xs font-semibold text-gray-700 dark:text-gray-300">Common Mistakes</div>
            <ul id="info-mistakes" class="list-bullets"></ul>
            
            <div class="mt-3 text-xs font-semibold text-gray-700 dark:text-gray-300">Breathing Tips</div>
            <ul id="info-tips" class="list-bullets"></ul>
          </div>
        </div>
      </div>
    </section>



  </div>

  <script>
  /***********************
   * Single-file SPA logic
   ***********************/

  // Data model (single source) - 9 Comprehensive Workouts
  const WORKOUTS = [
    // BEGINNER WORKOUTS
    {
      title:'Upper Body', 
      desc:'Introduction to upper body strength with basic movements',
      duration:'18 min',
      difficulty:'beginner',
      tag:'Upper Body',
      exercises:[
        { title:'Cobras', sets:2, reps:8, rest:60, muscles:'Back, Core', durationSeconds:30, animation:'Cobras.mp4', description:'Lie face down with hands under shoulders. Lift chest and head up by extending spine, keeping hips on ground. Lower slowly back down.' },
        { title:'Military Push Ups', sets:2, reps:5, rest:60, muscles:'Chest, Arms', durationSeconds:35, animation:'Military Push Ups.mp4', description:'Start in plank position with hands directly under shoulders. Lower body as one unit until chest nearly touches ground, then push back up.' },
        { title:'Plank', sets:2, reps:0, rest:60, muscles:'Core, Arms', durationSeconds:20, animation:'Plank.mp4', description:'Start on knees and forearms. Keep body straight from knees to head. Engage core and hold position without letting hips sag.' },
        { title:'Punches', sets:2, reps:12, rest:45, muscles:'Arms, Shoulders', durationSeconds:25, animation:'Punches.mp4', description:'Stand with feet shoulder-width apart. Throw alternating punches forward with controlled movements. Keep core engaged and maintain good form.' }
      ]
    },

    {
      title:'Lower Body',
      desc:'Build lower body strength with basic movements',
      duration:'22 min',
      difficulty:'beginner',
      tag:'Lower Body',
      exercises:[
        { title:'Squats', sets:2, reps:10, rest:60, muscles:'Quadriceps, Glutes', durationSeconds:35, animation:'Squats.mp4', description:'Stand with feet shoulder-width apart. Lower hips back and down as if sitting in a chair. Keep chest up and knees behind toes. Return to standing.' },
        { title:'Squat Reach', sets:2, reps:8, rest:45, muscles:'Quads, Glutes', durationSeconds:30, animation:'Squat Reach.mp4', description:'Perform a squat while reaching arms overhead. Lower into squat position while raising arms up, then return to standing with arms down.' },
        { title:'Single Leg Hip Rotation', sets:2, reps:10, rest:45, muscles:'Hip Flexors', durationSeconds:35, animation:'Single Leg Hip Rotation.mp4', description:'Stand on one leg, lift the other knee to hip height. Rotate the lifted leg in small circles, engaging hip muscles. Switch legs.' },
        { title:'Bridge', sets:2, reps:12, rest:45, muscles:'Glutes', durationSeconds:30, animation:'Bridge.mp4', description:'Lie on back with knees bent, feet flat on floor. Squeeze glutes and lift hips up, creating straight line from knees to shoulders. Lower slowly.' },
        { title:'Calf Raise', sets:2, reps:15, rest:30, muscles:'Calves', durationSeconds:25, animation:'calfraise.mp4', description:'Stand tall with feet hip-width apart. Rise up onto toes by lifting heels as high as possible. Hold briefly, then lower heels back down slowly.' }
      ]
    },

    {
      title:'Full Body',
      desc:'Complete body workout with gentle movements',
      duration:'25 min',
      difficulty:'beginner',
      tag:'Full Body',
      exercises:[
        { title:'Jumping Jack', sets:2, reps:15, rest:45, muscles:'Full Body, Cardio, Legs, Shoulders', durationSeconds:25, animation:'Jumping Jack.mp4', description:'Start with feet together, arms at sides. Jump feet apart while raising arms overhead. Jump back to starting position.' },
        { title:'Standing Side Bends', sets:2, reps:12, rest:30, muscles:'Core, Obliques', durationSeconds:25, animation:'StandingSideBends.mp4', description:'Stand with feet hip-width apart, hands on hips. Lean to one side, engaging obliques. Return to center and repeat on other side.' },
        { title:'Bridge', sets:2, reps:10, rest:45, muscles:'Glutes, Core, Hamstrings', durationSeconds:30, animation:'Bridge.mp4', description:'Lie on back with knees bent, feet flat on floor. Squeeze glutes and lift hips up, creating straight line from knees to shoulders. Lower slowly.' },
        { title:'Squats', sets:2, reps:8, rest:45, muscles:'Legs, Quadriceps, Glutes', durationSeconds:30, animation:'Squats.mp4', description:'Stand with feet shoulder-width apart. Lower hips back and down as if sitting in a chair. Keep chest up and knees behind toes. Return to standing.' }
      ]
    },

    // INTERMEDIATE WORKOUTS
    {
      title:'Upper Body',
      desc:'Build strength in chest, arms, and shoulders',
      duration:'25 min',
      difficulty:'intermediate',
      tag:'Upper Body',
      exercises:[
        { title:'Cobras', sets:3, reps:10, rest:60, muscles:'Back, Core', durationSeconds:35, animation:'Cobras.mp4', description:'Lie face down with hands under shoulders. Lift chest and head up by extending spine, keeping hips on ground. Lower slowly back down.', 
          mistakes: ['Lifting too high and straining the neck', 'Using arms to push up instead of back muscles', 'Lifting hips off the ground', 'Holding breath during the movement'],
          tips: ['Exhale as you lift your chest up', 'Inhale as you lower back down', 'Keep breathing steady and controlled', 'Focus on lengthening the spine with each breath'] },
        { title:'Military Push Ups', sets:3, reps:10, rest:60, muscles:'Chest, Triceps', durationSeconds:40, animation:'Military Push Ups.mp4', description:'Start in plank position. Lower chest to floor by bending elbows, keeping body straight. Push back up to starting position.',
          mistakes: ['Sagging hips or arching back', 'Not going down far enough', 'Flaring elbows too wide', 'Holding breath during reps'],
          tips: ['Exhale forcefully as you push up', 'Inhale as you lower down', 'Maintain steady breathing rhythm', 'Breathe through your nose when possible'] },
        { title:'Wide Arm Push Ups', sets:3, reps:8, rest:60, muscles:'Chest, Arms', durationSeconds:40, animation:'Widearmpushup.mp4', description:'Place hands wider than shoulder-width apart. Perform push-up with wide hand position, targeting outer chest muscles. Keep body straight throughout.',
          mistakes: ['Placing hands too wide causing shoulder strain', 'Not maintaining straight body line', 'Partial range of motion', 'Rushing through the movement'],
          tips: ['Exhale as you press up from the bottom', 'Inhale deeply as you lower your chest', 'Use controlled breathing to maintain rhythm', 'Take a breath at the top if needed'] },
        { title:'Staggered Push-ups', sets:3, reps:8, rest:45, muscles:'Chest, Core', durationSeconds:35, animation:'Staggeredpushups.mp4', description:'Place one hand forward and one back in staggered position. Perform push-up, then switch hand positions. Challenges stability and unilateral strength.',
          mistakes: ['Not switching hand positions between sets', 'Allowing body to twist or rotate', 'Uneven weight distribution', 'Moving too quickly without control'],
          tips: ['Exhale as you push up from staggered position', 'Inhale as you lower with control', 'Breathe steadily to maintain balance', 'Focus on core breathing for stability'] },
        { title:'Plank', sets:3, reps:0, rest:45, muscles:'Core, Shoulders', durationSeconds:40, animation:'Plank.mp4', description:'Hold plank position with straight body from head to heels. Keep core engaged and maintain neutral spine. Focus on stability and endurance.',
          mistakes: ['Sagging hips or raising butt too high', 'Looking up and straining neck', 'Holding breath during the hold', 'Placing hands too far forward'],
          tips: ['Breathe normally and steadily throughout', 'Inhale and exhale at regular intervals', 'Use breathing to help engage your core', 'Never hold your breath during planks'] }
      ]
    },

    {
      title:'Lower Body',
      desc:'Advanced lower body training with dynamic movements',
      duration:'28 min',
      difficulty:'intermediate',
      tag:'Lower Body',
      exercises:[
        { title:'Squat Kicks', sets:3, reps:12, rest:60, muscles:'Legs, Glutes', durationSeconds:40, animation:'Squat kicks.mp4', description:'Perform a squat, then explode up into a jump. Land softly and immediately go into next squat. Keep chest up throughout.',
          mistakes: ['Landing hard on heels', 'Not squatting deep enough before jump', 'Leaning forward during squat', 'Not controlling the landing'],
          tips: ['Exhale explosively during the jump', 'Inhale as you squat down', 'Quick breath at the top before next rep', 'Use breathing to power the explosive movement'] },
        
        { title:'Split Jump Exercise', sets:3, reps:8, rest:60, muscles:'Legs, Power', durationSeconds:40, animation:'Split Jump Exercise.mp4', description:'Start in lunge position. Jump up and switch leg positions in air. Land in lunge with opposite leg forward. Repeat explosively.',
          mistakes: ['Not switching legs completely in air', 'Landing with straight legs', 'Losing balance during landing', 'Not jumping high enough'],
          tips: ['Exhale as you explode up from lunge', 'Quick inhale during flight phase', 'Controlled exhale as you land', 'Breathe rhythmically between jumps'] },
        { title:'Lunge', sets:3, reps:10, rest:45, muscles:'Quadriceps, Glutes', durationSeconds:35, animation:'Lunge.mp4', description:'Step forward into lunge position, lowering back knee toward floor. Push off front foot to return to standing. Alternate legs.',
          mistakes: ['Stepping too far or too short', 'Allowing front knee to go past toes', 'Not lowering back knee enough', 'Leaning forward excessively'],
          tips: ['Inhale as you step into lunge', 'Exhale as you push back to standing', 'Steady breathing helps with balance', 'Breathe through nose for better control'] },
        { title:'Bridge', sets:3, reps:8, rest:45, muscles:'Glutes', durationSeconds:35, animation:'Bridge.mp4', description:'Lie on back, one foot flat on floor, other leg extended. Lift hips up squeezing glutes. Lower slowly and repeat.',
          mistakes: ['Using back instead of glutes to lift', 'Not squeezing glutes at the top', 'Lifting too fast without control', 'Not keeping core engaged'],
          tips: ['Exhale as you lift hips up', 'Inhale as you lower down slowly', 'Hold breath briefly at the top', 'Focus on glute activation with each breath'] },
        { title:'Calf Raise', sets:2, reps:15, rest:30, muscles:'Calves', durationSeconds:25, animation:'calfraise.mp4', description:'Stand tall with feet hip-width apart. Rise up onto toes by lifting heels as high as possible. Hold briefly, then lower heels back down slowly.',
          mistakes: ['Not going up high enough on toes', 'Bouncing at the bottom', 'Using momentum instead of muscle', 'Not controlling the descent'],
          tips: ['Exhale as you rise up on toes', 'Inhale as you lower heels down', 'Pause and breathe at the top', 'Steady rhythm matches your breathing'] }
      ]
    },

    {
      title:'Full Body',
      desc:'High-intensity workout targeting all major muscle groups',
      duration:'32 min',
      difficulty:'intermediate',
      tag:'Full Body',
      exercises:[
        { title:'Burpees and Jump Exercise', sets:3, reps:8, rest:60, muscles:'Full Body, Chest, Legs, Core', durationSeconds:45, animation:'Burpee and Jump Exercise.mp4', description:'Squat down, place hands on floor, jump feet back to plank. Do push-up, jump feet forward, then jump up with arms overhead.',
          mistakes: ['Not doing full push-up in plank', 'Landing hard from jump', 'Not jumping feet close enough to hands', 'Rushing through without proper form'],
          tips: ['Exhale during push-up and jump phases', 'Inhale during transitions', 'Quick breaths between movements', 'Use breathing to pace the exercise'] },
        { title:'Inchworm', sets:3, reps:8, rest:60, muscles:'Full Body, Core, Shoulders, Hamstrings', durationSeconds:40, animation:'Inchworm.mp4', description:'Stand tall, bend forward and place hands on floor. Walk hands forward to plank position, then walk feet toward hands. Return to standing.',
          mistakes: ['Bending knees when walking hands out', 'Not reaching full plank position', 'Walking feet too close to hands', 'Moving too quickly without control'],
          tips: ['Exhale as you walk hands forward', 'Inhale as you walk feet toward hands', 'Breathe steadily during the movement', 'Control breathing helps maintain form'] },
        { title:'Jumping Jack', sets:3, reps:20, rest:45, muscles:'Full Body, Cardio, Legs, Shoulders', durationSeconds:35, animation:'Jumping Jack.mp4', description:'Start with feet together, arms at sides. Jump feet apart while raising arms overhead. Jump back to starting position. Maintain rhythm throughout.',
          mistakes: ['Not jumping feet wide enough', 'Arms not reaching overhead', 'Landing too heavily', 'Losing rhythm and coordination'],
          tips: ['Exhale as you jump feet apart', 'Inhale as you return to center', 'Maintain steady breathing rhythm', 'Breathe through nose for endurance'] },
        { title:'Reverse Crunches', sets:3, reps:15, rest:45, muscles:'Core', durationSeconds:35, animation:'Reverse Crunches.mp4', description:'Lie on back, knees bent at 90 degrees. Lift hips off floor by contracting abs, bringing knees toward chest. Lower slowly.',
          mistakes: ['Using momentum instead of abs', 'Not lifting hips off floor', 'Lowering legs too quickly', 'Pulling on neck or head'],
          tips: ['Exhale as you lift hips and knees up', 'Inhale as you lower with control', 'Steady breathing engages core better', 'Never hold breath during crunches'] },
        { title:'Plank', sets:3, reps:0, rest:45, muscles:'Core', durationSeconds:35, animation:'Plank.mp4', description:'Hold plank position with straight body from head to heels. Keep core engaged and maintain neutral spine. Focus on stability and endurance.',
          mistakes: ['Sagging hips or raising butt too high', 'Looking up and straining neck', 'Holding breath during the hold', 'Placing hands too far forward'],
          tips: ['Breathe normally and steadily throughout', 'Inhale and exhale at regular intervals', 'Use breathing to help engage your core', 'Never hold your breath during planks'] }
      ]
    },

    // ADVANCED WORKOUTS
    {
      title:'Upper Body',
      desc:'Intense upper body strength and endurance training',
      duration:'35 min',
      difficulty:'advanced',
      tag:'Upper Body',
      exercises:[
        { title:'Wide Arm Push Up', sets:4, reps:12, rest:60, muscles:'Chest, Arms', durationSeconds:50, animation:'Widearmpushup.mp4', description:'Place hands wider than shoulder-width apart. Perform push-up with wide hand position, targeting outer chest muscles. Keep body straight throughout.',
          mistakes: ['Placing hands too wide causing shoulder strain', 'Not maintaining straight body line', 'Partial range of motion', 'Rushing through the movement'],
          tips: ['Exhale as you press up from the bottom', 'Inhale deeply as you lower your chest', 'Use controlled breathing to maintain rhythm', 'Take a breath at the top if needed'] },
        { title:'Military Push Ups', sets:4, reps:15, rest:60, muscles:'Chest, Arms', durationSeconds:50, animation:'Military Push Ups.mp4', description:'Strict push-up with hands directly under shoulders. Keep body rigid like a plank throughout the movement. Focus on controlled motion.',
          mistakes: ['Sagging hips or arching back', 'Not going down far enough', 'Flaring elbows too wide', 'Holding breath during reps'],
          tips: ['Exhale forcefully as you push up', 'Inhale as you lower down', 'Maintain steady breathing rhythm', 'Breathe through your nose when possible'] },
        { title:'Staggered Push-ups', sets:4, reps:10, rest:75, muscles:'Chest, Core', durationSeconds:45, animation:'Staggeredpushups.mp4', description:'Place one hand forward and one back in staggered position. Perform push-up, then switch hand positions. Challenges stability and unilateral strength.',
          mistakes: ['Not switching hand positions between sets', 'Allowing body to twist or rotate', 'Uneven weight distribution', 'Moving too quickly without control'],
          tips: ['Exhale as you push up from staggered position', 'Inhale as you lower with control', 'Breathe steadily to maintain balance', 'Focus on core breathing for stability'] },
        { title:'Plank', sets:4, reps:10, rest:45, muscles:'Core, Arms', durationSeconds:40, animation:'Plank.mp4', description:'Start in plank. Lower to forearms one arm at a time, then push back up to full plank. Alternate leading arm.',
          mistakes: ['Sagging hips during transitions', 'Moving too quickly between positions', 'Not maintaining core engagement', 'Allowing body to rock side to side'],
          tips: ['Exhale during the challenging up phase', 'Inhale as you lower to forearms', 'Steady breathing maintains core stability', 'Control breath during transitions'] },
        { title:'Deadbug Fitness Exercise', sets:4, reps:12, rest:60, muscles:'Core, Stability', durationSeconds:45, animation:'Deadbug fitness exercise.mp4', description:'Lie on back, arms up, knees bent. Lower opposite arm and leg slowly, maintaining core stability. Return and alternate sides.',
          mistakes: ['Allowing lower back to arch', 'Moving arms and legs too quickly', 'Not maintaining opposite arm/leg pattern', 'Holding breath during movement'],
          tips: ['Exhale as you extend arm and leg', 'Inhale as you return to start', 'Breathe steadily to maintain core control', 'Use breath to stabilize your spine'] }
      ]
    },

    {
      title:'Lower Body',
      desc:'Elite lower body power and strength development',
      duration:'38 min',
      difficulty:'advanced',
      tag:'Lower Body',
      exercises:[
        { title:'Squats', sets:4, reps:15, rest:60, muscles:'Quadriceps, Glutes', durationSeconds:50, animation:'Squats.mp4', description:'Stand with feet shoulder-width apart. Lower hips back and down as if sitting in a chair. Keep chest up and knees behind toes. Return to standing.',
          mistakes: ['Knees caving inward', 'Not going deep enough', 'Leaning too far forward', 'Rising up on toes'],
          tips: ['Inhale as you lower down', 'Exhale as you stand up', 'Deep breath at the top', 'Controlled breathing maintains form'] },
        { title:'Jumping Lunges', sets:4, reps:12, rest:60, muscles:'Legs, Power', durationSeconds:50, animation:'Jumping Lunges.mp4', description:'Start in lunge position. Jump up and switch leg positions in air. Land in lunge with opposite leg forward. Repeat explosively.',
          mistakes: ['Landing too hard', 'Not switching legs completely', 'Poor landing position', 'Losing balance on landing'],
          tips: ['Exhale explosively on jump', 'Quick inhale between jumps', 'Controlled breathing on landing', 'Steady rhythm helps coordination'] },
        { title:'Squat Kicks', sets:4, reps:15, rest:45, muscles:'Quads, Glutes', durationSeconds:45, animation:'Squat kicks.mp4', description:'Squat down, then as you stand up, kick one leg forward. Alternate legs with each rep. Keep core engaged for balance.',
          mistakes: ['Not squatting deep enough before kick', 'Losing balance during kick', 'Kicking too high', 'Not engaging core'],
          tips: ['Exhale as you stand and kick', 'Inhale during squat phase', 'Quick breath during kick', 'Steady breathing for balance'] },
        { title:'Side Hip Abduction', sets:4, reps:12, rest:60, muscles:'Hip Abductors', durationSeconds:45, animation:'Side Hip Abduction.mp4', description:'Lie on side, lift top leg up and down in controlled motion. Targets hip abductors and glute medius for stability.',
          mistakes: ['Using momentum instead of muscle', 'Not lifting leg high enough', 'Rolling body instead of isolating leg', 'Moving too quickly'],
          tips: ['Exhale as you lift leg up', 'Inhale as you lower leg', 'Steady breathing rhythm', 'Control breath for better isolation'] },
        { title:'Lunge', sets:4, reps:8, rest:60, muscles:'Quadriceps, Glutes', durationSeconds:45, animation:'Lunge.mp4', description:'Step forward into lunge position, lowering back knee toward floor. Push off front foot to return to standing. Alternate legs.',
          mistakes: ['Knee extending past toes', 'Not lowering back knee enough', 'Leaning forward too much', 'Taking uneven steps'],
          tips: ['Inhale as you step into lunge', 'Exhale as you push back', 'Steady breathing for balance', 'Deep breath helps stability'] },
        { title:'Frog Press', sets:4, reps:16, rest:45, muscles:'Glutes, Legs', durationSeconds:40, animation:'Frog Press.mp4', description:'Lie on back with soles of feet together, knees out. Press through heels to lift hips up. Targets glutes in stretched position.',
          mistakes: ['Not pressing through heels', 'Using back instead of glutes', 'Not squeezing glutes at top', 'Rushing the movement'],
          tips: ['Exhale as you press hips up', 'Inhale as you lower down', 'Hold breath briefly at top', 'Controlled breathing enhances glute activation'] }
      ]
    },

    {
      title:'Full Body',
      desc:'Ultimate full body challenge for elite fitness',
      duration:'40 min',
      difficulty:'advanced',
      tag:'Full Body',
      exercises:[
        { title:'Burpee and Jump Exercise', sets:4, reps:12, rest:75, muscles:'Full Body, Chest, Legs, Core, Power', durationSeconds:60, animation:'Burpee and Jump Exercise.mp4', description:'Perform a burpee with an explosive jump at the end. Focus on maximum height and power in the jump phase.',
          mistakes: ['Not jumping high enough', 'Poor form during burpee portion', 'Landing too hard', 'Rushing through the movement'],
          tips: ['Exhale explosively during jump', 'Inhale as you drop down', 'Quick breathing during transitions', 'Deep breath before each rep'] },
        { title:'Spiderman Push-up', sets:4, reps:10, rest:60, muscles:'Full Body, Chest, Core, Triceps', durationSeconds:55, animation:'spiderman push-up.mp4', description:'Perform push-up while bringing knee to elbow. Alternate sides with each rep. Combines upper body strength with core stability.',
          mistakes: ['Not bringing knee close enough to elbow', 'Losing push-up form', 'Moving too quickly', 'Not alternating sides properly'],
          tips: ['Exhale as you push up and bring knee', 'Inhale as you lower down', 'Controlled breathing for coordination', 'Steady rhythm helps balance'] },
        { title:'Seated Abs Circles', sets:4, reps:20, rest:45, muscles:'Core', durationSeconds:40, animation:'Seated abs circles.mp4', description:'Sit with legs extended, lean back slightly. Make circular motions with torso, engaging core throughout the movement.',
          mistakes: ['Using arms instead of core', 'Making circles too small', 'Leaning back too far', 'Not maintaining leg position'],
          tips: ['Exhale as you circle away from center', 'Inhale as you return to center', 'Steady breathing maintains core engagement', 'Control breath for smooth circles'] },
        { title:'Reverse Crunches', sets:4, reps:20, rest:45, muscles:'Core', durationSeconds:40, animation:'Reverse Crunches.mp4', description:'Lie on back, knees bent at 90 degrees. Lift hips off floor by contracting abs, bringing knees toward chest. Lower slowly.',
          mistakes: ['Using momentum to lift hips', 'Not lifting hips high enough', 'Lowering too quickly', 'Not keeping knees at 90 degrees'],
          tips: ['Exhale as you lift hips up', 'Inhale as you lower down', 'Hold breath briefly at the top', 'Controlled breathing enhances core activation'] },
        { title:'Flutter Kicks', sets:4, reps:30, rest:45, muscles:'Core', durationSeconds:45, animation:'Flutter Kicks.mp4', description:'Lie on back, legs extended. Alternate small kicks up and down rapidly. Keep lower back pressed to floor throughout.',
          mistakes: ['Lifting lower back off floor', 'Making kicks too large', 'Moving legs too slowly', 'Not keeping legs straight'],
          tips: ['Steady, rhythmic breathing', 'Exhale in short bursts', 'Don\'t hold your breath', 'Quick breathing matches leg tempo'] }
      ]
    }
  ];

  // --- Customise Workout (aggregates all unique exercises) ---
  const CUSTOM_SELECT_KEY = 'customWorkoutSelection';
  function loadCustomSelection(){ try { const m = JSON.parse(localStorage.getItem(CUSTOM_SELECT_KEY)||'{}'); return (m && typeof m === 'object') ? m : {}; } catch(_) { return {}; } }
  function saveCustomSelection(k,v){ try { const m = loadCustomSelection(); m[k] = !!v; localStorage.setItem(CUSTOM_SELECT_KEY, JSON.stringify(m)); } catch(_) {} }
  function collectAllExercises() {
    const seen = new Set();
    const all = [];
    const map = loadCustomSelection();
    WORKOUTS.forEach(w => {
      (w.exercises || []).forEach(ex => {
        const key = `${ex.title||''}|${ex.animation||''}`;
        if (!seen.has(key)) { seen.add(key); all.push({ ...ex, __selected: !!map[key] }); }
      });
    });
    return all;
  }

  WORKOUTS.push({
    title: 'Customise',
    desc: 'Create your own workout by selecting exercises',
    duration: 'Varies',
    difficulty: 'custom',
    tag: 'Your Plan',
    exercises: collectAllExercises()
  });

  // DOM references
  const viewList = document.getElementById('view-list');
  const viewDetail = document.getElementById('view-detail');
  const viewPlayer = document.getElementById('view-player');
  const workoutsContainer = document.getElementById('workouts');
  const detailTitle = document.getElementById('detail-title');
  const detailDesc = document.getElementById('detail-desc');
  const detailDuration = document.getElementById('detail-duration');
  const detailCount = document.getElementById('detail-count');
  const detailBadge = document.getElementById('detail-badge');
  const detailExList = document.getElementById('detail-exList');
  const detailBack = document.getElementById('detail-back');
  const detailStart = document.getElementById('detail-start');
  const playerTitle = document.getElementById('player-title');
  const playerSetInfo = document.getElementById('player-set-info');
  const playerTimer = document.getElementById('player-timer');
  const playerReps = document.getElementById('player-reps');
  const playerProgressLabel = document.getElementById('player-progress-label');
  const playerProgressFill = document.getElementById('player-progress-fill');
  const playerSkip = document.getElementById('player-skip');
  const playerPause = document.getElementById('player-pause');
  const playerClose = document.getElementById('player-close');
  const playerVoice = document.getElementById('player-voice');
  const playerVoiceIcon = document.getElementById('player-voice-icon');
  const playerVoiceGender = document.getElementById('player-voice-gender');
  const voiceGenderText = document.getElementById('voice-gender-text');

  // Supabase Configuration
  const getSupabaseConfig = () => {
    // Replace these with your actual Supabase project URL and anon key
    return {
      url: 'https://bhtabgrcxaahkuwrdwec.supabase.co',
      anonKey: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJodGFiZ3JjeGFhaGt1d3Jkd2VjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgzNzc1MjMsImV4cCI6MjA3Mzk1MzUyM30._Cydy4B6QMF353OG8jnhK7juWgz2j4RirATIfCgAflQ'
    };
  };

  const supabaseConfig = getSupabaseConfig();

  // Initialize Supabase
  let supabase, auth, currentUser = null;
  try {
    const { createClient } = window.supabase;
    supabase = createClient(supabaseConfig.url, supabaseConfig.anonKey);
    auth = supabase.auth;
    
    // Listen for auth state changes
    auth.onAuthStateChange((event, session) => {
      currentUser = session?.user || null;
    });
  } catch (error) {
    console.log('Supabase not configured yet:', error.message);
  }

  // App state
  let currentWorkoutIndex = 0;
  let currentExerciseIndex = 0;
  let currentSet = 1;
  let remainingSeconds = 0;
  let timerInterval = null;
  let isPaused = false;
  let voiceEnabled = true;
  let voiceGender = 'female'; // 'male' or 'female'
  let isResting = false;

  // Workout session tracking variables
  let workoutStartTime = null;
  let workoutTotalTime = 0;
  let workoutTimer = null;
  let completedExercises = [];
  let sessionExercises = [];

  // ---- MP4 Prefetch & In-Memory Cache (speeds up animation loads)
  const videoCache = new Map(); // fileName -> objectURL
  const videoCacheURLs = new Map(); // track to revoke
  const prefetchPromises = new Map(); // dedupe concurrent fetches
  const MAX_CACHE_ITEMS = 6;

  async function prefetchVideo(fileName){
    try {
      if (!fileName) return null;
      if (videoCache.has(fileName)) return videoCache.get(fileName);
      if (prefetchPromises.has(fileName)) return await prefetchPromises.get(fileName);

      const url = `./animations/${encodeURI(fileName)}`;
      const promise = fetch(url, { cache: 'default' })
        .then(r => { if (!r.ok) throw new Error(`Video fetch failed: ${r.status}`); return r.blob(); })
        .then(blob => {
          const objURL = URL.createObjectURL(blob);
          videoCache.set(fileName, objURL);
          videoCacheURLs.set(fileName, objURL);
          // LRU-ish eviction to cap memory usage
          if (videoCache.size > MAX_CACHE_ITEMS) {
            const firstKey = videoCache.keys().next().value;
            const oldURL = videoCacheURLs.get(firstKey);
            if (oldURL) URL.revokeObjectURL(oldURL);
            videoCache.delete(firstKey);
            videoCacheURLs.delete(firstKey);
          }
          return objURL;
        })
        .catch(err => { console.log('Prefetch video error:', err); return null; })
        .finally(() => { prefetchPromises.delete(fileName); });

      prefetchPromises.set(fileName, promise);
      return await promise;
    } catch (e) {
      console.log('prefetchVideo unexpected error:', e);
      return null;
    }
  }

  async function loadVideoInto(el, fileName){
    if (!el || !fileName) return null;
    let srcURL = videoCache.get(fileName) || await prefetchVideo(fileName);
    if (!srcURL) srcURL = `./animations/${encodeURI(fileName)}`;
    return new Promise(resolve => {
      const onCanPlay = () => { el.removeEventListener('canplay', onCanPlay); resolve(srcURL); };
      el.addEventListener('canplay', onCanPlay, { once: true });
      el.src = srcURL; el.load();
    });
  }

  async function setAnimationVideoSrcIfChanged(fileName){
    const current = document.getElementById('player-animation');
    const next = document.getElementById('player-animation-next');
    if (!current || !next || !fileName) return;

    const cachedURL = videoCache.get(fileName) || null;
    const targetPath = `./animations/${encodeURI(fileName)}`;
    const currentSrc = current.src || '';
    const alreadyLoaded = (cachedURL && currentSrc === cachedURL) || (!cachedURL && currentSrc.endsWith(encodeURI(fileName)));
    if (alreadyLoaded) {
      current.style.display = 'block';
      current.style.opacity = '1';
      current.play().catch(()=>{});
      return;
    }

    // Preload into the secondary video and crossfade when ready
    next.pause();
    next.style.display = 'block';
    next.style.opacity = '0';
    const url = await loadVideoInto(next, fileName);
    // Once ready, start playing and crossfade
    next.play().catch(()=>{});
    next.style.transition = 'opacity 250ms ease-in-out';
    current.style.transition = 'opacity 250ms ease-in-out';
    next.style.opacity = '1';
    current.style.opacity = '0';
    // After fade, swap IDs so future operations target the visible video
    setTimeout(() => {
      current.style.display = 'none';
      // Swap element IDs
      current.id = 'player-animation-next';
      next.id = 'player-animation';
    }, 260);
  }

  // Workout state persistence functions
  function saveWorkoutState() {
    const workoutState = {
      currentWorkoutIndex,
      currentExerciseIndex,
      currentSet,
      remainingSeconds,
      isPaused,
      isResting,
      workoutStartTime: workoutStartTime ? workoutStartTime.toISOString() : null,
      workoutTotalTime,
      completedExercises,
      sessionExercises,
      currentView: getCurrentView(),
      timestamp: new Date().toISOString()
    };
    localStorage.setItem('fitmate-workout-state', JSON.stringify(workoutState));
  }

  function restoreWorkoutState() {
    const savedState = localStorage.getItem('fitmate-workout-state');
    if (savedState) {
      try {
        const state = JSON.parse(savedState);
        // Only restore if the state is recent (within last 24 hours)
        const stateAge = new Date() - new Date(state.timestamp);
        if (stateAge < 24 * 60 * 60 * 1000) {
          currentWorkoutIndex = state.currentWorkoutIndex || 0;
          currentExerciseIndex = state.currentExerciseIndex || 0;
          currentSet = state.currentSet || 1;
          remainingSeconds = state.remainingSeconds || 0;
          isPaused = state.isPaused || false;
          isResting = state.isResting || false;
          workoutStartTime = state.workoutStartTime ? new Date(state.workoutStartTime) : null;
          workoutTotalTime = state.workoutTotalTime || 0;
          completedExercises = state.completedExercises || [];
          sessionExercises = state.sessionExercises || [];
          
          // Only restore view if not called from openPlayer
          if (arguments.length === 0) {
            // Called from page load, restore the appropriate view
            if (state.currentView === 'player' && workoutStartTime) {
              showView('view-player');
              updatePlayerForExercise(currentExerciseIndex);
              if (workoutStartTime) {
                // Start workout timer
                clearInterval(workoutTimer);
                workoutTimer = setInterval(() => {
                  workoutTotalTime++;
                }, 1000);
              }
              
              // Start player timer for time-based exercises if not paused and not resting
              const workout = WORKOUTS[currentWorkoutIndex];
              const currentEx = workout.exercises[currentExerciseIndex];
              const isRepBased = currentEx.reps && currentEx.reps > 0;
              if (!isRepBased && !isPaused && !isResting && remainingSeconds > 0) {
                startPlayerTimer();
              }
            } else if (state.currentView === 'detail') {
              openDetail(currentWorkoutIndex);
            }
          }
          return true;
        }
      } catch (error) {
        console.error('Error restoring workout state:', error);
      }
    }
    return false;
  }

  function clearWorkoutState() {
    localStorage.removeItem('fitmate-workout-state');
  }

  function getCurrentView() {
    if (document.getElementById('view-player').classList.contains('active-view')) return 'player';
    if (document.getElementById('view-detail').classList.contains('active-view')) return 'detail';
    return 'list';
  }

  // Background music initialization
  function initializeBackgroundMusic() {
    const backgroundMusicEnabled = localStorage.getItem('backgroundMusicEnabled');
    const audio = document.getElementById('background-music');
    
    if (audio && backgroundMusicEnabled === 'true') {
      audio.volume = 0.3;
      audio.play().catch(e => {
        console.log('Audio autoplay prevented:', e);
        // For mobile browsers, add user interaction listeners
        if (/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)) {
          const startMusicOnInteraction = () => {
            audio.play().catch(e => console.log('Audio play still failed:', e));
            document.removeEventListener('click', startMusicOnInteraction);
            document.removeEventListener('touchstart', startMusicOnInteraction);
            document.removeEventListener('keydown', startMusicOnInteraction);
          };
          document.addEventListener('click', startMusicOnInteraction, { once: true });
          document.addEventListener('touchstart', startMusicOnInteraction, { once: true });
          document.addEventListener('keydown', startMusicOnInteraction, { once: true });
        }
      });
    }
  }

  // Initialize background music when page loads
  setTimeout(initializeBackgroundMusic, 500);

  // Render workouts list
  function renderWorkouts(){
    workoutsContainer.innerHTML = '';
    WORKOUTS.forEach((w, idx) => {
      const art = document.createElement('article');
      art.className = 'rounded-2xl overflow-hidden shadow-lg cursor-pointer';
      art.innerHTML = `
        <div class="hero-pattern h-44 md:h-52 rounded-2xl relative">
          <div class="absolute inset-0 flex items-start px-5 pt-5 z-10">
            <span class="text-2xl md:text-3xl font-extrabold text-gray-900 dark:text-white">${w.title}</span>
            <div class="ml-auto">
              <span class="inline-block text-xs font-semibold uppercase px-3 py-1 rounded-full ${w.difficulty==='beginner' ? 'bg-green-500 text-black' : w.difficulty==='intermediate' ? 'bg-pink-500 text-white' : w.difficulty==='custom' ? 'bg-blue-500 text-white' : 'bg-red-500 text-white'}">${w.difficulty.charAt(0).toUpperCase() + w.difficulty.slice(1)}</span>
            </div>
          </div>
          <div class="absolute left-0 right-0 bottom-0 p-4 card-stats">
            <p class="text-sm text-gray-700 dark:text-gray-200">${w.desc}</p>
            <div class="mt-3 flex items-center gap-6">
              <div class="flex items-center gap-2 text-sm">
                <svg class="w-5 h-5 text-pink-500" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6"><circle cx="12" cy="12" r="9"/><path d="M12 7v5l3 2"/></svg>
                <span class="text-gray-800 dark:text-gray-200 font-medium">~${w.duration}</span>
              </div>
              <div class="flex items-center gap-2 text-sm">
                <svg class="w-5 h-5 text-pink-500" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6"><circle cx="12" cy="12" r="3"/><circle cx="12" cy="12" r="7" opacity="0.3"/></svg>
                <span class="text-gray-800 dark:text-gray-200 font-medium">${w.exercises.length} exercises</span>
              </div>
              <div class="flex items-center gap-2 text-sm ml-auto">
                <svg class="w-5 h-5 text-pink-500" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6"><path d="M6 12h12"/></svg>
                <span class="text-gray-800 dark:text-gray-200 font-medium">${w.tag}</span>
              </div>
            </div>
          </div>
        </div>
      `;
      art.addEventListener('click', () => openDetail(idx));
      workoutsContainer.appendChild(art);
    });
  }

  // Navigation helpers
  function showView(viewId){
    viewList.classList.add('hidden-view'); viewList.classList.remove('active-view');
    viewDetail.classList.add('hidden-view'); viewDetail.classList.remove('active-view');
    viewPlayer.classList.add('hidden-view'); viewPlayer.classList.remove('active-view');
    const target = document.getElementById(viewId);
    target.classList.remove('hidden-view');
    target.classList.add('active-view');
    // Apply player-active layout adjustments to remove scrolling when player is visible
    const appEl = document.getElementById('app');
    const isPlayer = viewId === 'view-player';
    document.body.classList.toggle('player-active', isPlayer);
    appEl.classList.toggle('player-active', isPlayer);
    // scroll top for better UX
    window.scrollTo({ top: 0, behavior: 'instant' });
  }

  // Open detail screen
  function openDetail(idx){
    currentWorkoutIndex = idx;
    const wx = WORKOUTS[idx];
    if (wx && wx.difficulty === 'custom') {
      // Reset to full catalog each time detail opens
      wx.exercises = collectAllExercises();
      detailStart.innerHTML = `
        <svg class="w-6 h-6" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 5v14M5 12h14" stroke-linecap="round" stroke-linejoin="round"/></svg>
        Start Workout`;
    }
    else {
      detailStart.innerHTML = `
        <svg class="w-6 h-6" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M8 5v14l11-7z" stroke-linecap="round" stroke-linejoin="round"/></svg>
        Start Workout`;
    }
    detailTitle.textContent = wx.title;
    detailDesc.textContent = wx.desc;
    detailDuration.textContent = '~' + wx.duration;
    detailCount.textContent = wx.exercises.length + ' exercises';
    detailBadge.textContent = wx.difficulty.charAt(0).toUpperCase() + wx.difficulty.slice(1);
    // Set badge color based on difficulty
    detailBadge.className = `ml-auto text-xs font-bold px-3 py-1 rounded-full ${
      wx.difficulty === 'beginner' ? 'bg-green-500 text-black' : 
      wx.difficulty === 'intermediate' ? 'bg-pink-500 text-white' : 
      wx.difficulty === 'custom' ? 'bg-blue-500 text-white' :
      'bg-red-500 text-white'
    }`;

    // render exercises list
    detailExList.innerHTML = '';
    wx.exercises.forEach((ex, i) => {
      const el = document.createElement('div');
      el.className = 'p-4 bg-white dark:bg-gray-800 rounded-xl shadow-md border border-blue-200 dark:border-blue-700';
      const controls = (wx.difficulty === 'custom')
        ? `<div class="flex items-center gap-2">
             <button class="text-xs px-2 py-1 rounded-md bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 text-gray-900 dark:text-white flex-shrink-0" data-info="${i}">‚ÑπÔ∏è</button>
             <label class="inline-flex items-center">
               <input type="checkbox" data-select="${i}" ${ex.__selected===true ? 'checked' : ''} class="w-4 h-4 rounded border-gray-300 dark:border-gray-600">
             </label>
           </div>`
        : `<button class="text-xs px-2 py-1 rounded-md bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 text-gray-900 dark:text-white flex-shrink-0" data-info="${i}">‚ÑπÔ∏è</button>`;
      el.innerHTML = `
        <div class="flex items-start gap-3">
          <div class="w-12 h-12 flex items-center justify-center rounded-lg bg-gray-100 dark:bg-gray-700 overflow-hidden flex-shrink-0 cursor-pointer" ${ex.animation ? `data-video="${ex.animation}" data-title="${ex.title}"` : ''}>
            ${ex.animation ? 
              `<video class="w-full h-full object-cover" autoplay loop muted>
                 <source src="./animations/${ex.animation}" type="video/mp4">
               </video>` : 
              `<div class="w-8 h-8 flex items-center justify-center rounded-full bg-blue-500 font-bold text-white text-xs">${i+1}</div>`
            }
          </div>
          <div class="flex-1 min-w-0">
             <div class="flex items-start justify-between gap-2 mb-2">
               <div class="flex-1 min-w-0">
                 <h3 class="font-semibold text-gray-900 dark:text-white truncate">${ex.title}</h3>
                 <p class="text-pink-500 text-sm">${ex.muscles}</p>
               </div>
               ${controls}
             </div>
             <div class="grid grid-cols-2 sm:grid-cols-4 gap-2 text-xs">
               <div class="flex items-center gap-1">
                 <span class="text-gray-600 dark:text-gray-400">Sets:</span>
                 <input type="number" min="1" max="10" value="${ex.sets}" class="w-10 px-1 py-0.5 text-xs border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-700 text-gray-900 dark:text-white" onchange="updateExercise(${i}, 'sets', this.value)">
               </div>
               ${ex.reps > 0 ? 
                 `<div class="flex items-center gap-1">
                   <span class="text-gray-600 dark:text-gray-400">Reps:</span>
                   <input type="number" min="1" max="100" value="${ex.reps}" class="w-10 px-1 py-0.5 text-xs border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-700 text-gray-900 dark:text-white" onchange="updateExercise(${i}, 'reps', this.value)">
                 </div>` :
                 `<div class="flex items-center gap-1">
                   <span class="text-gray-600 dark:text-gray-400">Time:</span>
                   <input type="number" min="5" max="300" step="5" value="${ex.durationSeconds}" class="w-12 px-1 py-0.5 text-xs border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-700 text-gray-900 dark:text-white" onchange="updateExercise(${i}, 'durationSeconds', this.value)">s
                 </div>`
               }
               <div class="flex items-center gap-1">
                 <span class="text-gray-600 dark:text-gray-400">Rest:</span>
                 <input type="number" min="0" max="180" step="5" value="${ex.rest}" class="w-12 px-1 py-0.5 text-xs border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-700 text-gray-900 dark:text-white" onchange="updateExercise(${i}, 'rest', this.value)">s
               </div>
             </div>
           </div>
        </div>
      `;
      detailExList.appendChild(el);
    });

    showView('view-detail');

    // Opportunistic prefetch: first two exercise videos
    const firstEx = wx.exercises[0];
    const secondEx = wx.exercises[1];
    [firstEx, secondEx].forEach(e => {
      if (e && e.animation && !/\.json$/i.test(e.animation)) {
        prefetchVideo(e.animation);
      }
    });
  }

  detailBack.addEventListener('click', ()=> { showView('view-list'); });

  // Start workout from detail -> go to player
  detailStart.addEventListener('click', ()=> {
    const w = WORKOUTS[currentWorkoutIndex];
    if (w && w.difficulty === 'custom') {
      const selected = (w.exercises || []).filter(e => e.__selected === true);
      if (selected.length > 0) {
        w.exercises = selected.map(e => ({ ...e }));
        w.title = 'Custom Workout';
        detailCount.textContent = w.exercises.length + ' exercises';
      } else {
        showAppToast('Select at least 1 exercise', 'warning');
        return;
      }
    }
    openPlayer(currentWorkoutIndex);
  });

  // Handle Info and animation preview
  detailExList.addEventListener('click', (e) => {
    const preview = e.target.closest('[data-video]');
    if (preview) {
      const file = preview.getAttribute('data-video');
      const title = preview.getAttribute('data-title') || 'Exercise';
      showExerciseAnimation(title, file);
      return;
    }
    if (e.target.hasAttribute('data-info')) {
      const exerciseIndex = parseInt(e.target.getAttribute('data-info'));
      const workout = WORKOUTS[currentWorkoutIndex];
      const exercise = workout.exercises[exerciseIndex];
      
      if (exercise.description) {
        // Create and show modal with exercise description
        showExerciseInfo(exercise.title, exercise.description);
      }
    }
  });

  // Handle selection toggles (Customise)
  detailExList.addEventListener('change', (e) => {
    if (e.target && e.target.hasAttribute('data-select')) {
      const idx = parseInt(e.target.getAttribute('data-select'));
      const workout = WORKOUTS[currentWorkoutIndex];
      if (workout && workout.difficulty === 'custom' && workout.exercises[idx]) {
        workout.exercises[idx].__selected = !!e.target.checked;
        const ex = workout.exercises[idx];
        const k = `${ex.title||''}|${ex.animation||''}`;
        saveCustomSelection(k, !!e.target.checked);
      }
    }
  });

  // Function to show exercise info modal
  function showExerciseInfo(title, description) {
    // Create modal overlay
    const modal = document.createElement('div');
    modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
    modal.innerHTML = `
      <div class="bg-white dark:bg-gray-800 rounded-xl p-6 max-w-md w-full shadow-xl">
        <div class="flex justify-between items-center mb-4">
          <h3 class="text-lg font-semibold text-gray-900 dark:text-white">${title}</h3>
          <button class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200 text-xl" onclick="this.closest('.fixed').remove()">&times;</button>
        </div>
        <p class="text-gray-700 dark:text-gray-300 leading-relaxed">${description}</p>
        <div class="mt-6 flex justify-end">
          <button class="px-4 py-2 bg-pink-500 text-white rounded-lg hover:bg-pink-600" onclick="this.closest('.fixed').remove()">Got it!</button>
        </div>
      </div>
    `;
    
    // Add click outside to close
    modal.addEventListener('click', (e) => {
      if (e.target === modal) {
        modal.remove();
      }
    });
    
    document.body.appendChild(modal);
  }

  // --- Inline Exercise Editing
  function updateExercise(exerciseIndex, property, value) {
    const workout = WORKOUTS[currentWorkoutIndex];
    const exercise = workout.exercises[exerciseIndex];
    
    // Parse and validate the value
    const numValue = parseInt(value) || (property === 'rest' ? 0 : 1);
    
    // Update the exercise property
    exercise[property] = numValue;
    
    // Ensure minimum values
    if (property === 'sets' && numValue < 1) exercise.sets = 1;
    if (property === 'reps' && numValue < 1) exercise.reps = 1;
    if (property === 'durationSeconds' && numValue < 5) exercise.durationSeconds = 5;
    if (property === 'rest' && numValue < 0) exercise.rest = 0;
  }

  // --- Player logic
  function openPlayer(workoutIndex){
    const workout = WORKOUTS[workoutIndex];
    
    // Check if there's an existing workout state to resume
    const hasExistingState = restoreWorkoutState();
    
    // CRITICAL FIX: Always initialize new workout session for different workouts
    // This prevents completedExercises from carrying over between different workouts
    if (!hasExistingState || currentWorkoutIndex !== workoutIndex) {
      // Initialize new workout session
      currentWorkoutIndex = workoutIndex;
      currentExerciseIndex = 0;
      currentSet = 1;
      voiceEnabled = true;
      
      // Initialize workout session tracking
      workoutStartTime = new Date();
      workoutTotalTime = 0;
      completedExercises = []; // CRITICAL: Reset for new workout
      window.lastPlayerNextState = null; // Reset duplicate call prevention
      sessionExercises = workout.exercises.map(ex => ({
        title: ex.title,
        sets: ex.sets || 1,
        reps: ex.reps || 0,
        durationSeconds: ex.durationSeconds || 0,
        muscles: ex.muscles || 'Unknown'
      }));
      
      console.log(`Starting new workout: ${workout.title}, completedExercises reset to empty array`);
    } else {
      console.log(`Resuming existing workout: ${workout.title}, completedExercises has ${completedExercises.length} items`);
    }
    
    voiceEnabled = true; // Always ensure voice is enabled when opening player
    
    // Start workout timer if not already running
    if (!workoutTimer && workoutStartTime) {
      clearInterval(workoutTimer);
      workoutTimer = setInterval(() => {
        workoutTotalTime++;
      }, 1000);
    }
    
    updatePlayerForExercise(currentExerciseIndex);
    showView('view-player');
    
    // Only start timer for time-based exercises if not already running
    const ex = workout.exercises[currentExerciseIndex];
    const isRepBased = ex.reps && ex.reps > 0;
    if (!isRepBased && !timerInterval) {
      setTimeout(()=> startPlayerTimer(), 200);
    }

    // Prefetch next exercise animation to eliminate wait time
    const nextEx = workout.exercises[currentExerciseIndex + 1];
    if (nextEx && nextEx.animation && !/\.json$/i.test(nextEx.animation)) {
      prefetchVideo(nextEx.animation);
    }
    
    // Save workout state
    saveWorkoutState();
  }

  function updatePlayerForExercise(i){
    const workout = WORKOUTS[currentWorkoutIndex];
    const ex = workout.exercises[i];
    playerTitle.textContent = ex.title;
    playerSetInfo.textContent = `Set ${currentSet} of ${ex.sets || 1}`;
    
    // Determine if this is a rep-based or time-based exercise
    const isRepBased = ex.reps && ex.reps > 0;
    
    if (isRepBased) {
      // Rep-based exercise - show reps, no timer
      playerTimer.textContent = `${ex.reps}`;
      playerReps.textContent = `repetitions`;
      playerPause.innerHTML = '‚úì';
      playerPause.title = 'Complete Set';
      // Clear any existing timer for rep-based exercises
      clearInterval(timerInterval);
      timerInterval = null;
      remainingSeconds = 0; // Reset remaining seconds to prevent timer display
    } else {
      // Time-based exercise - show timer
      playerTimer.textContent = formatTime(ex.durationSeconds);
      playerReps.textContent = `${ex.durationSeconds} seconds`;
      playerPause.innerHTML = '||';
      playerPause.title = 'Pause/Resume';
      remainingSeconds = ex.durationSeconds;
    }
    
    // Show completed exercises out of total to avoid off-by-one when starting next exercise
  playerProgressLabel.textContent = `${completedExercises.length} of ${workout.exercises.length}`;
    const pct = Math.round((i / workout.exercises.length) * 100);
    playerProgressFill.style.width = pct + '%';
    
    // Handle exercise animation (prefer Lottie with transparent background, fallback to MP4)
    const animationVideo = document.getElementById('player-animation');
    const animationLottie = document.getElementById('player-lottie');
    const animationFallback = document.getElementById('player-animation-fallback');

    if (ex.animation) {
      const isLottie = /\.json$/i.test(ex.animation);

      if (isLottie) {
        // Hide and reset video
        animationVideo.pause();
        animationVideo.removeAttribute('src');
        animationVideo.style.display = 'none';

        // Prepare lottie element for smooth fade-in
        animationLottie.style.opacity = '0';
        animationLottie.style.display = 'block';
        animationFallback.style.display = 'none';
        animationLottie.setAttribute('src', `./animations/${ex.animation}`);

        const onLottieLoad = () => {
          animationLottie.removeEventListener('load', onLottieLoad);
          animationLottie.style.transition = 'opacity 250ms ease-in-out';
          animationLottie.style.opacity = '1';
        };
        animationLottie.addEventListener('load', onLottieLoad);
      } else {
        // Use MP4 video with prefetch + fade-in when ready
        animationLottie.removeAttribute('src');
        animationLottie.style.display = 'none';
        animationFallback.style.display = 'none';
        setAnimationVideoSrcIfChanged(ex.animation);
      }
    } else {
      // No animation available: hide both players and show fallback
      animationVideo.pause();
      animationVideo.removeAttribute('src');
      animationVideo.style.display = 'none';
      animationLottie.removeAttribute('src');
      animationLottie.style.display = 'none';
      animationFallback.style.display = 'block';
    }
    
    // Populate info panel
    updateInfoPanel(ex);
    speak(`${ex.title}. ${isRepBased ? ex.reps + ' repetitions.' : ex.durationSeconds + ' seconds.'}`);
  }

  function formatTime(s){
    const mm = Math.floor(s/60).toString().padStart(2,'0');
    const ss = (s%60).toString().padStart(2,'0');
    return mm + ':' + ss;
  }

  // Populate info panel (duration, focus chips, instructions, muscle highlights, mistakes/tips)
  function updateInfoPanel(ex){
    const infoDuration = document.getElementById('info-duration');
    const infoInstructions = document.getElementById('info-instructions');
    const focusContainer = document.getElementById('info-focus');
    if (!infoDuration || !infoInstructions || !focusContainer) return;
    const isRepBased = ex.reps && ex.reps > 0;
    infoDuration.textContent = isRepBased ? `${ex.reps} reps` : formatTime(ex.durationSeconds || 0);
    infoInstructions.textContent = ex.description || 'Perform the exercise with controlled movement and proper form.';
    focusContainer.innerHTML = '';
    const musclesList = (ex.muscles || '').split(',').map(s => s.trim()).filter(Boolean);
    musclesList.forEach(m => {
      const span = document.createElement('span');
      span.className = 'info-chip';
      span.textContent = m;
      focusContainer.appendChild(span);
    });
    const musclesLower = musclesList.map(m => m.toLowerCase());
    const map = {
      'muscle-abs': ['core','abs','abdominals'],
      'muscle-obliques': ['obliques'],
      'muscle-glutes': ['glutes','gluteus','butt'],
      'muscle-quadriceps': ['quadriceps','quads'],
      'muscle-hamstrings': ['hamstrings'],
      'muscle-calves': ['calves','calf'],
      'muscle-adductors': ['adductors','inner thigh','groin'],
      'muscle-hip-flexors': ['hip flexors','hip'],
      'muscle-lower-back': ['lower back','erector'],
      'muscle-lats': ['lats','latissimus'],
      'muscle-traps': ['traps','trapezius'],
      'muscle-shoulders': ['shoulders','deltoids','delts'],
      'muscle-biceps': ['biceps'],
      'muscle-triceps': ['triceps'],
      'muscle-forearms': ['forearms'],
      'muscle-chest': ['chest','pectorals','pecs']
    };
    
    // Clear all highlights first
    Object.keys(map).forEach(cls => {
      document.querySelectorAll(`.${cls}`).forEach(el => el.classList.remove('highlight'));
    });
    
    // Check for "Full Body" exercises and highlight multiple muscle groups
    const isFullBody = musclesLower.some(m => m.includes('full body') || m.includes('fullbody'));
    if (isFullBody) {
      // Highlight primary muscle groups for full body workouts
      const fullBodyMuscles = ['muscle-chest', 'muscle-abs', 'muscle-quadriceps', 'muscle-shoulders', 
                               'muscle-glutes', 'muscle-calves', 'muscle-hamstrings', 'muscle-triceps'];
      fullBodyMuscles.forEach(cls => {
        document.querySelectorAll(`.${cls}`).forEach(el => el.classList.add('highlight'));
      });
    } else {
      // Apply specific muscle highlights based on exercise muscles
      Object.entries(map).forEach(([cls, keys]) => {
        const match = musclesLower.some(val => keys.some(k => val.includes(k)));
        if (match) {
          document.querySelectorAll(`.${cls}`).forEach(el => el.classList.add('highlight'));
        }
      });
      
      // Handle "Legs" keyword to highlight both quads and hamstrings
      if (musclesLower.some(m => m.includes('legs') || m.includes('leg'))) {
        document.querySelectorAll('.muscle-quadriceps, .muscle-hamstrings, .muscle-calves').forEach(el => {
          el.classList.add('highlight');
        });
      }
      
      // Handle "Arms" keyword to highlight biceps, triceps, and forearms
      if (musclesLower.some(m => m.includes('arms') || m.includes('arm'))) {
        document.querySelectorAll('.muscle-biceps, .muscle-triceps, .muscle-forearms').forEach(el => {
          el.classList.add('highlight');
        });
      }
      
      // Handle "Back" keyword to highlight all back muscles
      if (musclesLower.some(m => m === 'back' || m.includes('back'))) {
        document.querySelectorAll('.muscle-lats, .muscle-traps, .muscle-lower-back').forEach(el => {
          el.classList.add('highlight');
        });
      }
    }

    // Populate common mistakes and breathing tips (if provided on exercise)
    const mistakesEl = document.getElementById('info-mistakes');
    const tipsEl = document.getElementById('info-tips');
    if (mistakesEl) {
      const defaultMistakes = [
        'Poor posture (rounded back or collapsed shoulders)',
        'Not engaging the core throughout the movement',
        'Rushing reps and sacrificing form',
        'Inadequate range of motion or locking joints',
        'Holding your breath'
      ];
      const mistakes = (Array.isArray(ex.mistakes) && ex.mistakes.length > 0) ? ex.mistakes : defaultMistakes;
      mistakesEl.innerHTML = mistakes.map(m => `<li>${m}</li>`).join('');
    }
    if (tipsEl) {
      const defaultTips = [
        'Exhale on effort; inhale on the easier phase',
        'Maintain steady rhythm (inhale through nose, exhale through mouth)',
        'Keep core engaged to stabilize your spine',
        'Use slow, controlled reps; prioritize form over speed'
      ];
      const tips = (Array.isArray(ex.tips) && ex.tips.length > 0) ? ex.tips : defaultTips;
      tipsEl.innerHTML = tips.map(t => `<li>${t}</li>`).join('');
    }
  }

  function showExerciseAnimation(title, animationFile) {
    const modal = document.createElement('div');
    modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
    modal.innerHTML = `
      <div class="bg-white dark:bg-gray-800 rounded-xl p-4 max-w-lg w-full shadow-xl">
        <div class="flex justify-between items-center mb-3">
          <h3 class="text-lg font-semibold text-gray-900 dark:text-white">${title}</h3>
          <button class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200 text-xl" onclick="this.closest('.fixed').remove()">&times;</button>
        </div>
        <div class="rounded-lg overflow-hidden bg-gray-100 dark:bg-gray-700">
          <video class="w-full h-64 object-contain" autoplay loop muted controls controlslist="nodownload">
            <source src="./animations/${animationFile}" type="video/mp4">
          </video>
        </div>
      </div>`;
    document.body.appendChild(modal);
  }

  function showAppToast(message, type = 'info') {
    const tone = {
      info: 'from-blue-500 to-blue-600',
      success: 'from-green-500 to-emerald-600',
      warning: 'from-yellow-500 to-amber-600',
      error: 'from-red-500 to-rose-600'
    }[type] || 'from-blue-500 to-blue-600';
    const bar = document.createElement('div');
    bar.className = 'fixed top-4 left-1/2 -translate-x-1/2 z-50 px-4 py-3 rounded-xl shadow-lg text-white bg-gradient-to-r ' + tone;
    bar.style.cssText += 'backdrop-filter:blur(8px); opacity:0; transform:translate(-50%,-6px); transition:opacity 220ms ease, transform 220ms ease;';
    bar.setAttribute('role','status');
    bar.setAttribute('aria-live','polite');
    bar.innerHTML = `
      <div class="flex items-center gap-3">
        <span class="font-semibold text-sm">${message}</span>
      </div>
      <div class="mt-2 h-1 bg-white/25 rounded">
        <div class="h-1 bg-white/90 rounded" style="width:0%; transition:width 2400ms linear"></div>
      </div>`;
    document.body.appendChild(bar);
    // animate in
    requestAnimationFrame(() => { bar.style.opacity = '1'; bar.style.transform = 'translate(-50%,0)'; const prog = bar.querySelector('div > div'); if (prog) prog.style.width = '100%'; });
    // fade out and remove
    setTimeout(() => { bar.style.opacity = '0'; bar.style.transform = 'translate(-50%,-6px)'; }, 2500);
    setTimeout(() => { try { bar.remove(); } catch(_) {} }, 2800);
  }

  function startPlayerTimer(){
    clearInterval(timerInterval);
    isPaused = false;
    isResting = false;
    playerPause.innerHTML = '||';
    timerInterval = setInterval(()=>{
      if (isPaused) return;
      remainingSeconds--;
      if (remainingSeconds < 0) remainingSeconds = 0;
      playerTimer.textContent = formatTime(remainingSeconds);
      if (remainingSeconds === 0){
        clearInterval(timerInterval);
        speak('Good job. Moving to next exercise.');
        setTimeout(()=> playerNext(), 700);
      }
    }, 1000);
  }
  
  function startRestPeriod(){
    const workout = WORKOUTS[currentWorkoutIndex];
    const currentEx = workout.exercises[currentExerciseIndex];
    
    clearInterval(timerInterval);
    isResting = true;
    isPaused = false;
    remainingSeconds = currentEx.rest || 30;
    
    // Update UI for rest period
    playerTitle.textContent = 'Rest Time';
    playerSetInfo.textContent = `Next: Set ${currentSet + 1} of ${currentEx.sets || 1}`;
    playerTimer.textContent = formatTime(remainingSeconds);
    playerReps.textContent = 'Take a break';
    playerPause.innerHTML = '‚Üª';
    playerPause.title = 'Reset Rest Timer';
    
    // Keep showing the same exercise animation during rest between sets
    // Animation is already displayed from the previous set, so no need to update it
    // The animation continues playing which is good for user preview
    
    speak(`Rest for ${currentEx.rest} seconds.`);
    saveWorkoutState();
    
    timerInterval = setInterval(()=>{
      if (isPaused) return;
      remainingSeconds--;
      if (remainingSeconds < 0) remainingSeconds = 0;
      playerTimer.textContent = formatTime(remainingSeconds);
      if (remainingSeconds === 0){
        clearInterval(timerInterval);
        // Move to next set
        currentSet++;
        speak(`Set ${currentSet}. Begin!`);
        setTimeout(()=> {
          isResting = false;
          updatePlayerForExercise(currentExerciseIndex);
          const isRepBased = currentEx.reps && currentEx.reps > 0;
          if (!isRepBased) {
            startPlayerTimer();
          }
          saveWorkoutState();
        }, 700);
      }
    }, 1000);
  }

  function playerPauseToggle(){
    const workout = WORKOUTS[currentWorkoutIndex];
    const ex = workout ? workout.exercises[currentExerciseIndex] : null;
    if (!ex) return; // Exit if exercise is not found

    const isRepBased = ex.reps && ex.reps > 0;
    
    if (isResting) {
      // During rest period - reset rest timer
      if (playerTitle.textContent === 'Rest between exercises') {
        // Reset to 30 seconds for rest between exercises
        restTime = 30;
        playerTimer.textContent = formatTime(restTime);
        speak('Rest timer reset to 30 seconds.');
      } else {
        // Reset to exercise rest time for rest between sets
        const currentEx = workout.exercises[currentExerciseIndex];
        remainingSeconds = currentEx.rest || 30;
        playerTimer.textContent = formatTime(remainingSeconds);
        speak('Rest timer reset.');
      }
    } else if (isRepBased) {
      // Rep-based exercise - complete set and move to next
      const currentEx = workout.exercises[currentExerciseIndex];
      if (currentSet < (currentEx.sets || 1)) {
        speak('Set completed. Starting rest period.');
      } else {
        speak('Set completed. Moving to next exercise.');
      }
      setTimeout(()=> playerNext(), 700);
    } else {
      // Time-based exercise - pause/resume timer
      if (!timerInterval) return;
      if (isPaused){ 
        isPaused = false; 
        playerPause.innerHTML = '||'; 
        try{ speechSynthesis.resume(); }catch(e){} 
        saveWorkoutState();
      } else { 
        isPaused = true; 
        playerPause.innerHTML = '‚ñ∂'; 
        try{ speechSynthesis.pause(); }catch(e){} 
        saveWorkoutState();
      }
    }
  }

  function playerNext(){
    const workout = WORKOUTS[currentWorkoutIndex];
    
    // Finish workout if all exercises are done
    if (currentExerciseIndex >= workout.exercises.length) {
      playerFinish();
      return;
    }

    const currentEx = workout.exercises[currentExerciseIndex];
    
    // Prevent duplicate calls for the same exercise/set combination
    const currentState = `${currentExerciseIndex}-${currentSet}`;
    if (window.lastPlayerNextState === currentState) {
      console.log('Duplicate playerNext call prevented for:', currentState);
      return;
    }
    window.lastPlayerNextState = currentState;
    
    // Check if we need to do more sets of current exercise
    if (currentSet < (currentEx.sets || 1)) {
      // Start rest period before next set
      if (currentEx.rest > 0) {
        startRestPeriod();
      } else {
        // No rest, go directly to next set
        currentSet++;
        isResting = false;
        updatePlayerForExercise(currentExerciseIndex);
        const isRepBased = currentEx.reps && currentEx.reps > 0;
        if (!isRepBased) {
          startPlayerTimer();
        }
        saveWorkoutState();
      }
    } else {
      // Mark current exercise as completed before moving to next (ensure no duplicates)
      if (!completedExercises.includes(currentExerciseIndex)) {
        completedExercises.push(currentExerciseIndex);
        console.log(`Exercise ${currentExerciseIndex} completed. Total completed: ${completedExercises.length}/${sessionExercises.length}`);
        console.log(`Current completedExercises array:`, completedExercises); // CRITICAL: Debug logging
        saveWorkoutState();
      }
      
      // Move to next exercise
      currentSet = 1;
      currentExerciseIndex++;
      if (currentExerciseIndex >= workout.exercises.length){
        playerFinish();
        return;
      }
      
      // Save state after moving to next exercise
      saveWorkoutState();
      
      // Add rest period between different exercises (30 seconds)
      const nextEx = workout.exercises[currentExerciseIndex];
      if (nextEx) {
        // Start rest period before next exercise
        playerTitle.textContent = 'Rest between exercises';
        playerSetInfo.textContent = `Next: ${nextEx.title}`;
        playerReps.textContent = 'Get ready!';
        playerPause.innerHTML = '‚Üª'; // Set reset symbol for rest between exercises
        isResting = true;
        
        restTime = 30; // 30 seconds rest between exercises
        playerTimer.textContent = formatTime(restTime);
        
        // CRITICAL FIX: Show the upcoming exercise animation during rest period
        // This helps users mentally prepare for the next exercise
        const animationVideo = document.getElementById('player-animation');
        const animationLottie = document.getElementById('player-lottie');
        const animationFallback = document.getElementById('player-animation-fallback');
        
        if (nextEx.animation) {
          const isLottie = /\.json$/i.test(nextEx.animation);
          
          if (isLottie) {
            // Hide and reset video
            animationVideo.pause();
            animationVideo.removeAttribute('src');
            animationVideo.style.display = 'none';
            
            // Show lottie for upcoming exercise
            animationLottie.style.opacity = '0';
            animationLottie.style.display = 'block';
            animationFallback.style.display = 'none';
            animationLottie.setAttribute('src', `./animations/${nextEx.animation}`);
            
            const onLottieLoad = () => {
              animationLottie.removeEventListener('load', onLottieLoad);
              animationLottie.style.transition = 'opacity 250ms ease-in-out';
              animationLottie.style.opacity = '1';
            };
            animationLottie.addEventListener('load', onLottieLoad);
          } else {
            // Use MP4 video for upcoming exercise (prefetched)
            animationLottie.removeAttribute('src');
            animationLottie.style.display = 'none';
            animationFallback.style.display = 'none';
            setAnimationVideoSrcIfChanged(nextEx.animation);
          }
        } else {
          // No animation available: show fallback
          animationVideo.pause();
          animationVideo.removeAttribute('src');
          animationVideo.style.display = 'none';
          animationLottie.removeAttribute('src');
          animationLottie.style.display = 'none';
          animationFallback.style.display = 'block';
        }
        
        // Update info panel with upcoming exercise details
        updateInfoPanel(nextEx);
        
        timerInterval = setInterval(() => {
          if (!isPaused) {
            restTime--;
            playerTimer.textContent = formatTime(restTime);
            
            if (restTime <= 0) {
              clearInterval(timerInterval);
              isResting = false;
              currentSet = 1; // reset set count for new exercise
              updatePlayerForExercise(currentExerciseIndex);
              
              // Only start timer for time-based exercises
              const isRepBased = nextEx.reps && nextEx.reps > 0;
              if (!isRepBased) {
                startPlayerTimer();
              }
              saveWorkoutState();
            }
          }
        }, 1000);
      } else {
        isResting = false;
         updatePlayerForExercise(currentExerciseIndex);
         
         // Only start timer for time-based exercises
         const ex = workout.exercises[currentExerciseIndex];
         const isRepBased = ex.reps && ex.reps > 0;
         if (!isRepBased) {
           startPlayerTimer();
         }
       }
     }
   }

  async function playerFinish(){
    clearInterval(timerInterval);
    clearInterval(workoutTimer);
    
    // Mark final exercise as completed if not already marked (and it's a valid exercise index)
    if (currentExerciseIndex < sessionExercises.length && !completedExercises.includes(currentExerciseIndex)) {
      completedExercises.push(currentExerciseIndex);
    }
    
    // Remove any duplicate entries (safety check)
    completedExercises = [...new Set(completedExercises)];
    console.log(`Workout finished. Completed exercises: ${completedExercises.length}, Total exercises: ${sessionExercises.length}`);
    console.log('Completed exercise indices:', completedExercises);
    
    // Calculate workout metrics for health score integration
    const workoutData = {
      duration: Math.max(1, Math.round(workoutTotalTime / 60)), // Duration in minutes (min 1)
      exercisesCompleted: completedExercises.length,
      totalExercises: sessionExercises.length,
      completionRate: Math.min(100, (completedExercises.length / sessionExercises.length) * 100),
      timestamp: new Date().toISOString(),
      type: 'structured_workout',
      workoutTitle: WORKOUTS[currentWorkoutIndex].title,
      workoutLevel: WORKOUTS[currentWorkoutIndex].difficulty,
      exercises: sessionExercises
    };
    
    // CRITICAL FIX: Save workout data IMMEDIATELY to prevent overwriting
    // Log workout as activity minutes and save to history
    if (workoutData.duration > 0) {
      // Log activity minutes to daily intake (same as index.html)
      const dailyIntake = JSON.parse(localStorage.getItem('dailyIntake') || '{"calories": 0, "protein": 0, "carbs": 0, "fat": 0, "activity": 0, "water": 0}');
      dailyIntake.activity = (dailyIntake.activity || 0) + workoutData.duration; // activity in minutes
      localStorage.setItem('dailyIntake', JSON.stringify(dailyIntake));
      
      // Store workout history for detailed tracking
      const workoutHistory = JSON.parse(localStorage.getItem('workoutHistory') || '[]');
      workoutHistory.push(workoutData);
      // Keep only last 30 workouts
      if (workoutHistory.length > 30) workoutHistory.shift();
      localStorage.setItem('workoutHistory', JSON.stringify(workoutHistory));
      
      // CRITICAL FIX: Force immediate localStorage save to prevent data loss
      console.log('Workout data saved immediately:', workoutData);
      
      // Sync workout data to Supabase if user is logged in
      if (currentUser && supabase) {
        try {
          // Save to user's workout history
          const { error: workoutError } = await supabase
            .from('workout_history')
            .insert([{ user_id: currentUser.id, ...workoutData }], { returning: 'minimal' });
          
          if (workoutError) throw workoutError;
          
          // Update user's updated_at timestamp
          const { error: updateError } = await supabase
            .from('users')
            .update({ updated_at: new Date().toISOString() }, { returning: 'minimal' })
            .eq('id', currentUser.id);
          
          if (updateError) throw updateError;
          
          // Update user's daily intake using local value (avoid extra read)
          const localDaily = JSON.parse(localStorage.getItem('dailyIntake') || '{"calories":0,"protein":0,"carbs":0,"fat":0,"activity":0,"water":0}');
          const { error: updateDailyError } = await supabase
            .from('users')
            .update({ daily_intake: localDaily }, { returning: 'minimal' })
            .eq('id', currentUser.id);
          
          if (updateDailyError) throw updateDailyError;
        } catch (error) {
          console.error('Error syncing workout data to Supabase:', error);
        }
      }
    }
    
    // CRITICAL FIX: Delay the reset of workout session tracking to ensure data persistence
    // Reset workout session tracking AFTER all data operations are complete
    setTimeout(() => {
      workoutStartTime = null;
      workoutTotalTime = 0;
      completedExercises = [];
      sessionExercises = [];
      
      // Clear workout state since workout is completed
      clearWorkoutState();
      
      console.log('Workout session variables reset after data persistence');
    }, 100); // Small delay to ensure all localStorage operations complete
    
    // Update UI
    playerTitle.textContent = 'Workout complete';
    playerSetInfo.textContent = '';
    playerTimer.textContent = '00:00';
    playerReps.textContent = 'Well done!';
    playerProgressFill.style.width = '100%';
    
    const completionMessage = workoutData.completionRate === 100 
      ? `Workout completed! Great job! You completed all ${workoutData.totalExercises} exercises in ${workoutData.duration} minutes.`
      : `Workout session ended. You completed ${workoutData.exercisesCompleted} out of ${workoutData.totalExercises} exercises in ${workoutData.duration} minutes.`;
    
    speak(completionMessage);
    
    // Save completion
    localStorage.setItem('completedWorkoutIndex', currentWorkoutIndex.toString());
    
    // Return to the detail view (exercises list) instead of redirecting to index.html
    // This eliminates the white screen issue and allows users to start another workout
    showView('view-detail');
  }

  // player controls
  playerPause.addEventListener('click', playerPauseToggle);
  playerSkip.addEventListener('click', ()=> {
    clearInterval(timerInterval);
    if (isResting) {
      // Distinguish between rest types to avoid incorrect set increment
      const workout = WORKOUTS[currentWorkoutIndex];
      const currentEx = workout.exercises[currentExerciseIndex];
      if (playerTitle.textContent === 'Rest between exercises') {
        // Skip the rest between exercises: start next exercise at set 1
        speak('Skipping rest. Starting next exercise.');
        isResting = false;
        currentSet = 1; // ensure next exercise starts from set 1
        updatePlayerForExercise(currentExerciseIndex);
        const isRepBased = currentEx.reps && currentEx.reps > 0;
        if (!isRepBased) {
          startPlayerTimer();
        }
      } else {
        // Rest between sets within the same exercise
        if (currentSet < (currentEx.sets || 1)) {
          speak('Skipping rest. Starting next set.');
          currentSet++;
          isResting = false;
          updatePlayerForExercise(currentExerciseIndex);
          const isRepBased = currentEx.reps && currentEx.reps > 0;
          if (!isRepBased) {
            startPlayerTimer();
          }
        } else {
          speak('Skipping to next exercise');
          playerNext();
        }
      }
    } else {
      speak('Skipping to next exercise');
      playerNext();
    }
  });
  playerClose.addEventListener('click', async ()=> {
    clearInterval(timerInterval);
    clearInterval(workoutTimer);
    
    // Save partial workout data if user exits early
    if (workoutStartTime && workoutTotalTime > 0) {
      // Do NOT mark current exercise as completed on early exit; only fully finished exercises are counted
      // This avoids off-by-one (e.g., showing 4/6 when only 3 are done and the 4th hasn't started)
      // completedExercises remains unchanged here
      
      const workoutData = {
        duration: Math.round(workoutTotalTime / 60),
        exercisesCompleted: completedExercises.length,
        totalExercises: sessionExercises.length,
        completionRate: Math.min(100, (completedExercises.length / sessionExercises.length) * 100),
        timestamp: new Date().toISOString(),
        type: 'structured_workout',
        workoutTitle: WORKOUTS[currentWorkoutIndex].title,
        workoutLevel: WORKOUTS[currentWorkoutIndex].difficulty,
        exercises: sessionExercises,
        incomplete: true // Mark as incomplete workout
      };
      
      // Only save if workout had meaningful duration (at least 1 minute)
      if (workoutData.duration > 0) {
        // Log activity minutes to daily intake
        const dailyIntake = JSON.parse(localStorage.getItem('dailyIntake') || '{"calories": 0, "protein": 0, "carbs": 0, "fat": 0, "activity": 0, "water": 0}');
        dailyIntake.activity = (dailyIntake.activity || 0) + workoutData.duration;
        localStorage.setItem('dailyIntake', JSON.stringify(dailyIntake));
        
        // Store workout history
        const workoutHistory = JSON.parse(localStorage.getItem('workoutHistory') || '[]');
        workoutHistory.push(workoutData);
        if (workoutHistory.length > 30) workoutHistory.shift();
        localStorage.setItem('workoutHistory', JSON.stringify(workoutHistory));
        
        console.log('Early exit workout data saved:', workoutData); // CRITICAL: Debug logging
        
        // Sync to Supabase if user is logged in
        if (currentUser && supabase) {
          try {
            // Insert with incomplete flag directly; avoid select and follow-up update
            const { error: workoutError } = await supabase
              .from('workout_history')
              .insert([{ user_id: currentUser.id, ...workoutData }], { returning: 'minimal' });
            if (workoutError) throw workoutError;
            
            // Update user's updated_at timestamp
            const { error: updateError } = await supabase
              .from('users')
              .update({ updated_at: new Date().toISOString() }, { returning: 'minimal' })
              .eq('id', currentUser.id);
            
            if (updateError) throw updateError;
            
            // Update user's daily intake using local value (avoid extra read)
            const localDaily = JSON.parse(localStorage.getItem('dailyIntake') || '{"calories":0,"protein":0,"carbs":0,"fat":0,"activity":0,"water":0}');
            const { error: updateDailyError } = await supabase
              .from('users')
              .update({ daily_intake: localDaily }, { returning: 'minimal' })
              .eq('id', currentUser.id);
            
            if (updateDailyError) throw updateDailyError;
          } catch (error) {
            console.error('Error syncing partial workout data to Supabase:', error);
          }
        }
      }
    }
    
    // CRITICAL FIX: Reset workout session tracking AFTER all data operations are complete
    // This prevents premature clearing that could cause data loss
    setTimeout(() => {
      workoutStartTime = null;
      workoutTotalTime = 0;
      completedExercises = [];
      sessionExercises = [];
      
      // Ensure no resume on refresh or navigation after manual exit
      clearWorkoutState();
      
      console.log('Early exit: Workout session variables reset after data persistence');
    }, 100); // Small delay to ensure all localStorage operations complete
    
    try{ speechSynthesis.cancel(); }catch(e){}
    // Return to the workouts list to avoid resuming incomplete sessions
    showView('view-list');
  });
  // Voice mute/unmute toggle
  playerVoice.addEventListener('click', ()=> {
    voiceEnabled = !voiceEnabled;
    updateVoiceButtonUI();
    if (!voiceEnabled) {
      try{ speechSynthesis.cancel(); }catch(e){}
    }
  });
  
  // Voice gender toggle
  playerVoiceGender.addEventListener('click', ()=> {
    voiceGender = voiceGender === 'female' ? 'male' : 'female';
    updateVoiceGenderUI();
  });
  
  function updateVoiceButtonUI() {
    if (voiceEnabled) {
      playerVoice.className = 'p-2 rounded-lg transition-colors bg-green-100 dark:bg-green-900 text-green-700 dark:text-green-300';
      playerVoiceIcon.innerHTML = '<path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z"/>';
      playerVoice.title = 'Mute voice';
    } else {
      playerVoice.className = 'p-2 rounded-lg transition-colors bg-red-100 dark:bg-red-900 text-red-700 dark:text-red-300';
      playerVoiceIcon.innerHTML = '<path d="M16.5 12c0-1.77-1.02-3.29-2.5-4.03v2.21l2.45 2.45c.03-.2.05-.41.05-.63zm2.5 0c0 .94-.2 1.82-.54 2.64l1.51 1.51C20.63 14.91 21 13.5 21 12c0-4.28-2.99-7.86-7-8.77v2.06c2.89.86 5 3.54 5 6.71zM4.27 3L3 4.27 7.73 9H3v6h4l5 5v-6.73l4.25 4.25c-.67.52-1.42.93-2.25 1.18v2.06c1.38-.31 2.63-.95 3.69-1.81L19.73 21 21 19.73l-9-9L4.27 3zM12 4L9.91 6.09 12 8.18V4z"/>';
      playerVoice.title = 'Unmute voice';
    }
  }
  
  function updateVoiceGenderUI() {
    voiceGenderText.textContent = voiceGender === 'female' ? '‚ôÄ' : '‚ôÇ';
    playerVoiceGender.title = `Switch to ${voiceGender === 'female' ? 'male' : 'female'} voice`;
  }
  
  // Initialize UI
  updateVoiceButtonUI();
  updateVoiceGenderUI();

  function speak(text){
    if (!voiceEnabled) return;
    if (!text) return;

    console.log('üé§ Attempting to speak:', text);

    // Check if AndroidTTS bridge is available (for WebView)
    if (typeof window.AndroidTTS !== 'undefined' && window.AndroidTTS.speak) {
      console.log('üì¢ Using AndroidTTS bridge');
      try {
        window.AndroidTTS.speak(text, 1.0, 1.0);
        return;
      } catch (e) {
        console.error('AndroidTTS error:', e);
      }
    }

    // Fallback to browser speechSynthesis
    if ('speechSynthesis' in window) {
      console.log('üì¢ Using browser speechSynthesis');
      const u = new SpeechSynthesisUtterance(text);
      const voices = speechSynthesis.getVoices();

      if (voices && voices.length) {
        let selectedVoice = null;

        if (voiceGender === 'female') {
          selectedVoice = voices.find(voice =>
            voice.name.toLowerCase().includes('female') ||
            voice.name.toLowerCase().includes('samantha')
          );
        } else {
          selectedVoice = voices.find(voice =>
            voice.name.toLowerCase().includes('male') ||
            voice.name.toLowerCase().includes('david')
          );
        }

        u.voice = selectedVoice || voices[0];
      }

      u.rate = 1;
      try { speechSynthesis.cancel(); } catch(e) {}
      speechSynthesis.speak(u);
    } else {
      console.error('‚ùå No TTS method available');
    }
  }

  // keyboard support
  window.addEventListener('keydown', (e)=> {
    // global shortcuts only when player visible
    if (!viewPlayer.classList.contains('active-view')) return;
    if (e.key === ' ') { e.preventDefault(); playerPause.click(); }
    if (e.key === 'ArrowRight') { e.preventDefault(); playerSkip.click(); }
    if (e.key === 'Escape') { e.preventDefault(); playerClose.click(); }
  });

  // small helpers
  function formatTimeShort(s){ return `${Math.floor(s/60)}:${(s%60).toString().padStart(2,'0')}`; }

  // Initial render
  renderWorkouts();

  // Restore workout state on page load
  restoreWorkoutState();

  // preload voices (some browsers require gesture)
  if ('speechSynthesis' in window) { speechSynthesis.getVoices(); speechSynthesis.onvoiceschanged = () => speechSynthesis.getVoices(); }

  </script>
  <script>
    // Register service worker (safe, idempotent). Remove duplicate registrations if already present
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('/sw.js')
          .then(reg => console.log('ServiceWorker registered:', reg.scope))
          .catch(err => console.warn('ServiceWorker registration failed:', err));
      });
    }
  </script>
</body>
</html>
